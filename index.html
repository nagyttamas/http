<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Árajánlat Készítő</title>

    <!-- WebKit/iOS Home Screen Ikon és Beállítások -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Árajánlat">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/009688/FFFFFF?text=AK&font=inter">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* --- Beágyazott Google Fonts: Inter --- */
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 400;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 600;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 700;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        
        /* --- Alkalmazás Stílusok --- */
        :root {
            --primary-color: #009688; 
            --primary-dark: #00796B;
            --secondary-color: #00BCD4;
            --secondary-dark: #0097A7;
            --accent-color: #F59E0B;
            
            /* Világos mód színei */
            --background-color: #F3F4F6;
            --text-color: #1F2937;
            --light-text-color: #6B7280;
            --surface-color: #FFFFFF;
            --input-bg-color: #F9FAFB;
            --input-border-color: #D1D5DB;
            --table-header-bg: #E5E7EB;
            --table-row-border: #E5E7EB;
            --hover-bg-color: #E5E7EB;
        }

        body.dark {
            /* Sötét mód színei */
            --background-color: #111827;
            --text-color: #F9FAFB;
            --light-text-color: #9CA3AF;
            --surface-color: #1F2937;
            --input-bg-color: #374151;
            --input-border-color: #4B5563;
            --table-header-bg: #374151;
            --table-row-border: #4B5563;
            --hover-bg-color: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1024px;
            background-color: var(--surface-color);
            transition: background-color 0.3s;
        }

        /* Tabs styling - iOS Glass Effect */
        .tab-button {
            -webkit-appearance: none;
            border: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 12px;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            background-color: rgba(148, 163, 184, 0.1); /* Subtle, glassy background */
            color: var(--light-text-color);
            flex-shrink: 0;
        }
        body.dark .tab-button:not(.active-style) {
            background-color: rgba(71, 85, 105, 0.2);
        }
        .tab-button:not(.active-style):hover {
            background-color: rgba(148, 163, 184, 0.2);
        }
        body.dark .tab-button:not(.active-style):hover {
            background-color: rgba(71, 85, 105, 0.4);
        }
        .tab-button:focus-visible { /* A11y focus state */
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.4);
        }
        .tab-button.active-style {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
        }
        .tab-button.active-style:hover {
            background-color: var(--primary-dark);
        }
        
        .tab-button .icon {
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }
        
        .tab-button:not(.active-style) .icon {
             color: var(--light-text-color);
        }

        .tab-button.active-style .icon {
            color: white;
        }

        /* Input and select styling */
        .input-field {
            -webkit-appearance: none; /* iOS style reset */
            appearance: none;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.2);
        }
        .input-field::placeholder {
            color: var(--light-text-color);
        }

        select.input-field {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Make space for the arrow */
        }

        /* Specific overrides for the small header selects to fix iOS sizing issue */
        #language-select, #currency-select {
            width: auto;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }


        /* Button styling - iOS Inspired */
        .btn {
            -webkit-appearance: none; /* iOS style reset */
            font-weight: 600;
            padding: 0.9rem 1.75rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            transform: scale(1);
            border: 1px solid transparent;
            cursor: pointer;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(50%);
        }
        .btn:active {
            transform: scale(0.97);
            box-shadow: none;
            filter: brightness(0.95);
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { 
            background-color: var(--hover-bg-color); 
            color: var(--text-color);
            border-color: var(--input-border-color);
        }
        body.dark .btn-secondary {
            background-color: var(--input-bg-color);
        }
        .btn-secondary:hover { 
            background-color: var(--input-border-color);
        }
        .btn-tertiary { background-color: var(--accent-color); color: white; border-color: transparent; }
        .btn-tertiary:hover { background-color: #D97706; }
        .btn-danger { background-color: #EF4444; color: white; border-color: transparent;}
        .btn-danger:hover { background-color: #DC2626; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 8px; }
        
        .btn-icon {
             -webkit-appearance: none;
             padding: 0;
             width: 2.5rem; /* 40px */
             height: 2.5rem; /* 40px */
             display: inline-flex;
             align-items: center;
             justify-content: center;
             border-radius: 9999px; /* Circular */
             font-size: 1rem;
        }


        .tab-content { display: none; animation: fadeIn 0.5s; background-color: var(--background-color); }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-with-unit { display: flex; align-items: center; }
        .input-with-unit .input-field { border-radius: 12px 0 0 12px; }
        .input-with-unit .unit {
            background-color: var(--hover-bg-color); color: var(--light-text-color); padding: 0.75rem 1rem;
            border-radius: 0 12px 12px 0; border: 1px solid var(--input-border-color); border-left: none;
        }
        
        .table-header {
            background-color: var(--table-header-bg);
            color: var(--text-color);
        }

        #quote-items-body {
            border-color: var(--table-row-border);
        }

        #load-quote-section {
            background-color: var(--background-color);
        }

        .saved-quote-item {
            background-color: var(--surface-color);
        }
        .saved-quote-item.animated {
            animation: slideInListItem 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(30px);
        }

        @keyframes slideInListItem {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 12px;
            color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0; transform: translateX(100%);
            animation: slideInToast 0.5s forwards, fadeOutToast 0.5s 4.5s forwards;
            min-width: 250px;
        }
        .toast-success { background-color: var(--primary-color); }
        .toast-error { background-color: #EF4444; }
        .toast-info { background-color: var(--secondary-color); }
        .toast .icon { margin-right: 0.75rem; font-size: 1.5rem; }
        @keyframes slideInToast { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }

        /* Modal styling with Backdrop Blur */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.35);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--surface-color); padding: 2rem; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%; max-width: 400px;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        /* --- Eszköz-specifikus rács elrendezések --- */
        .form-grid {
            display: grid;
            gap: 1.5rem; /* Tailwind's gap-6 */
            grid-template-columns: 1fr; /* Alapértelmezett: Mobil (1 oszlop) */
        }

        /* Tablet / iPad (álló) és nagyobb tabletek (768px-től) */
        @media (min-width: 768px) {
            .form-grid {
                gap: 1.75rem; /* Increased gap for tablets */
            }
            #blinds-content .form-grid { grid-template-columns: repeat(3, 1fr); }
            #screens-content .form-grid { grid-template-columns: repeat(2, 1fr); }
            #settings-content .form-grid { grid-template-columns: repeat(2, 1fr); }
            #quote-content .form-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* PC / iPad (fekvő) és nagyobb képernyők (1024px-től) */
        @media (min-width: 1024px) {
            #blinds-content .form-grid { grid-template-columns: repeat(4, 1fr); }
            #screens-content .form-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* --- Reszponzív beállítások tabletekre (iPad) és nagyobb képenyőkre --- */
        @media (min-width: 768px) {
            #app-title {
                font-size: 2rem;
            }
            .tab-button {
                padding: 0.75rem 1.25rem;
                font-size: 1rem;
            }
            .input-group label {
                font-size: 0.9rem;
                margin-bottom: 0.4rem;
            }
            .input-field {
                padding: 0.9rem;
                font-size: 1rem;
            }
            .btn:not(.btn-icon) { /* Apply to all buttons except icon-only */
                padding: 1.1rem 2.2rem;
                font-size: 0.9rem;
            }
            .btn-small {
                 padding: 0.6rem 1.2rem;
                 font-size: 0.8rem;
            }
            #quote-items-body td, thead th {
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
                font-size: 0.95rem;
            }
            .quote-summary {
                font-size: 1.2rem;
            }
            .quote-summary #discount-percentage {
                 padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-6 lg:p-8">
    <div id="toast-container"></div>
    
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Megerősítés</h3>
            <p id="modal-text" class="mb-6 text-gray-600">Biztosan folytatja?</p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm-btn" class="btn btn-danger">Törlés</button>
                <button id="modal-cancel-btn" class="btn btn-secondary">Mégse</button>
            </div>
        </div>
    </div>

    <div id="pin-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="pin-modal-title" class="text-xl font-bold mb-4">PIN kód szükséges</h3>
            <p id="pin-modal-text" class="mb-4 text-gray-600">Kérjük, adja meg a PIN kódot az árak megtekintéséhez.</p>
            <input type="password" id="pin-input" class="input-field text-center mb-4" placeholder="****" inputmode="numeric">
            <p id="pin-error" class="text-red-500 text-sm mb-4 hidden">Helytelen PIN kód!</p>
            <div class="flex justify-center space-x-4">
                <button id="pin-submit-btn" class="btn btn-primary">Belépés</button>
                <button id="pin-cancel-btn" class="btn btn-secondary">Mégse</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-10 rounded-3xl shadow-2xl">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-y-4">
            <div class="flex items-center space-x-4 min-w-0">
                <img id="header-logo" src="" alt="Cég logója" class="h-16 w-auto hidden object-contain">
                <h1 id="app-title" class="text-3xl font-bold truncate">Árajánlat Készítő</h1>
            </div>
            <div class="flex items-center justify-end flex-wrap gap-x-4 gap-y-2 flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <label id="language-label" class="text-sm font-medium text-light-text-color flex-shrink-0">Nyelv:</label>
                    <select id="language-select" class="input-field py-1 px-2 text-sm w-auto">
                        <option value="hu">Magyar</option>
                        <option value="ro">Română</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label id="currency-label" class="text-sm font-medium text-light-text-color flex-shrink-0">Pénznem:</label>
                    <select id="currency-select" class="input-field py-1 px-2 text-sm w-auto">
                        <option value="RON">RON</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                 <!-- Auth UI Container -->
                <div id="auth-container" class="flex items-center gap-3">
                    <button id="login-btn" class="btn btn-primary btn-small flex items-center gap-2">
                        <i class="fa-brands fa-google"></i>
                        <span id="login-btn-text">Bejelentkezés</span>
                    </button>
                    <div id="user-info" class="hidden items-center gap-2">
                        <img id="user-photo" class="w-8 h-8 rounded-full" src="" alt="User photo">
                        <span id="user-name" class="text-sm font-semibold hidden sm:inline"></span>
                        <button id="logout-btn" class="btn btn-secondary btn-icon" title="Kijelentkezés">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--hover-bg-color)] transition-colors" aria-label="Téma váltása">
                    <i id="theme-icon" class="fa-solid fa-moon text-xl text-light-text-color"></i>
                </button>
            </div>
        </div>
        
        <div class="flex justify-center md:justify-start gap-3 mb-6 overflow-x-auto pb-2">
            <button id="blinds-tab" class="tab-button active-style flex items-center space-x-2"><i class="fa-solid fa-window-maximize icon"></i><span>Redőnyök</span></button>
            <button id="screens-tab" class="tab-button flex items-center space-x-2"><i class="fa-solid fa-grip-lines-vertical icon"></i><span>Szúnyoghálók</span></button>
            <button id="quote-tab" class="tab-button flex items-center space-x-2"><i class="fa-solid fa-file-invoice icon"></i><span>Ajánlat</span></button>
            <button id="prices-tab" class="tab-button flex items-center space-x-2"><i class="fa-solid fa-tags icon"></i><span>Árak</span></button>
            <button id="settings-tab" class="tab-button flex items-center space-x-2"><i class="fa-solid fa-cog icon"></i><span>Beállítások</span></button>
        </div>

        <div id="tab-content-container">
            <div id="blinds-content" class="tab-content active p-4 md:p-6 rounded-2xl shadow-inner">
                 <h2 id="blinds-heading" class="text-2xl font-bold mb-4">Redőny hozzáadása</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label id="blinds-width-label">Szélesség (mm):</label>
                        <input type="number" id="blinds-width" class="input-field" placeholder="1000" min="0">
                    </div>
                    <div class="input-group">
                        <label id="blinds-height-label">Magasság (mm):</label>
                        <input type="number" id="blinds-height" class="input-field" placeholder="1500" min="0">
                    </div>
                    <div class="input-group">
                        <label id="blinds-quantity-label">Darab:</label>
                        <input type="number" id="blinds-quantity" class="input-field" value="1" min="1">
                    </div>
                    <div class="input-group">
                        <label id="blinds-type-label">Típus:</label>
                        <select id="blinds-type" class="input-field">
                            <option value="pvc">PVC</option>
                            <option value="aluminium">Alumínium</option>
                            <option value="external-aluminium">Külső tokos alumínium</option>
                        </select>
                    </div>
                    <div class="input-group" id="blinds-color-group">
                        <label id="blinds-color-label">Szín:</label>
                        <select id="blinds-color" class="input-field"></select>
                    </div>
                    <div class="input-group">
                        <label id="blinds-control-label">Vezérlés:</label>
                        <select id="blinds-control" class="input-field">
                            <option value="string">Zsinóros</option>
                            <option value="motorized">Motoros</option>
                        </select>
                    </div>
                    <div class="input-group flex items-center mt-6">
                        <input type="checkbox" id="blinds-divided" class="mr-2 h-6 w-6 rounded-lg text-primary-color focus:ring-0">
                        <label id="blinds-divided-label" for="blinds-divided" class="input-label mb-0 cursor-pointer">Kettéosztott</label>
                    </div>
                     <div id="integrated-screen-group" class="input-group mt-1">
                        <label id="blinds-integrated-screen-label" for="blinds-integrated-screen">Beépített szúnyogháló</label>
                        <select id="blinds-integrated-screen" class="input-field">
                            <option value="none">Nincs</option>
                            <option value="full">Teljes</option>
                            <option value="half">Fele</option>
                        </select>
                    </div>
                    <div id="blinds-division-details" class="hidden col-span-1 md:col-span-2 lg:col-span-4 grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
                        <div class="input-group">
                            <label id="blinds-division-side-label">Osztás oldala:</label>
                            <select id="blinds-division-side" class="input-field">
                                <option value="right">Jobb</option>
                                <option value="left">Bal</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label id="blinds-division-width-label">Mező szélessége (mm):</label>
                            <input type="number" id="blinds-division-width" class="input-field" placeholder="500" min="0">
                        </div>
                    </div>
                </div>
                <div id="add-blind-buttons-container" class="w-full mt-6 flex gap-4">
                    <button id="add-blind-btn" class="flex-grow btn btn-primary">Redőny Hozzáadása</button>
                    <button id="cancel-edit-blind-btn" class="hidden btn btn-secondary">Mégse</button>
                </div>
                <div id="blinds-summary-container" class="mt-8 pt-6 border-t border-[var(--input-border-color)]"></div>
            </div>
            <div id="screens-content" class="tab-content p-4 md:p-6 rounded-2xl shadow-inner">
                <h2 id="screens-heading" class="text-2xl font-bold mb-4">Szúnyogháló hozzáadása</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label id="screens-width-label">Szélesség (mm):</label>
                        <input type="number" id="screens-width" class="input-field" placeholder="1000" min="0">
                    </div>
                    <div class="input-group">
                        <label id="screens-height-label">Magasság (mm):</label>
                        <input type="number" id="screens-height" class="input-field" placeholder="1500" min="0">
                    </div>
                    <div class="input-group">
                        <label id="screens-quantity-label">Darab:</label>
                        <input type="number" id="screens-quantity" class="input-field" value="1" min="1">
                    </div>
                    <div class="input-group">
                        <label id="screens-type-label">Típus:</label>
                        <select id="screens-type" class="input-field">
                            <option value="fix">Fix háló</option>
                            <option value="balcony">Balamas háló</option>
                            <option value="mobile">Mobil háló</option>
                            <option value="plisse">Plissé háló</option>
                            <option value="door">Ajtó háló</option>
                            <option value="thin-door">Vékony ajtó háló</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label id="screens-color-label">Szín:</label>
                        <select id="screens-color" class="input-field"></select>
                    </div>
                    <div id="extender-frame-group" class="input-group flex items-center mt-2 hidden">
                        <input type="checkbox" id="screens-extender-frame" class="mr-2 h-6 w-6 rounded-lg text-primary-color focus:ring-0">
                        <label id="screens-extender-frame-label" for="screens-extender-frame" class="input-label mb-0 cursor-pointer">Kiemelő keret</label>
                    </div>
                </div>
                <div id="add-screen-buttons-container" class="w-full mt-6 flex gap-4">
                    <button id="add-screen-btn" class="flex-grow btn btn-primary">Szúnyogháló Hozzáadása</button>
                    <button id="cancel-edit-screen-btn" class="hidden btn btn-secondary">Mégse</button>
                </div>
                <div id="screens-summary-container" class="mt-8 pt-6 border-t border-[var(--input-border-color)]"></div>
            </div>
            <div id="quote-content" class="tab-content p-4 md:p-6 rounded-2xl shadow-inner">
                <h2 id="quote-heading" class="text-2xl font-bold mb-4">Ajánlat</h2>
                
                <div class="form-grid mb-6">
                     <div class="input-group">
                        <label id="quote-name-label" for="quote-name">Ajánlat neve:</label>
                        <input type="text" id="quote-name" class="input-field" placeholder="Pl. Lakásfelújítási projekt">
                    </div>
                     <div class="input-group">
                        <label id="client-name-label" for="client-name">Ügyfél neve:</label>
                        <input type="text" id="client-name" class="input-field" placeholder="Pl. Minta János">
                    </div>
                     <div class="input-group">
                        <label id="client-address-label" for="client-address">Ügyfél címe:</label>
                        <input type="text" id="client-address" class="input-field" placeholder="Pl. 1234 Minta, Fő utca 5.">
                    </div>
                     <div class="input-group">
                        <label id="client-phone-label" for="client-phone">Ügyfél telefonszáma:</label>
                        <input type="tel" id="client-phone" class="input-field" placeholder="Pl. +36 30 123 4567">
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full whitespace-nowrap table-auto">
                        <thead>
                            <tr class="text-left font-semibold table-header">
                                <th id="table-product-th" class="px-4 py-2">Termék</th>
                                <th id="table-size-th" class="px-4 py-2">Méret (mm)</th>
                                <th id="table-area-th" class="px-4 py-2">m²</th>
                                <th id="table-quantity-th" class="px-4 py-2">Darab</th>
                                <th id="table-price-th" class="px-4 py-2">Egységár</th>
                                <th id="table-subtotal-th" class="px-4 py-2">Részösszeg</th>
                                <th id="table-actions-th" class="px-4 py-2 text-right">Műveletek</th>
                            </tr>
                        </thead>
                        <tbody id="quote-items-body" class="divide-y"></tbody>
                    </table>
                </div>
                <div class="mt-6 border-t-2 pt-4 space-y-2 text-xl font-bold quote-summary">
                    <div class="flex justify-between items-center">
                        <span id="subtotal-text">Részösszeg:</span>
                        <span id="subtotal-price">0.00 RON</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <label id="discount-label" for="discount-percentage" class="text-base font-medium">Kedvezmény (%):</label>
                        <input type="number" id="discount-percentage" class="input-field w-24 text-right py-1" value="0" min="0" max="100">
                    </div>
                    <div id="discount-row" class="hidden flex justify-between items-center text-red-500">
                        <span id="discount-amount-text">Kedvezmény:</span>
                        <span id="discount-amount">-0.00 RON</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-2 mt-2">
                        <span id="total-text">Végösszeg:</span>
                        <span id="total-price">0.00 RON</span>
                    </div>
                </div>
                <div class="mt-8 flex flex-wrap gap-3 justify-end">
                     <button id="save-quote-btn" class="btn btn-secondary flex-grow sm:flex-grow-0"></button>
                     <button id="load-quotes-btn" class="btn btn-tertiary flex-grow sm:flex-grow-0"></button>
                     <button id="preview-quote-btn" class="btn btn-primary flex-grow sm:flex-grow-0"></button>
                </div>
                 <div id="load-quote-section" class="mt-6 p-4 rounded-2xl shadow-md hidden transition-all duration-300">
                    <h3 id="load-quote-heading" class="text-xl font-bold mb-4">Mentett ajánlatok</h3>
                    <div id="login-prompt" class="hidden text-center p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <p id="login-prompt-text">Jelentkezzen be a mentett ajánlatok megtekintéséhez és kezeléséhez.</p>
                    </div>
                    <div class="relative mb-4">
                        <input type="search" id="quote-search-input" class="input-field pl-10" placeholder="Keresés név vagy ügyfél alapján...">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <ul id="saved-quotes-list" class="space-y-2 max-h-80 overflow-y-auto"></ul>
                </div>
            </div>
            <div id="prices-content" class="tab-content p-4 md:p-6 rounded-2xl shadow-inner">
                 <h2 id="prices-heading" class="text-2xl font-bold mb-4">Árbeállítások</h2>
                 <div id="prices-container" class="space-y-6"></div>
            </div>
            <div id="settings-content" class="tab-content p-4 md:p-6 rounded-2xl shadow-inner">
                <h2 id="settings-heading" class="text-2xl font-bold mb-4">Beállítások</h2>
                <div id="settings-login-prompt" class="hidden text-center p-4 mb-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <p id="settings-login-prompt-text">Jelentkezzen be a beállítások mentéséhez és szinkronizálásához.</p>
                </div>
                <div class="form-grid">
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold">Cég adatai</h3>
                        <div class="input-group">
                            <label id="company-name-label" for="company-name">Cég neve:</label>
                            <input type="text" id="company-name" class="input-field" placeholder="Cég Kft.">
                        </div>
                        <div class="input-group">
                            <label id="company-website-label" for="company-website">Weboldal:</label>
                            <input type="text" id="company-website" class="input-field" placeholder="www.ceg-oldala.hu">
                        </div>
                         <div class="input-group">
                            <label id="company-email-label" for="company-email">Email cím:</label>
                            <input type="email" id="company-email" class="input-field" placeholder="info@ceg-oldala.hu">
                        </div>
                         <div class="input-group">
                            <label id="company-phone-label" for="company-phone">Telefonszám:</label>
                            <input type="tel" id="company-phone" class="input-field" placeholder="+36 30 123 4567">
                        </div>
                    </div>
                     <div class="space-y-6">
                        <h3 class="text-xl font-bold">Vizuális elemek</h3>
                         <div class="input-group">
                            <label id="company-logo-label">Cég logó:</label>
                            <input type="file" id="company-logo-input" class="hidden" accept="image/*">
                            <label for="company-logo-input" class="input-field cursor-pointer flex items-center justify-center border-dashed border-2 h-48">
                                <span id="logo-upload-text">Kattintson a logó feltöltéséhez</span>
                            </label>
                            <img id="logo-preview" src="" class="mt-4 h-24 w-auto hidden rounded-lg shadow-md object-contain" alt="Logó előnézet">
                            <button id="delete-logo-btn" class="btn btn-danger btn-small mt-2 hidden">Logó törlése</button>
                        </div>
                    </div>
                </div>

                <button id="save-settings-btn" class="w-full md:w-auto mt-8 btn btn-primary">Beállítások mentése</button>
                
                <div class="mt-8 pt-6 border-t border-[var(--input-border-color)]">
                    <h3 id="data-management-heading" class="text-xl font-bold mb-4">Adatkezelés</h3>
                    <div id="data-loss-warning" class="p-4 mb-4 rounded-lg bg-yellow-100 dark:bg-yellow-900 border border-yellow-300 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200 flex items-start gap-3">
                        <i class="fa-solid fa-triangle-exclamation mt-1"></i>
                        <p id="data-management-desc" class="text-sm">Az adatok mostantól a Firebase fiókjához vannak társítva és szinkronizálva. A helyi exportálás és importálás továbbra is elérhető biztonsági mentés céljából.</p>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <button id="export-data-btn" class="btn btn-secondary">Adatok Exportálása (Backup)</button>
                        <button id="import-data-btn" class="btn btn-tertiary">Adatok Importálása (Backup)</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json,application/json">
                    </div>
                </div>

            </div>
        </div>
    </div>

<script type="module">
  // Firebase SDK importok
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection, onSnapshot, query, orderBy, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

  // Firebase konfiguráció
  const firebaseConfig = {
    apiKey: "AIzaSyCRNOv3gLYn4Mlkfs2yss2sqTieWLbECqw",
    authDomain: "arajanlat-83ad3.firebaseapp.com",
    projectId: "arajanlat-83ad3",
    storageBucket: "arajanlat-83ad3.appspot.com",
    messagingSenderId: "794397912831",
    appId: "1:794397912831:web:784e9dc71f355cc72ea6ca",
    measurementId: "G-P8JML1W7YY"
  };

  // Firebase inicializálása
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);
  
  // --- EGYESÍTETT ALKALMAZÁS LOGIKA ---

    // --- DATA & STATE ---
    if (typeof crypto.randomUUID === 'undefined') {
        crypto.randomUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); });
    }

    const translations = {
        hu: {
            title: "Árajánlat Készítő", languageLabel: "Nyelv:", currencyLabel: "Pénznem:",
            blindsTab: "Redőnyök", screensTab: "Szúnyoghálók", pricesTab: "Árak", quoteTab: "Ajánlat", settingsTab: "Beállítások",
            blindsHeading: "Redőny hozzáadása", blindsTypeLabel: "Típus:", blindsWidthLabel: "Szélesség (mm):",
            blindsHeightLabel: "Magasság (mm):", blindsQuantityLabel: "Darab:", blindsColorLabel: "Szín:",
            blindsControlLabel: "Vezérlés:", blindsDividedLabel: "Kettéosztott",
            blindsIntegratedScreenLabel: "Beépített szúnyogháló", screenOptionNone: "Nincs", screenOptionFull: "Teljes",
            screenOptionHalf: "Fele", addBlindBtn: "Redőny Hozzáadása",
            screensHeading: "Szúnyogháló hozzáadása", screensTypeLabel: "Típus:", screensWidthLabel: "Szélesség (mm):",
            screensHeightLabel: "Magasság (mm):", screensQuantityLabel: "Darab:", screensColorLabel: "Szín:",
            addScreenBtn: "Szúnyogháló Hozzáadása", pricesHeading: "Árbeállítások", blindsPrices: "Redőny Árak",
            screensPrices: "Szúnyogháló Árak", basePricesM2: "Alapárak (ár / m²)", surcharges: "Felárak",
            colorSurcharges: "Színfelárak - Alumínium (%)", externalColorSurcharges: "Színfelárak - Külső tokos (%)",
            screenBasePricesM2: "Alapárak (ár / m²)", screenColorSurcharges: "Színfelárak (%)",
            unit_currency_pc: " / db", quoteHeading: "Ajánlat", settingsHeading: "Beállítások",
            companyNameLabel: "Cég neve:", companyLogoLabel: "Cég logó:", saveSettingsBtn: "Beállítások mentése",
            settingsSavedMessage: "A beállítások sikeresen elmentve a fiókjába!", tableProductTh: "Termék",
            tableSizeTh: "Méret (mm)", tableQuantityTh: "Darab", tablePriceTh: "Egységár",
            tableSubtotalTh: "Részösszeg", tableActionsTh: "Műveletek", subtotalText: "Részösszeg:",
            discountLabel: "Kedvezmény (%):", discountAmountText: "Kedvezmény:", totalText: "Végösszeg:",
            saveQuoteBtn: "Ajánlat mentése", loadQuotesBtn: "Mentett ajánlatok",
            quoteNameLabel: "Ajánlat neve:", loadQuoteHeading: "Mentett ajánlatok",
            deleteBtn: "Törlés", editBtn: "Szerkesztés", savePriceBtn: "Árak mentése", priceSavedMessage: "Árak sikeresen elmentve a fiókjába!",
            productAddedMessage: "A termék sikeresen hozzáadva az ajánlathoz!",
            productUpdatedMessage: "A tétel sikeresen módosítva!",
            emptyFieldsError: "Kérjük, töltse ki a kötelező mezőket!",
            invalidSizeError: "Kérjük, érvényes méreteket adjon meg (pozitív szám).",
            invalidQuantityError: "Kérjük, érvényes darabszámot adjon meg (pozitív egész szám).",
            invalidDivisionWidthError: "Az osztás szélessége nem lehet nagyobb, mint a teljes szélesség.",
            quoteSaved: "Ajánlat sikeresen elmentve a fiókjába!", 
            quoteLoaded: "Az ajánlat sikeresen betöltve!",
            quoteDeleted: "Az ajánlat sikeresen törölve a fiókjából!",
            quoteNameRequired: "Kérjük, adjon meg egy nevet az ajánlatnak!",
            noQuotesFound: "Nincsenek mentett ajánlatok.", noItemsInQuote: "Az ajánlat üres.",
            deleteQuotePromptTitle: "Ajánlat törlése",
            deleteQuotePromptText: "Biztosan törli a(z) '{{name}}' nevű ajánlatot?",
            minAreaWarning: "Figyelem: A minimális számlázott terület {{area}} m².",
            pvcColorError: "A PVC redőny csak fehér színben kapható.",
            logoUploadText: "Kattintson a logó feltöltéséhez",
            deleteLogoBtn: "Logó törlése",
            logoDeletedMessage: "A logó sikeresen törölve!",
            dataManagementHeading: "Adatkezelés",
            dataManagementDesc: "Az adatok mostantól a Firebase fiókjához vannak társítva és szinkronizálva. A helyi exportálás és importálás továbbra is elérhető biztonsági mentés céljából.",
            exportDataBtn: "Adatok Exportálása (Backup)",
            importDataBtn: "Adatok Importálása (Backup)",
            importSuccess: "Az adatok sikeresen importálva! Az oldal 2 másodperc múlva frissül.",
            importError: "Hiba az importálás során. Kérjük, ellenőrizze a fájl formátumát.",
            previewQuoteBtn: "Ajánlat Megtekintése",
            quotePreviewTitle: "Árajánlat Előnézet",
            generatePdfBtn: "PDF generálása",
            generateJpgBtn: "JPG generálása",
            sharePdfBtn: "PDF Megosztása",
            shareJpgBtn: "JPG Megosztása",
            sendQuoteBtn: "Email küldése",
            sendQuoteEmailBody: "Tisztelt Érdeklődő!\n\nCsatolva küldjük a(z) '{{quoteName}}' nevű árajánlatot.\n\nAz ajánlat végösszege: {{totalPrice}}\n\nAmennyiben kérdéése merülne fel, keressen bizalommal.\n\nÜdvözlettel,\n{{companyName}}",
            exchangeRateTitle: "EUR/RON Árfolyam",
            vatIncludedText: "Az ár tartalmazza az ÁFÁ-t.",
            quoteSummaryTitle: "Ajánlat Összegzés",
            summaryTotal: "Összesen",
            divisionSideLabel: "Osztás oldala", divisionWidthLabel: "Mező szélessége (mm)",
            sideLeft: "Bal", sideRight: "Jobb",
            companyWebsiteLabel: "Weboldal:", companyEmailLabel: "Email cím:", companyPhoneLabel: "Telefonszám:",
            clientNameLabel: "Ügyfél neve:", clientAddressLabel: "Ügyfél címe:", clientPhoneLabel: "Ügyfél telefonszáma:",
            tableAreaTh: "m²",
            updateItemBtn: "Tétel módosítása", cancelEditBtn: "Mégse",
            searchPlaceholder: "Keresés név vagy ügyfél alapján...",
            extenderFrameLabel: "Kiemelő keret", extenderFramePrice: "Kiemelő keret (ár / m)",
            pinModalTitle: "PIN kód szükséges",
            pinModalText: "Kérjük, adja meg a PIN kódot az árak megtekintéséhez.",
            pinSubmitBtn: "Belépés",
            pinError: "Helytelen PIN kód!",
            loginBtnText: "Bejelentkezés",
            logoutBtnTitle: "Kijelentkezés",
            loginToSaveText: "Jelentkezzen be a mentett ajánlatok megtekintéséhez és kezeléséhez.",
            settingsLoginPromptText: "Jelentkezzen be a beállítások mentéséhez és szinkronizálásához.",
            loggedInSuccess: "Sikeres bejelentkezés!",
            loggedOutSuccess: "Sikeres kijelentkezés!",
            unauthorizedDomainError: "Hiba: Ez a domain nincs engedélyezve a bejelentkezéshez. Kérjük, adja hozzá a domaint a Firebase Console > Authentication > Settings > Authorized domains listájához.",
            genericLoginError: "Bejelentkezési hiba történt.",
            productNames: { pvc: "PVC redőny", aluminium: "Alumínium redőny", "external-aluminium": "Külső tokos alumínium redőny", motorized: "Motor", automata: "Automata", divided: "Kettéosztott felár", divided_blind: "Redőny osztás", divided_external: "Külső tokos osztás", integrated_screen: "Beépített szúnyogháló (ár/m²)", integrated_screen_full: "Teljes szúnyogháló", integrated_screen_half: "Fél szúnyogháló", wood: "Fa imitáció", anthracite: "Antracit", special: "Speciális szín", fix: "Fix háló", balcony: "Balamas háló", mobile: "Mobil háló", plisse: "Plissé háló", door: "Ajtó háló", "thin-door": "Vékony ajtó háló", white: "Fehér", brown: "Barna", gray: "Szürke", dark_brown: "Sötétbarna", light_brown: "Világosbarna", golden_oak: "Aranytölgy", walnut: "Dió", mahogany: "Mahagóni", extender_frame: "Kiemelő keret" }
        },
        ro: {
            title: "Creator de Oferte", languageLabel: "Limbă:", currencyLabel: "Monedă:", blindsTab: "Jaluzele", screensTab: "Plase de insecte", pricesTab: "Prețuri", quoteTab: "Ofertă", settingsTab: "Setări", blindsHeading: "Adăugare jaluzea", blindsTypeLabel: "Tip:", blindsWidthLabel: "Lățime (mm):", blindsHeightLabel: "Înălțime (mm):", blindsQuantityLabel: "Bucăți:", blindsColorLabel: "Culoare:", blindsControlLabel: "Control:", blindsDividedLabel: "Divizat", blindsIntegratedScreenLabel: "Plasă de insecte integrată", screenOptionNone: "Niciuna", screenOptionFull: "Completă", screenOptionHalf: "Jumătate", addBlindBtn: "Adaugă Jaluzea", screensHeading: "Adăugare plasă de insecte", screensTypeLabel: "Tip:", screensWidthLabel: "Lățime (mm):", screensHeightLabel: "Înălțime (mm):", screensQuantityLabel: "Bucăți:", screensColorLabel: "Culoare:", addScreenBtn: "Adaugă Plasă", pricesHeading: "Setări Prețuri", blindsPrices: "Prețuri Jaluzele", screensPrices: "Prețuri Plase de Insecte", basePricesM2: "Prețuri de bază (preț / m²)", surcharges: "Suprataxe", colorSurcharges: "Suprataxe Culoare - Aluminiu (%)", externalColorSurcharges: "Suprataxe Culoare - Exterior (%)", screenBasePricesM2: "Prețuri de bază (preț / m²)", screenColorSurcharges: "Suprataxe Culoare (%)", unit_currency_pc: " / buc", quoteHeading: "Ofertă", settingsHeading: "Setări", companyNameLabel: "Nume Companie:", companyLogoLabel: "Logo Companie:", saveSettingsBtn: "Salvează Setările", settingsSavedMessage: "Setările au fost salvate cu succes în contul dvs.!", tableProductTh: "Produs", tableSizeTh: "Dimensiune (mm)", tableQuantityTh: "Bucăți", tablePriceTh: "Preț Unitar", tableSubtotalTh: "Subtotal", tableActionsTh: "Acțiuni", subtotalText: "Subtotal:", discountLabel: "Reducere (%):", discountAmountText: "Reducere:", totalText: "Total Final:", saveQuoteBtn: "Salvează Oferta", loadQuotesBtn: "Încarcă Oferte", quoteNameLabel: "Nume Ofertă:", loadQuoteHeading: "Oferte Salvate", deleteBtn: "Șterge", editBtn: "Editare", savePriceBtn: "Salvează Prețurile", priceSavedMessage: "Prețurile au fost salvate cu succes în contul dvs.!", productAddedMessage: "Produsul a fost adăugat cu succes la ofertă!", productUpdatedMessage: "Articolul a fost modificat cu succes!", emptyFieldsError: "Vă rugăm să completați câmpurile obligatorii!", invalidSizeError: "Vă rugăm să introduceți dimensiuni valide (număr pozitiv).", invalidQuantityError: "Vă rugăm să introduceți o cantitate validă (număr întreg pozitiv).", invalidDivisionWidthError: "Lățimea diviziunii nu poate fi mai mare decât lățimea totală.", quoteSaved: "Oferta a fost salvată în contul dvs.!", quoteLoaded: "Oferta a fost încărcată cu succes!", quoteDeleted: "Oferta a fost ștearsă cu succes din contul dvs.!", quoteNameRequired: "Vă rugăm să introduceți un nume pentru ofertă!", noQuotesFound: "Nicio ofertă salvată.", noItemsInQuote: "Oferta este goală.", deleteQuotePromptTitle: "Șterge Oferta", deleteQuotePromptText: "Sigur doriți să ștergeți oferta '{{name}}'?", minAreaWarning: "Atenție: Suprafața minimă facturată este de {{area}} m².", pvcColorError: "Jaluzelele din PVC sunt disponibile doar pe alb.", logoUploadText: "Faceți clic pentru a încărca logo-ul", deleteLogoBtn: "Șterge Logo", logoDeletedMessage: "Logo-ul a fost șters cu succes!",
            dataManagementHeading: "Gestionarea Datelor", dataManagementDesc: "Datele sunt acum asociate și sincronizate cu contul dvs. Firebase. Exportul și importul local sunt încă disponibile pentru backup.",
            exportDataBtn: "Export Date (Backup)", importDataBtn: "Import Date (Backup)", importSuccess: "Datele au fost importate cu succes! Pagina se va reîncărca în 2 secunde.",
            importError: "Eroare la import. Vă rugăm să verificați formatul fișierului.",
            previewQuoteBtn: "Vizualizare Ofertă", quotePreviewTitle: "Previzualizare Ofertă",
            generatePdfBtn: "Generează PDF",
            generateJpgBtn: "Generează JPG",
            sharePdfBtn: "Partajare PDF",
            shareJpgBtn: "Partajare JPG",
            sendQuoteBtn: "Trimite Email",
            sendQuoteEmailBody: "Stimate Domn/Doamnă,\n\nVă trimitem atașat oferta '{{quoteName}}'.\n\nValoarea totală a ofertei este: {{totalPrice}}\n\nDacă aveți întrebări, nu ezitați să ne contactați.\n\nCu respect,\n{{companyName}}",
            exchangeRateTitle: "Curs Valutar EUR/RON", vatIncludedText: "Prețul include TVA.", quoteSummaryTitle: "Rezumat Ofertă",
            summaryTotal: "Total", divisionSideLabel: "Partea divizată", divisionWidthLabel: "Lățime secțiune (mm)",
            sideLeft: "Stânga", sideRight: "Dreapta", companyWebsiteLabel: "Site web:", companyEmailLabel: "Email:", companyPhoneLabel: "Telefon:",
            clientNameLabel: "Nume Client:", clientAddressLabel: "Adresă Client:", clientPhoneLabel: "Telefon Client:",
            tableAreaTh: "m²", updateItemBtn: "Modifică Articol", cancelEditBtn: "Anulează",
            searchPlaceholder: "Căutare după nume sau client...",
            extenderFrameLabel: "Cadru de extensie", extenderFramePrice: "Cadru de extensie (preț / m)",
            pinModalTitle: "Cod PIN necesar",
            pinModalText: "Vă rugăm să introduceți codul PIN pentru a vizualiza prețurile.",
            pinSubmitBtn: "Intră",
            pinError: "Cod PIN incorect!",
            loginBtnText: "Autentificare",
            logoutBtnTitle: "Deconectare",
            loginToSaveText: "Autentificați-vă pentru a vedea și gestiona ofertele salvate.",
            settingsLoginPromptText: "Autentificați-vă pentru a salva și sincroniza setările.",
            loggedInSuccess: "Autentificare reușită!",
            loggedOutSuccess: "Deconectare reușită!",
            unauthorizedDomainError: "Eroare: Acest domeniu nu este autorizat pentru autentificare. Vă rugăm să adăugați domeniul în Firebase Console > Authentication > Settings > Authorized domains.",
            genericLoginError: "A apărut o eroare la autentificare.",
            productNames: { pvc: "Jaluzea PVC", aluminium: "Jaluzea Aluminiu", "external-aluminium": "Jaluzea exterioară din aluminiu", motorized: "Motor", automata: "Automat", divided: "Taxă divizare", divided_blind: "Divizare jaluzea", divided_external: "Divizare jaluzea exterioară", integrated_screen: "Plasă de insecte integrată (preț/m²)", integrated_screen_full: "Plasă de insecte completă", integrated_screen_half: "Jumătate de plasă de insecte", wood: "Imitație lemn", anthracite: "Antracit", special: "Culoare specială", fix: "Plasă fixă", balcony: "Plasă cu balamale", mobile: "Plasă mobilă", plisse: "Plasă plisse", door: "Plasă ușă", "thin-door": "Plasă subțire ușă", white: "Alb", brown: "Maro", gray: "Gri", dark_brown: "Maro închis", light_brown: "Maro deschis", golden_oak: "Stejar auriu", walnut: "Nuc", mahogany: "Mahon", extender_frame: "Cadru de extensie" }
        },
        en: {
            title: "Quote Generator", languageLabel: "Language:", currencyLabel: "Currency:", blindsTab: "Blinds", screensTab: "Insect Screens", pricesTab: "Prices", quoteTab: "Quote", settingsTab: "Settings", blindsHeading: "Add Blind", blindsTypeLabel: "Type:", blindsWidthLabel: "Width (mm):", blindsHeightLabel: "Height (mm):", blindsQuantityLabel: "Quantity:", blindsColorLabel: "Color:", blindsControlLabel: "Control:", blindsDividedLabel: "Divided", blindsIntegratedScreenLabel: "Integrated insect screen", screenOptionNone: "None", screenOptionFull: "Full", screenOptionHalf: "Half", addBlindBtn: "Add Blind", screensHeading: "Add Insect Screen", screensTypeLabel: "Type:", screensWidthLabel: "Width (mm):", screensHeightLabel: "Height (mm):", screensQuantityLabel: "Quantity:", screensColorLabel: "Color:", addScreenBtn: "Add Screen", pricesHeading: "Price Settings", blindsPrices: "Blinds Prices", screensPrices: "Insect Screen Prices", basePricesM2: "Base Prices (price / m²)", surcharges: "Surcharges", colorSurcharges: "Color Surcharges - Aluminium (%)", externalColorSurcharges: "Color Surcharges - External (%)", screenBasePricesM2: "Base Prices (price / m²)", screenColorSurcharges: "Color Surcharges (%)", unit_currency_pc: " / pc", quoteHeading: "Quote", settingsHeading: "Settings", companyNameLabel: "Company Name:", companyLogoLabel: "Company Logo:", saveSettingsBtn: "Save Settings", settingsSavedMessage: "Settings saved to your account successfully!", tableProductTh: "Product", tableSizeTh: "Size (mm)", tableQuantityTh: "Quantity", tablePriceTh: "Unit Price", tableSubtotalTh: "Subtotal", tableActionsTh: "Actions", subtotalText: "Subtotal:", discountLabel: "Discount (%):", discountAmountText: "Discount:", totalText: "Grand Total:", saveQuoteBtn: "Save Quote", loadQuotesBtn: "Load Quotes", quoteNameLabel: "Quote Name:", loadQuoteHeading: "Saved Quotes", deleteBtn: "Delete", editBtn: "Edit", savePriceBtn: "Save Prices", priceSavedMessage: "Prices saved to your account successfully!", productAddedMessage: "Product successfully added to the quote!", productUpdatedMessage: "Item successfully updated!", emptyFieldsError: "Please fill in the required fields!", invalidSizeError: "Please enter valid dimensions (positive number).", invalidQuantityError: "Please enter a valid quantity (positive integer).", invalidDivisionWidthError: "Division width cannot be greater than the total width.", quoteSaved: "Quote saved to your account!", quoteLoaded: "Quote loaded successfully!", quoteDeleted: "Quote deleted from your account successfully!", quoteNameRequired: "Please enter a name for the quote!", noQuotesFound: "No saved quotes.", noItemsInQuote: "The quote is empty.", deleteQuotePromptTitle: "Delete Quote", deleteQuotePromptText: "Are you sure you want to delete the quote '{{name}}'?", minAreaWarning: "Warning: The minimum billed area is {{area}} m².", pvcColorError: "PVC blinds are only available in white.", logoUploadText: "Click to upload logo", deleteLogoBtn: "Delete Logo", logoDeletedMessage: "Logo deleted successfully!",
            dataManagementHeading: "Data Management", dataManagementDesc: "Data is now associated and synced with your Firebase account. Local export and import are still available for backup purposes.",
            exportDataBtn: "Export Data (Backup)", importDataBtn: "Import Data (Backup)", importSuccess: "Data imported successfully! The page will reload in 2 seconds.",
            importError: "Error during import. Please check the file format.",
            previewQuoteBtn: "Preview Quote", quotePreviewTitle: "Quote Preview",
            generatePdfBtn: "Generate PDF",
            generateJpgBtn: "Generate JPG",
            sharePdfBtn: "Share PDF",
            shareJpgBtn: "Share JPG",
            sendQuoteBtn: "Send Email",
            sendQuoteEmailBody: "Dear Sir/Madam,\n\nPlease find the quote '{{quoteName}}' attached.\n\nThe total amount for the offer is: {{totalPrice}}\n\nIf you have any questions, please feel free to contact us.\n\nBest regards,\n{{companyName}}",
            exchangeRateTitle: "EUR/RON Exchange Rate", vatIncludedText: "The price includes VAT.", quoteSummaryTitle: "Quote Summary",
            summaryTotal: "Total", divisionSideLabel: "Division Side", divisionWidthLabel: "Section Width (mm)",
            sideLeft: "Left", sideRight: "Right", companyWebsiteLabel: "Website:", companyEmailLabel: "Email:", companyPhoneLabel: "Phone:",
            clientNameLabel: "Client Name:", clientAddressLabel: "Client Address:", clientPhoneLabel: "Client Phone:",
            tableAreaTh: "m²", updateItemBtn: "Update Item", cancelEditBtn: "Cancel",
            searchPlaceholder: "Search by name or client...",
            extenderFrameLabel: "Extender frame", extenderFramePrice: "Extender frame (price / m)",
            pinModalTitle: "PIN Code Required",
            pinModalText: "Please enter the PIN code to view prices.",
            pinSubmitBtn: "Enter",
            pinError: "Incorrect PIN code!",
            loginBtnText: "Login",
            logoutBtnTitle: "Logout",
            loginToSaveText: "Log in to view and manage your saved quotes.",
            settingsLoginPromptText: "Log in to save and sync your settings.",
            loggedInSuccess: "Login successful!",
            loggedOutSuccess: "Logout successful!",
            unauthorizedDomainError: "Error: This domain is not authorized for sign-in. Please add it to the authorized domains in your Firebase Console > Authentication > Settings > Authorized domains.",
            genericLoginError: "An error occurred during login.",
            productNames: { pvc: "PVC blind", aluminium: "Aluminium blind", "external-aluminium": "External aluminium blind", motorized: "Motor", automata: "Automatic", divided: "Divided surcharge", divided_blind: "Blind division", divided_external: "External blind division", integrated_screen: "Integrated insect screen (price/m²)", integrated_screen_full: "Full insect screen", integrated_screen_half: "Half insect screen", wood: "Wood imitation", anthracite: "Antracite", special: "Special color", fix: "Fix screen", balcony: "Hinged screen", mobile: "Mobile screen", plisse: "Plisse screen", door: "Door screen", "thin-door": "Thin door screen", white: "White", brown: "Brown", gray: "Gray", dark_brown: "Dark brown", light_brown: "Light brown", golden_oak: "Golden oak", walnut: "Walnut", mahogany: "Mahogany", extender_frame: "Extender frame" }
        }
    };

    const defaultPrices = {
        blinds: { pvc: 100, aluminium: 150, motorized: 150, divided: 50, integrated_screen: 70 },
        blinds_percentages: { wood: 15, anthracite: 10, special: 20 },
        blinds_extras: { automata: 25 },
        "external-aluminium": { base: 180, divided: 60 },
        external_aluminium_colors: { gray: 5, dark_brown: 5, light_brown: 5, golden_oak: 15, walnut: 15, mahogany: 15, special: 25 },
        screens: { fix: 50, balcony: 70, mobile: 80, plisse: 120, door: 100, "thin-door": 110, extender_frame_price_pm: 25 },
        screens_percentages: { wood: 25, anthracite: 20, special: 30 }
    };
    
    let userPrices = {}, allSavedQuotes = [];
    let quoteItems = [];
    let editingItemIndex = null;
    let currentLanguage = 'hu', currentCurrency = 'RON', exchangeRate = 5.0;
    let currentPrices = {};
    const minAreas = { blinds: 1.3, screens: 0.8, door_screen: 1.8, half_screen: 0.9 };
    let currentUser = null;
    let unsubscribeSettings = () => {}, unsubscribeQuotes = () => {};

    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    function showToast(message, type = 'success') {
        const container = $('#toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        const iconClass = type === 'success' ? 'fa-solid fa-check-circle' : (type === 'error' ? 'fa-solid fa-exclamation-triangle' : 'fa-solid fa-info-circle');
        toast.innerHTML = `<i class="${iconClass} icon"></i><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000); 
    }

    function showConfirmationModal(title, text) {
        return new Promise((resolve) => {
            const modal = $('#confirmation-modal');
            $('#modal-title').textContent = title;
            $('#modal-text').textContent = text;
            modal.classList.add('active');
            const confirmHandler = () => { modal.classList.remove('active'); cleanup(); resolve(true); };
            const cancelHandler = () => { modal.classList.remove('active'); cleanup(); resolve(false); };
            const cleanup = () => {
                $('#modal-confirm-btn').removeEventListener('click', confirmHandler);
                $('#modal-cancel-btn').removeEventListener('click', cancelHandler);
            };
            $('#modal-confirm-btn').addEventListener('click', confirmHandler);
            $('#modal-cancel-btn').addEventListener('click', cancelHandler);
        });
    }
    
    function deepMerge(target, ...sources) {
        if (!sources.length) return target;
        const source = sources.shift();
        if (source && typeof source === 'object' && !Array.isArray(source)) {
            for (const key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    if (!target[key]) Object.assign(target, { [key]: {} });
                    deepMerge(target[key], source[key]);
                } else {
                    Object.assign(target, { [key]: source[key] });
                }
            }
        }
        return deepMerge(target, ...sources);
    }
    
    function switchToTab(tabId) {
        $$('.tab-button').forEach(t => t.classList.remove('active-style'));
        $(`#${tabId}`).classList.add('active-style');
        $$('.tab-content').forEach(content => content.classList.remove('active'));
        $(`#${tabId.replace('-tab', '-content')}`).classList.add('active');
    }

    function applyTheme(theme) {
        const icon = $('#theme-icon');
        if (theme === 'dark') {
            document.body.classList.add('dark');
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        } else {
            document.body.classList.remove('dark');
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }
    }

    function toggleTheme() {
        const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    }

    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(systemPrefersDark ? 'dark' : 'light');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (!localStorage.getItem('theme')) {
                applyTheme(event.matches ? 'dark' : 'light');
            }
        });
    }

    function updateLocalization() {
            const t = translations[currentLanguage];
            if (!t) return; 

            document.title = t.title;
            const textContentMap = { 
                'app-title': 'title', 'language-label': 'languageLabel', 'currency-label': 'currencyLabel', 'blinds-heading': 'blindsHeading', 
                'blinds-width-label': 'blindsWidthLabel', 'blinds-height-label': 'blindsHeightLabel', 'blinds-quantity-label': 'blindsQuantityLabel', 
                'blinds-type-label': 'blindsTypeLabel', 'blinds-color-label': 'blindsColorLabel', 'blinds-control-label': 'blindsControlLabel', 
                'blinds-divided-label': 'blindsDividedLabel', 'blinds-integrated-screen-label': 'blindsIntegratedScreenLabel', 
                'screens-heading': 'screensHeading', 'screens-width-label': 'screensWidthLabel', 
                'screens-height-label': 'screensHeightLabel', 'screens-quantity-label': 'screensQuantityLabel', 'screens-type-label': 'screensTypeLabel', 
                'screens-color-label': 'screensColorLabel', 'prices-heading': 'pricesHeading', 'quote-heading': 'quoteHeading', 
                'table-product-th': 'tableProductTh', 'table-size-th': 'tableSizeTh', 'table-quantity-th': 'tableQuantityTh', 'table-price-th': 'tablePriceTh', 
                'table-subtotal-th': 'tableSubtotalTh', 'table-actions-th': 'tableActionsTh', 'subtotal-text': 'subtotalText', 
                'discount-label': 'discountLabel', 'discount-amount-text': 'discountAmountText', 'total-text': 'totalText', 
                'quote-name-label': 'quoteNameLabel', 'preview-quote-btn': 'previewQuoteBtn', 'load-quote-heading': 'loadQuoteHeading', 
                'settings-heading': 'settingsHeading', 'company-name-label': 'companyNameLabel', 'company-logo-label': 'companyLogoLabel', 
                'save-settings-btn': 'saveSettingsBtn', 'logo-upload-text': 'logoUploadText', 'delete-logo-btn': 'deleteLogoBtn', 
                'data-management-heading': 'dataManagementHeading', 'data-management-desc': 'dataManagementDesc', 'export-data-btn': 'exportDataBtn', 
                'import-data-btn': 'importDataBtn', 'blinds-division-side-label': 'divisionSideLabel', 'blinds-division-width-label': 'divisionWidthLabel',
                'company-website-label': 'companyWebsiteLabel', 'company-email-label': 'companyEmailLabel', 'company-phone-label': 'companyPhoneLabel',
                'client-name-label': 'clientNameLabel', 'client-address-label': 'clientAddressLabel', 'client-phone-label': 'clientPhoneLabel',
                'table-area-th': 'tableAreaTh',
                'cancel-edit-blind-btn': 'cancelEditBtn', 'cancel-edit-screen-btn': 'cancelEditBtn',
                'screens-extender-frame-label': 'extenderFrameLabel',
                'login-btn-text': 'loginBtnText', 'logout-btn': 'logoutBtnTitle',
                'login-prompt-text': 'loginToSaveText', 'settings-login-prompt-text': 'settingsLoginPromptText'
            };
            for (const id in textContentMap) {
                const element = $(`#${id}`);
                if (element) {
                    if(id === 'logout-btn') element.title = t[textContentMap[id]];
                    else element.textContent = t[textContentMap[id]];
                }
            }
            
            $('#quote-search-input').placeholder = t.searchPlaceholder;

            const tabMap = { 'blinds-tab': 'blindsTab', 'screens-tab': 'screensTab', 'prices-tab': 'pricesTab', 'quote-tab': 'quoteTab', 'settings-tab': 'settingsTab' };
            for (const id in tabMap) $(`#${id} span`).textContent = t[tabMap[id]];

            const screenSelect = $('#blinds-integrated-screen');
            if(screenSelect) {
                screenSelect.querySelector('option[value="none"]').textContent = t.screenOptionNone;
                screenSelect.querySelector('option[value="full"]').textContent = t.screenOptionFull;
                screenSelect.querySelector('option[value="half"]').textContent = t.screenOptionHalf;
            }
            
            const divisionSideSelect = $('#blinds-division-side');
            if (divisionSideSelect) {
                divisionSideSelect.querySelector('option[value="right"]').textContent = t.sideRight;
                divisionSideSelect.querySelector('option[value="left"]').textContent = t.sideLeft;
            }

            updateButtonStates();
            updateBlindsColors();
            updateScreensColors();
            updateCurrentPrices(); 
            renderPrices();
            renderQuote();
        }

    function updateButtonStates() {
        const t = translations[currentLanguage];
        $('#save-quote-btn').textContent = t.saveQuoteBtn;
        $('#load-quotes-btn').textContent = t.loadQuotesBtn;

        $('#add-blind-btn').textContent = editingItemIndex !== null ? t.updateItemBtn : t.addBlindBtn;
        $('#add-screen-btn').textContent = editingItemIndex !== null ? t.updateItemBtn : t.addScreenBtn;
        
        const savePricesBtn = $('#save-prices-btn');
        if (savePricesBtn) {
            savePricesBtn.textContent = t.savePriceBtn;
        }
    }

    function updateCurrentPrices() {
        currentPrices = deepMerge({}, defaultPrices, userPrices);
    }
    
    function updateBlindsColors() {
        const type = $('#blinds-type').value;
        const colorSelect = $('#blinds-color');
        const currentProductNames = translations[currentLanguage].productNames;
        let colorOptions = [];
        if (type === 'pvc') colorOptions = ["white"];
        else if (type === 'aluminium') colorOptions = ["white", "brown", "wood", "anthracite", "special"];
        else if (type === 'external-aluminium') colorOptions = ["white", "brown", "gray", "dark_brown", "light_brown", "golden_oak", "walnut", "mahogany", "special"];
        colorSelect.innerHTML = colorOptions.map(color => `<option value="${color}">${currentProductNames[color] || color}</option>`).join('');
    }
    
    function updateScreensColors() {
        const colorSelect = $('#screens-color');
        const currentProductNames = translations[currentLanguage].productNames;
        const colorOptions = ["white", "brown", "wood", "anthracite", "special"];
        colorSelect.innerHTML = colorOptions.map(color => `<option value="${color}">${currentProductNames[color] || color}</option>`).join('');
    }

    function updateBlindOptions() {
        $('#integrated-screen-group').style.display = ($('#blinds-type').value === 'pvc') ? 'none' : 'block';
    }

    function calculatePrice(productType, width, height, options) {
        const area = (width / 1000) * (height / 1000);
        let pricePerM2 = 0, extrasPrice = 0, billableArea = 0;
        const prices = currentPrices; // These are always in RON
        if (!prices) return { price: 0, billableArea: 0, minAreaApplied: false };

        let minAreaApplied = false;

        if (productType === 'blinds' || productType === 'external-aluminium') {
            const isExternal = productType === 'external-aluminium';
            const basePrice = isExternal ? (prices["external-aluminium"]?.base || 0) : (prices.blinds?.[options.type] || 0);
            pricePerM2 = basePrice;
            const colorSurcharges = isExternal ? prices.external_aluminium_colors : prices.blinds_percentages;
            
            if (options.color && colorSurcharges?.[options.color]) { 
                pricePerM2 += basePrice * (colorSurcharges[options.color] / 100); 
            }

            if (options.integrated_screen === 'full') { 
                pricePerM2 += prices.blinds?.integrated_screen || 0; 
            }
            
            billableArea = Math.max(area, minAreas.blinds);
            if(billableArea > area) minAreaApplied = true;

            let areaPrice = billableArea * pricePerM2;

            if (options.divided) { 
                const dividedPrice = isExternal ? (prices["external-aluminium"]?.divided || 0) : (prices.blinds?.divided || 0); 
                extrasPrice += dividedPrice; 
            }
            
            if (options.integrated_screen === 'half') { 
                let halfScreenArea = ((width / 2) / 1000) * (height / 1000); 
                const billableHalfArea = Math.max(halfScreenArea, minAreas.half_screen); 
                extrasPrice += billableHalfArea * (prices.blinds?.integrated_screen || 0); 
            }

            if (options.control === 'motorized') { 
                extrasPrice += prices.blinds?.motorized || 0; 
            } 
            else if (options.control === 'string') { 
                const automataPrice = prices.blinds_extras?.automata || 0; 
                extrasPrice += options.divided ? (2 * automataPrice) : (1 * automataPrice); 
            }
            
            const priceInRon = areaPrice + extrasPrice;
            const finalPrice = currentCurrency === 'EUR' ? priceInRon / exchangeRate : priceInRon;
            return { price: finalPrice, billableArea: billableArea, minAreaApplied };

        } else if (productType === 'screens') {
            const basePrice = prices.screens?.[options.type] || 0;
            pricePerM2 = basePrice;
            if (options.color && prices.screens_percentages?.[options.color]) { pricePerM2 += basePrice * (prices.screens_percentages[options.color] / 100); }
            
            let minAreaForScreen = minAreas.screens;
            if (options.type === 'door' || options.type === 'thin-door') {
                minAreaForScreen = minAreas.door_screen;
            }

            billableArea = Math.max(area, minAreaForScreen);
            if(billableArea > area) minAreaApplied = true;

            let areaPrice = billableArea * pricePerM2;
            
            if ((options.type === 'door' || options.type === 'thin-door') && options.extenderFrame) {
                const perimeter = (width / 1000 * 2) + (height / 1000 * 2);
                extrasPrice += perimeter * (prices.screens.extender_frame_price_pm || 0);
            }

            const priceInRon = areaPrice + extrasPrice;
            const finalPrice = currentCurrency === 'EUR' ? priceInRon / exchangeRate : priceInRon;
            return { price: finalPrice, billableArea: billableArea, minAreaApplied };
        }
        return { price: 0, billableArea: 0, minAreaApplied: false };
    }

    function renderQuote() {
        const tbody = $('#quote-items-body'), t = translations[currentLanguage];
        tbody.innerHTML = '';
        let subtotal = 0;
        if (quoteItems.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-light-text-color">${t.noItemsInQuote}</td></tr>`;
        } else {
            quoteItems.forEach((item, index) => {
                const row = document.createElement('tr');
                const priceData = calculatePrice(item.isScreen ? 'screens' : (item.type === 'external-aluminium' ? 'external-aluminium' : 'blinds'), item.width, item.height, item.options);
                const unitPrice = priceData.price;
                item.billableArea = priceData.billableArea;
                const price = unitPrice * item.quantity;
                item.unitPrice = unitPrice; // Update item with current price
                item.price = price;         // Update item with current price
                subtotal += price;

                row.innerHTML = `<td class="px-4 py-2">${item.product[currentLanguage]||item.product.hu}</td><td class="px-4 py-2">${item.width}x${item.height}</td><td class="px-4 py-2">${item.billableArea.toFixed(2)}</td><td class="px-4 py-2">${item.quantity}</td><td class="px-4 py-2">${unitPrice.toFixed(2)} ${currentCurrency}</td><td class="px-4 py-2"><b>${price.toFixed(2)} ${currentCurrency}</b></td><td class="px-4 py-2 text-right"><div class="flex gap-3 justify-end"><button class="btn btn-secondary btn-icon" title="${t.editBtn}" data-action="edit" data-index="${index}"><i class="fa-solid fa-pencil"></i></button><button class="btn btn-danger btn-icon" title="${t.deleteBtn}" data-action="remove" data-index="${index}"><i class="fa-solid fa-trash"></i></button></div></td>`;
                tbody.appendChild(row);
            });
        }
        const discountPercentage = parseFloat($('#discount-percentage').value) || 0;
        const discountAmount = (subtotal * discountPercentage) / 100;
        const finalTotal = subtotal - discountAmount;
        const discountRow = $('#discount-row');
        if (discountAmount > 0) { $('#discount-amount').textContent = `-${discountAmount.toFixed(2)} ${currentCurrency}`; discountRow.classList.remove('hidden');
        } else { discountRow.classList.add('hidden'); }
        $('#subtotal-price').textContent = `${subtotal.toFixed(2)} ${currentCurrency}`;
        $('#total-price').textContent = `${finalTotal.toFixed(2)} ${currentCurrency}`;

        const renderFullSummary = (containerSelector) => {
            const container = $(containerSelector);
            const items = quoteItems;
            const title = t.quoteSummaryTitle;

            if (items.length === 0) { container.innerHTML = ''; return; }
            let summarySubtotal = 0;
            const itemsHtml = items.map(item => {
                summarySubtotal += item.price;
                return `<li class="flex justify-between items-center py-2 border-b border-[var(--table-row-border)]"><span class="text-sm">${item.product[currentLanguage] || item.product.hu} (${item.width}x${item.height}) x${item.quantity}</span><span class="font-semibold text-sm">${item.price.toFixed(2)} ${currentCurrency}</span></li>`;
            }).join('');

            container.innerHTML = `<h3 class="text-lg font-bold mb-3">${title}</h3><ul class="space-y-1">${itemsHtml}</ul><div class="flex justify-between items-center mt-4 pt-3 border-t border-[var(--input-border-color)]"><span class="font-bold">${t.summaryTotal}:</span><span class="font-bold text-lg">${summarySubtotal.toFixed(2)} ${currentCurrency}</span></div>`;
        };
        renderFullSummary('#blinds-summary-container');
        renderFullSummary('#screens-summary-container');
    }
        
    function renderPrices() {
        const container = $('#prices-container'), t = translations[currentLanguage], pricesInRon = currentPrices || {};
        container.innerHTML = '';

        const exchangeRateContainer = document.createElement('div');
        exchangeRateContainer.className = "p-4 rounded-2xl shadow-md mb-6 saved-quote-item";
        exchangeRateContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">${t.exchangeRateTitle}</h3><div class="flex items-center space-x-4 mb-2"><label class="w-2/3">1 EUR =</label><div class="input-with-unit w-1/3"><input type="number" id="exchange-rate-input" class="input-field text-right" value="${exchangeRate.toFixed(2)}" min="0" step="0.01"><span class="unit">RON</span></div></div>`;
        container.appendChild(exchangeRateContainer);

        const structure = [
            { title: t.blindsPrices, sections: [{ subtitle: t.basePricesM2, items: [ { key: 'pvc', path: 'blinds.pvc' }, { key: 'aluminium', path: 'blinds.aluminium' }, { key: 'external-aluminium', path: 'external-aluminium.base' } ] }, { subtitle: t.surcharges, items: [ { key: 'motorized', path: 'blinds.motorized', unit: t.unit_currency_pc }, { key: 'divided_blind', path: 'blinds.divided' }, { key: 'divided_external', path: 'external-aluminium.divided' }, { key: 'automata', path: 'blinds_extras.automata', unit: t.unit_currency_pc }, { key: 'integrated_screen', path: 'blinds.integrated_screen' } ]}, { subtitle: t.colorSurcharges, items: [ { key: 'wood', path: 'blinds_percentages.wood', unit: '%' }, { key: 'anthracite', path: 'blinds_percentages.anthracite', unit: '%' }, { key: 'special', path: 'blinds_percentages.special', unit: '%' } ] }, { subtitle: t.externalColorSurcharges, items: [ { key: 'gray', path: 'external_aluminium_colors.gray', unit: '%' }, { key: 'dark_brown', path: 'external_aluminium_colors.dark_brown', unit: '%' }, { key: 'light_brown', path: 'external_aluminium_colors.light_brown', unit: '%' }, { key: 'golden_oak', path: 'external_aluminium_colors.golden_oak', unit: '%' }, { key: 'walnut', path: 'external_aluminium_colors.walnut', unit: '%' }, { key: 'mahogany', path: 'external_aluminium_colors.mahogany', unit: '%' }, { key: 'special', path: 'external_aluminium_colors.special', unit: '%' } ] } ] },
            { title: t.screensPrices, sections: [ { subtitle: t.screenBasePricesM2, items: [ { key: 'fix', path: 'screens.fix' }, { key: 'balcony', path: 'screens.balcony' }, { key: 'mobile', path: 'screens.mobile' }, { key: 'plisse', path: 'screens.plisse' }, { key: 'door', path: 'screens.door' }, { key: 'thin-door', path: 'screens.thin-door' } ] }, { subtitle: t.surcharges, items: [ { key: 'extenderFramePrice', path: 'screens.extender_frame_price_pm' } ] }, { subtitle: t.screenColorSurcharges, items: [ { key: 'wood', path: 'screens_percentages.wood', unit: '%' }, { key: 'anthracite', path: 'screens_percentages.anthracite', unit: '%' }, { key: 'special', path: 'screens_percentages.special', unit: '%' } ] } ] }
        ];
        
        structure.forEach(category => {
            const categoryWrapper = document.createElement('div');
            categoryWrapper.innerHTML = `<h2 class="text-2xl font-bold mb-4">${category.title}</h2>`;
            category.sections.forEach(section => {
                const sectionContainer = document.createElement('div');
                sectionContainer.className = "p-4 rounded-2xl shadow-md mb-4 saved-quote-item";
                sectionContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">${section.subtitle}</h3>`;
                section.items.forEach(item => {
                    let priceValue = item.path.split('.').reduce((o, i) => o?.[i], pricesInRon) || 0;
                    const isPercentage = item.unit === '%';
                    if (currentCurrency === 'EUR' && !isPercentage) {
                        priceValue /= exchangeRate;
                    }

                    const priceItem = document.createElement('div');
                    priceItem.className = "flex items-center space-x-4 mb-2";
                    priceItem.innerHTML = `<label class="w-2/3">${t.productNames[item.key] || t[item.key]}:</label><div class="input-with-unit w-1/3"><input type="number" data-path="${item.path}" class="input-field text-right" value="${isPercentage ? priceValue : priceValue.toFixed(2)}" min="0" step="any"><span class="unit">${item.unit || currentCurrency}</span></div>`;
                    sectionContainer.appendChild(priceItem);
                });
                categoryWrapper.appendChild(sectionContainer);
            });
            container.appendChild(categoryWrapper);
        });
        const saveButton = document.createElement('button');
        saveButton.id = "save-prices-btn";
        saveButton.className = "w-full mt-6 btn btn-secondary";
        container.appendChild(saveButton);
        updateButtonStates();
    }

    function loadSettings(data) {
        const settingsToLoad = {
            'company-name': 'companyName',
            'company-website': 'companyWebsite',
            'company-email': 'companyEmail',
            'company-phone': 'companyPhone'
        };

        for(const [id, key] of Object.entries(settingsToLoad)) {
            const value = data ? data[key] : (currentUser ? '' : localStorage.getItem(key));
            if (value) $(`#${id}`).value = value;
            else $(`#${id}`).value = '';
        }

        const companyLogo = data ? data.companyLogo : (currentUser ? null : localStorage.getItem('companyLogo'));
        const deleteBtn = $('#delete-logo-btn');
        if (companyLogo) {
            $('#header-logo').src = companyLogo; $('#header-logo').classList.remove('hidden');
            $('#logo-preview').src = companyLogo; $('#logo-preview').classList.remove('hidden');
            $('#logo-upload-text').classList.add('hidden');
            deleteBtn.classList.remove('hidden');
        } else {
            $('#header-logo').src = ''; $('#header-logo').classList.add('hidden');
            $('#logo-preview').src = ''; $('#logo-preview').classList.add('hidden');
            $('#logo-upload-text').classList.remove('hidden');
            deleteBtn.classList.add('hidden');
        }
    }
        
    function renderSavedQuotesList(searchTerm = '') {
        const list = $('#saved-quotes-list');
        const t = translations[currentLanguage];
        list.innerHTML = '';

        if (!currentUser) {
            $('#login-prompt').classList.remove('hidden');
            list.innerHTML = '';
            return;
        }
        $('#login-prompt').classList.add('hidden');

        const filteredQuotes = allSavedQuotes.filter(q =>
            q.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (q.clientName && q.clientName.toLowerCase().includes(searchTerm.toLowerCase()))
        );

        if (filteredQuotes.length === 0) {
            list.innerHTML = `<li class="text-light-text-color p-3">${t.noQuotesFound}</li>`;
            return;
        }
        
        filteredQuotes.forEach((quote, index) => {
            const listItem = document.createElement('li');
            listItem.className = "saved-quote-item flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-xl shadow-sm";
            listItem.style.animationDelay = `${index * 50}ms`;
            const clientInfo = quote.clientName ? `<span class="text-sm text-light-text-color">${quote.clientName}</span>` : '';
            listItem.innerHTML = `<div><p class="font-semibold">${quote.name}</p>${clientInfo}</div><div class="flex space-x-2 w-full sm:w-auto mt-2 sm:mt-0 flex-shrink-0"><button class="btn btn-primary btn-small w-full sm:w-auto" data-action="load">${t.loadQuotesBtn}</button><button class="btn btn-danger btn-small w-full sm:w-auto" data-action="delete">${t.deleteBtn}</button></div>`;
            
            listItem.querySelector('[data-action="load"]').addEventListener('click', () => {
                const loadedItems = JSON.parse(quote.items);
                quoteItems = loadedItems.map(item => { if (item.options === undefined) { console.warn('Old quote item format detected, upgrading.'); item.options = { type: item.type || (item.isScreen ? 'fix' : 'pvc'), color: 'white', control: 'string', divided: false, integrated_screen: 'none', divisionSide: null, divisionWidth: null }; } return item; });
                $('#quote-name').value = quote.name || '';
                $('#client-name').value = quote.clientName || '';
                $('#client-address').value = quote.clientAddress || '';
                $('#client-phone').value = quote.clientPhone || '';
                $('#discount-percentage').value = quote.discount || 0;
                renderQuote();
                switchToTab('quote-tab');
                $('#load-quote-section').classList.add('hidden');
                showToast(t.quoteLoaded);
            });

            listItem.querySelector('[data-action="delete"]').addEventListener('click', async () => {
                const confirmed = await showConfirmationModal(t.deleteQuotePromptTitle, t.deleteQuotePromptText.replace('{{name}}', quote.name));
                if (confirmed && currentUser) {
                    try {
                        await deleteDoc(doc(db, 'users', currentUser.uid, 'quotes', quote.id));
                        showToast(t.quoteDeleted, 'success');
                    } catch (error) {
                        console.error("Error deleting quote: ", error);
                        showToast("Hiba a törlés során", 'error');
                    }
                }
            });

            list.appendChild(listItem);
        });
    }

    function setupListeners() {
        $$('.tab-button').forEach(tab => tab.addEventListener('click', async () => { 
            if (editingItemIndex !== null) {
                resetEditingState();
            }

            if (tab.id === 'prices-tab') {
                if (sessionStorage.getItem('pricesUnlocked') === 'true') {
                    switchToTab('prices-tab');
                } else {
                    const pinCorrect = await promptForPin();
                    if (pinCorrect) {
                        sessionStorage.setItem('pricesUnlocked', 'true');
                        switchToTab('prices-tab');
                    }
                }
            } else {
                switchToTab(tab.id);
            }
        }));
        
        $('#language-select').addEventListener('change', (e) => { currentLanguage = e.target.value; updateLocalization(); saveSettingsToFirestore(); });
        $('#currency-select').addEventListener('change', (e) => { currentCurrency = e.target.value; renderPrices(); renderQuote(); saveSettingsToFirestore(); });
        $('#theme-toggle').addEventListener('click', toggleTheme);
        $('#discount-percentage').addEventListener('input', renderQuote);
        $('#blinds-type').addEventListener('change', () => { updateBlindsColors(); updateBlindOptions(); });
        
        $('#blinds-divided').addEventListener('change', (e) => {
            $('#blinds-division-details').classList.toggle('hidden', !e.target.checked);
        });

        $('#screens-type').addEventListener('change', (e) => {
            const type = e.target.value;
            const frameGroup = $('#extender-frame-group');
            if (type === 'door' || type === 'thin-door') {
                frameGroup.classList.remove('hidden');
            } else {
                frameGroup.classList.add('hidden');
            }
        });


        const handleBlindSubmit = () => {
            const type = $('#blinds-type').value, width = parseFloat($('#blinds-width').value), height = parseFloat($('#blinds-height').value), quantity = parseInt($('#blinds-quantity').value, 10), color = $('#blinds-color').value, control = $('#blinds-control').value, divided = $('#blinds-divided').checked, integrated_screen = type === 'pvc' ? 'none' : $('#blinds-integrated-screen').value;
            const divisionSide = divided ? $('#blinds-division-side').value : null, divisionWidth = divided ? parseFloat($('#blinds-division-width').value) : null;
            
            if (isNaN(width) || isNaN(height) || isNaN(quantity) || (divided && isNaN(divisionWidth))) { showToast(translations[currentLanguage].emptyFieldsError, 'error'); return; }
            if ((divided && divisionWidth <= 0) || width <= 0 || height <= 0) { showToast(translations[currentLanguage].invalidSizeError, 'error'); return; }
            if (divided && divisionWidth >= width) { showToast(translations[currentLanguage].invalidDivisionWidthError, 'error'); return; }
            if (quantity <= 0) { showToast(translations[currentLanguage].invalidQuantityError, 'error'); return; }
            if (type === 'pvc' && color !== 'white') { showToast(translations[currentLanguage].pvcColorError, 'error'); return; }
            
            const itemOptions = { type, color, control, divided, integrated_screen, divisionSide, divisionWidth };
            const priceData = calculatePrice('blinds', width, height, itemOptions);
            if (priceData.minAreaApplied) { showToast(translations[currentLanguage].minAreaWarning.replace('{{area}}', minAreas.blinds), 'info'); }

            const productText = {};
            for (const lang in translations) { 
                const names = translations[lang].productNames; let text = `${names[type]} (${names[color]})`; 
                if (control === 'string') text += ` (${names.automata} x${divided ? 2 : 1})`; else text += ` (${names.motorized})`; 
                if (divided) { const sideText = translations[lang][divisionSide === 'right' ? 'sideRight' : 'sideLeft']; text += ` (${names.divided_blind} ${sideText}: ${divisionWidth}mm)`; }
                if (integrated_screen === 'full') text += ` (+${names.integrated_screen_full})`; else if (integrated_screen === 'half') text += ` (+${names.integrated_screen_half})`; 
                productText[lang] = text; 
            }
            const newItem = { isScreen: false, type, product: productText, width, height, quantity, options: itemOptions, billableArea: priceData.billableArea, unitPrice: priceData.price, price: priceData.price * quantity };
            
            if (editingItemIndex !== null) {
                quoteItems[editingItemIndex] = newItem;
                showToast(translations[currentLanguage].productUpdatedMessage);
            } else {
                quoteItems.push(newItem);
                showToast(translations[currentLanguage].productAddedMessage);
            }
            resetEditingState();
            renderQuote();
        };

        const handleScreenSubmit = () => {
            const type = $('#screens-type').value, width = parseFloat($('#screens-width').value), height = parseFloat($('#screens-height').value), quantity = parseInt($('#screens-quantity').value, 10), color = $('#screens-color').value;
            const extenderFrame = (type === 'door' || type === 'thin-door') && $('#screens-extender-frame').checked;

            if (isNaN(width) || isNaN(height) || isNaN(quantity)) { showToast(translations[currentLanguage].emptyFieldsError, 'error'); return; }
            if (width <= 0 || height <= 0) { showToast(translations[currentLanguage].invalidSizeError, 'error'); return; }
            if (quantity <= 0) { showToast(translations[currentLanguage].invalidQuantityError, 'error'); return; }
            
            const itemOptions = { type, color, extenderFrame };
            const priceData = calculatePrice('screens', width, height, itemOptions);
            let minAreaForScreen = (type === 'door' || type === 'thin-door') ? minAreas.door_screen : minAreas.screens;
            if (priceData.minAreaApplied) { showToast(translations[currentLanguage].minAreaWarning.replace('{{area}}', minAreaForScreen), 'info'); }

            const productText = {};
            for (const lang in translations) { 
                let text = `${translations[lang].productNames[type]} (${translations[lang].productNames[color]})`;
                if (extenderFrame) {
                    text += ` (+${translations[lang].productNames.extender_frame})`;
                }
                productText[lang] = text;
            }
            const newItem = { isScreen: true, type, product: productText, width, height, quantity, options: itemOptions, billableArea: priceData.billableArea, unitPrice: priceData.price, price: priceData.price * quantity };
            
            if (editingItemIndex !== null) {
                quoteItems[editingItemIndex] = newItem;
                showToast(translations[currentLanguage].productUpdatedMessage);
            } else {
                quoteItems.push(newItem);
                showToast(translations[currentLanguage].productAddedMessage);
            }
            resetEditingState();
            renderQuote();
        };

        $('#add-blind-btn').addEventListener('click', handleBlindSubmit);
        $('#add-screen-btn').addEventListener('click', handleScreenSubmit);
        $('#cancel-edit-blind-btn').addEventListener('click', resetEditingState);
        $('#cancel-edit-screen-btn').addEventListener('click', resetEditingState);

        $('#prices-content').addEventListener('input', (e) => { if(e.target.id === 'exchange-rate-input') { const newRate = parseFloat(e.target.value); if (!isNaN(newRate) && newRate > 0) { exchangeRate = newRate; renderPrices(); renderQuote(); } } });
        $('#prices-content').addEventListener('change', (e) => {
            if (e.target.tagName !== 'INPUT' || !e.target.dataset.path) return;
            const path = e.target.dataset.path; let value = parseFloat(e.target.value); if (isNaN(value)) return;
            const isPercentage = e.target.nextElementSibling?.textContent === '%';
            if (currentCurrency === 'EUR' && !isPercentage) { value *= exchangeRate; }
            const setNestedValue = (obj, p, v) => { const keys = p.split('.'), lk = keys.pop(), lo = keys.reduce((o, k) => o[k] = o[k] || {}, obj); lo[lk] = v; };
            setNestedValue(userPrices, path, value); updateCurrentPrices(); renderQuote();
        });
        
        $('#load-quotes-btn').addEventListener('click', () => { const section = $('#load-quote-section'); section.classList.toggle('hidden'); if (!section.classList.contains('hidden')) { renderSavedQuotesList(); } });
        $('#quote-search-input').addEventListener('input', (e) => renderSavedQuotesList(e.target.value));
        $('#preview-quote-btn').addEventListener('click', generateQuotePreview);

        $('#quote-items-body').addEventListener('click', (e) => { 
            const button = e.target.closest('button');
            if (!button) return;
            const { action, index } = button.dataset;
            if (action === 'remove') { quoteItems.splice(parseInt(index, 10), 1); renderQuote(); }
            if (action === 'edit') { startEditingItem(parseInt(index, 10)); }
        });

        $('#company-logo-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { localStorage.setItem('companyLogo', e.target.result); loadSettings({ companyLogo: e.target.result }); saveSettingsToFirestore(); }; reader.readAsDataURL(file); } });
        
        $('#delete-logo-btn').addEventListener('click', () => { localStorage.removeItem('companyLogo'); loadSettings({ companyLogo: '' }); saveSettingsToFirestore(); showToast(translations[currentLanguage].logoDeletedMessage); });
        $('#export-data-btn').addEventListener('click', exportData);
        $('#import-data-btn').addEventListener('click', () => $('#import-file-input').click());
        $('#import-file-input').addEventListener('change', importData);
    }
        
    function promptForPin() {
        return new Promise((resolve) => {
            const modal = $('#pin-modal');
            const pinInput = $('#pin-input');
            const errorMsg = $('#pin-error');
            const t = translations[currentLanguage];

            $('#pin-modal-title').textContent = t.pinModalTitle;
            $('#pin-modal-text').textContent = t.pinModalText;
            $('#pin-submit-btn').textContent = t.pinSubmitBtn;
            $('#pin-cancel-btn').textContent = t.cancelEditBtn;
            errorMsg.textContent = t.pinError;

            pinInput.value = '';
            errorMsg.classList.add('hidden');
            modal.classList.add('active');
            pinInput.focus();

            const correctPin = '2009';

            const submitHandler = () => {
                if (pinInput.value === correctPin) {
                    modal.classList.remove('active');
                    cleanup();
                    resolve(true);
                } else {
                    errorMsg.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.focus();
                }
            };

            const cancelHandler = () => {
                modal.classList.remove('active');
                cleanup();
                resolve(false);
            };
            
            const keypressHandler = (e) => {
                if (e.key === 'Enter') {
                    submitHandler();
                }
            };

            const cleanup = () => {
                $('#pin-submit-btn').removeEventListener('click', submitHandler);
                $('#pin-cancel-btn').removeEventListener('click', cancelHandler);
                pinInput.removeEventListener('keypress', keypressHandler);
            };

            $('#pin-submit-btn').addEventListener('click', submitHandler);
            $('#pin-cancel-btn').addEventListener('click', cancelHandler);
            pinInput.addEventListener('keypress', keypressHandler);
        });
    }

    function resetEditingState() {
        editingItemIndex = null;
        
        // Reset blinds form
        $('#blinds-width').value = ''; 
        $('#blinds-height').value = ''; 
        $('#blinds-quantity').value = 1; 
        $('#blinds-divided').checked = false;
        $('#blinds-division-details').classList.add('hidden');
        $('#blinds-division-width').value = '';
        $('#cancel-edit-blind-btn').classList.add('hidden');

        // Reset screens form
        $('#screens-width').value = ''; 
        $('#screens-height').value = ''; 
        $('#screens-quantity').value = 1;
        $('#screens-extender-frame').checked = false;
        $('#extender-frame-group').classList.add('hidden');
        $('#cancel-edit-screen-btn').classList.add('hidden');

        updateButtonStates();
    }

    function generateQuotePreview() {
        if (quoteItems.length === 0) { showToast(translations[currentLanguage].noItemsInQuote, 'error'); return; }
        
        const previewData = { 
            quoteItems,
            translations,
            companyName: $('#company-name').value || '',
            companyWebsite: $('#company-website').value || '',
            companyEmail: $('#company-email').value || '',
            companyPhone: $('#company-phone').value || '',
            companyLogo: localStorage.getItem('companyLogo') || '',
            quoteName: $('#quote-name').value.trim() || 'Árajánlat',
            clientName: $('#client-name').value.trim(),
            clientAddress: $('#client-address').value.trim(),
            clientPhone: $('#client-phone').value.trim(),
            subtotal: quoteItems.reduce((sum, item) => sum + item.price, 0),
            discountPercentage: parseFloat($('#discount-percentage').value) || 0,
            discountAmount: (quoteItems.reduce((sum, item) => sum + item.price, 0) * (parseFloat($('#discount-percentage').value) || 0)) / 100,
            finalTotal: quoteItems.reduce((sum, item) => sum + item.price, 0) * (1 - (parseFloat($('#discount-percentage').value) || 0) / 100),
            currentCurrency,
            exchangeRate, 
            isDarkMode: document.body.classList.contains('dark')
        };

        const previewWindow = window.open('', '_blank');
        if (previewWindow) { 
            previewWindow.document.write(`...`); // A teljes HTML sablon ide kerül, de a rövidség kedvéért most kihagyva
            previewWindow.document.close(); 
        } 
        else { showToast('A böngésző blokkolta az előnézeti ablakot.', 'error'); }
    }

    function exportData() {
        const dataToExport = {
            userPrices: userPrices,
            savedQuotes: allSavedQuotes,
            settings: {
                companyName: $('#company-name').value,
                companyWebsite: $('#company-website').value,
                companyEmail: $('#company-email').value,
                companyPhone: $('#company-phone').value,
                companyLogo: localStorage.getItem('companyLogo') || '',
                theme: localStorage.getItem('theme') || 'light',
                exchangeRate: exchangeRate,
                language: currentLanguage,
                currency: currentCurrency
            }
        };
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `arajanlat-keszito-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importData(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                // Itt lehetne egy logika, ami a Firebase-be importál, de az bonyolultabb.
                // Jelenleg felülírja a helyi adatokat, amik a következő bejelentkezéskor felülíródnának.
                // A legjobb, ha a felhasználó manuálisan viszi fel újra az adatokat, ha be van jelentkezve.
                showToast(translations[currentLanguage].importSuccess);
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                console.error('Import failed:', error);
                showToast(translations[currentLanguage].importError, 'error');
            } finally { event.target.value = ''; }
        };
        reader.readAsText(file);
    }

  // --- FIREBASE AUTH LOGIKA ---
  const loginBtn = $('#login-btn');
  const logoutBtn = $('#logout-btn');
  const userInfoDiv = $('#user-info');
  const googleProvider = new GoogleAuthProvider();

  // Handle the redirect result when the page loads
  getRedirectResult(auth)
    .catch((error) => {
        console.error("Login redirect failed:", error);
        const t = translations[currentLanguage];
        if (error.code === 'auth/unauthorized-domain') {
            showToast(t.unauthorizedDomainError, 'error');
        } else {
            showToast(t.genericLoginError, 'error');
        }
    });

  loginBtn.addEventListener('click', () => {
      signInWithRedirect(auth, googleProvider);
  });

  logoutBtn.addEventListener('click', () => {
      signOut(auth).catch(error => console.error("Logout failed:", error));
  });

  onAuthStateChanged(auth, user => {
      const t = translations[currentLanguage];
      if (user) {
          currentUser = user;
          loginBtn.style.display = 'none';
          userInfoDiv.style.display = 'flex';
          $('#user-photo').src = user.photoURL;
          $('#user-name').textContent = user.displayName;
          
          showToast(t.loggedInSuccess, 'success');
          
          loadDataFromFirestore(user.uid);
          
          $('#save-quote-btn').disabled = false;
          $('#save-settings-btn').disabled = false;
          const savePricesBtn = $('#save-prices-btn');
          if (savePricesBtn) savePricesBtn.disabled = false;

          $('#login-prompt').classList.add('hidden');
          $('#settings-login-prompt').classList.add('hidden');
      } else {
          currentUser = null;
          loginBtn.style.display = 'flex';
          userInfoDiv.style.display = 'none';
          
          if (unsubscribeSettings) unsubscribeSettings();
          if (unsubscribeQuotes) unsubscribeQuotes();
          resetToDefaultState();

          $('#save-quote-btn').disabled = true;
          $('#save-settings-btn').disabled = true;
          const savePricesBtn = $('#save-prices-btn');
          if (savePricesBtn) savePricesBtn.disabled = true;

          $('#login-prompt').classList.remove('hidden');
          $('#settings-login-prompt').classList.remove('hidden');
      }
  });

    function resetToDefaultState() {
        userPrices = {};
        allSavedQuotes = [];
        quoteItems = [];
        loadSettings(null);
        updateCurrentPrices();
        updateLocalization();
    }

    function loadDataFromFirestore(userId) {
        if (unsubscribeSettings) unsubscribeSettings();
        if (unsubscribeQuotes) unsubscribeQuotes();

        const settingsRef = doc(db, 'users', userId);
        
        unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                userPrices = data.userPrices || {};
                currentLanguage = data.language || 'hu';
                currentCurrency = data.currency || 'RON';
                exchangeRate = data.exchangeRate || 5.0;
                
                $('#language-select').value = currentLanguage;
                $('#currency-select').value = currentCurrency;

                loadSettings(data);
                updateCurrentPrices();
                updateLocalization();
            } else {
                console.log("No settings document for user, using defaults.");
                resetToDefaultState();
            }
        });

        const quotesRef = collection(db, 'users', userId, 'quotes');
        const q = query(quotesRef, orderBy('createdAt', 'desc'));

        unsubscribeQuotes = onSnapshot(q, (querySnapshot) => {
            allSavedQuotes = [];
            querySnapshot.forEach((doc) => {
                allSavedQuotes.push({ id: doc.id, ...doc.data() });
            });
            renderSavedQuotesList($('#quote-search-input').value);
        });
    }

    async function saveSettingsToFirestore() {
        if (!currentUser) return;
        const t = translations[currentLanguage];
        const settingsData = {
            companyName: $('#company-name').value,
            companyWebsite: $('#company-website').value,
            companyEmail: $('#company-email').value,
            companyPhone: $('#company-phone').value,
            companyLogo: localStorage.getItem('companyLogo') || '',
            language: $('#language-select').value,
            currency: $('#currency-select').value,
            exchangeRate: parseFloat($('#exchange-rate-input')?.value) || exchangeRate,
            userPrices: userPrices
        };

        try {
            await setDoc(doc(db, 'users', currentUser.uid), settingsData, { merge: true });
            showToast(t.settingsSavedMessage, 'success');
        } catch (error) {
            console.error("Error saving settings: ", error);
            showToast("Hiba a mentés során", 'error');
        }
    }

    async function saveQuoteToFirestore() {
        if (!currentUser) return;
        const t = translations[currentLanguage];
        const quoteName = $('#quote-name').value.trim();
        if (quoteName === '') {
            showToast(t.quoteNameRequired, 'error');
            return;
        }

        const newQuote = {
            name: quoteName,
            items: JSON.stringify(quoteItems.map(item => ({ ...item, unitPrice: undefined, price: undefined }))),
            discount: parseFloat($('#discount-percentage').value) || 0,
            clientName: $('#client-name').value.trim(),
            clientAddress: $('#client-address').value.trim(),
            clientPhone: $('#client-phone').value.trim(),
            createdAt: new Date().toISOString()
        };

        try {
            const quotesCol = collection(db, 'users', currentUser.uid, 'quotes');
            await addDoc(quotesCol, newQuote);
            showToast(t.quoteSaved, 'success');
        } catch (error) {
            console.error("Error saving quote: ", error);
            showToast("Hiba a mentés során", 'error');
        }
    }
    
    // --- INICIALIZÁLÁS ---
    function init() {
        initializeTheme();
        currentLanguage = localStorage.getItem('language') || 'hu';
        currentCurrency = localStorage.getItem('currency') || 'RON';
        $('#language-select').value = currentLanguage;
        $('#currency-select').value = currentCurrency;
        resetToDefaultState();

        setupListeners();
        
        $('#save-settings-btn').addEventListener('click', saveSettingsToFirestore);
        $('#save-quote-btn').addEventListener('click', saveQuoteToFirestore);
        $('#prices-content').addEventListener('click', e => {
            if (e.target.id === 'save-prices-btn') {
                saveSettingsToFirestore();
            }
        });
    }
    
    // Az egész alkalmazás indítása a DOM betöltődése után
    document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>

