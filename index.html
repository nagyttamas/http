<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EUROPLAST Árajánlat Készítő</title>

    <!-- WebKit/iOS Home Screen Ikon és Beállítások -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EUROPLAST">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/009688/FFFFFF?text=EP&font=inter">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- pdfmake for all PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- Beágyazott Google Fonts: Inter --- */
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 400;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 600;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Inter';
          font-style: normal;
          font-weight: 700;
          font-display: swap;
          src: url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        
        /* --- Alkalmazás Stílusok --- */
        :root {
            --primary-color: #009688; 
            --primary-dark: #00796B;
            --secondary-color: #00BCD4;
            --secondary-dark: #0097A7;
            --accent-color: #F59E0B;
            
            /* Világos mód színei */
            --background-start-light: #E0F2F1;
            --background-end-light: #E0F7FA;
            --surface-glass-light: rgba(255, 255, 255, 0.6);
            --border-glass-light: rgba(255, 255, 255, 0.8);
            --text-color: #1F2937;
            --light-text-color: #6B7280;
            --input-bg-color: #F9FAFB;
            --input-border-color: #D1D5DB;
            --table-header-bg: #E5E7EB;
            --table-row-border: #E5E7EB;
            --hover-bg-color: #E5E7EB;
            --surface-color: #FFFFFF;
        }

        body.dark {
            /* Sötét mód színei */
            --background-start-dark: #1A202C;
            --background-end-dark: #2D3748;
            --surface-glass-dark: rgba(10, 15, 25, 0.65);
            --border-glass-dark: rgba(50, 60, 75, 0.5);
            --text-color: #F9FAFB;
            --light-text-color: #9CA3AF;
            --input-bg-color: #374151;
            --input-border-color: #4B5563;
            --table-header-bg: #374151;
            --table-row-border: #4B5563;
            --hover-bg-color: #374151;
            --surface-color: #1F2937;
        }
        
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            background-image: linear-gradient(135deg, var(--background-start-light), var(--background-end-light));
            background-attachment: fixed;
            transition: color 0.3s;
        }

        body.dark {
            background-image: linear-gradient(135deg, var(--background-start-dark), var(--background-end-dark));
        }

        .container {
            max-width: 1024px;
            background-color: var(--surface-glass-light);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass-light);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, border-color 0.3s;
        }

        body.dark .container {
             background-color: var(--surface-glass-dark);
             border-color: var(--border-glass-dark);
        }

        /* Tabs styling - iOS Glass Effect */
        .tab-button {
            -webkit-appearance: none;
            border: none;
            transition: all 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border-radius: 9999px; /* Kerekebb */
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            background-color: rgba(148, 163, 184, 0.1);
            color: var(--light-text-color);
            flex-shrink: 0;
        }
        body.dark .tab-button:not(.active-style) {
            background-color: rgba(71, 85, 105, 0.2);
        }
        .tab-button:not(.active-style):hover {
            background-color: rgba(148, 163, 184, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 0 25px 8px rgba(0, 150, 136, 0.25);
        }
        body.dark .tab-button:not(.active-style):hover {
            background-color: rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 0 25px 8px rgba(0, 188, 212, 0.3);
        }
        .tab-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.4);
        }
        .tab-button.active-style {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
        }
        .tab-button.active-style:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 150, 136, 0.4), 0 0 35px 12px rgba(0, 188, 212, 0.4);
        }
        
        .tab-button .icon {
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }
        
        .tab-button:not(.active-style) .icon {
             color: var(--light-text-color);
        }

        .tab-button.active-style .icon {
            color: white;
        }

        /* Input and select styling */
        @keyframes input-focus-glow {
            from { box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.2), 0 0 0 rgba(0, 188, 212, 0); }
            to { box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.2), 0 0 20px 5px rgba(0, 188, 212, 0.3); }
        }
        .input-field {
            -webkit-appearance: none;
            appearance: none;
            padding: 0.75rem 1rem;
            border-radius: 16px; /* Kerekebb */
            color: var(--text-color);
            transition: all 0.3s ease;
            width: 100%;
            background-color: rgba(224, 242, 241, 0.4);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(178, 222, 219, 0.5);
        }

        body.dark .input-field {
            background-color: rgba(26, 32, 44, 0.5);
            border-color: rgba(74, 85, 104, 0.5);
        }

        .input-field:hover:not(:disabled) {
            border-color: var(--secondary-dark);
            box-shadow: 0 0 20px 5px rgba(0, 188, 212, 0.3);
            transform: translateY(-1px);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            animation: input-focus-glow 0.8s alternate infinite;
        }

        .input-field::placeholder {
            color: var(--light-text-color);
        }

        select.input-field {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        body.dark select.input-field {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        
        #language-select, #currency-select, #order-language-select {
            width: auto;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }


        /* Button styling - iOS Inspired */
        .btn {
            -webkit-appearance: none;
            font-weight: 600;
            padding: 0.9rem 1.75rem;
            border-radius: 9999px; /* Kerekebb */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            transform: scale(1);
            border: 1px solid transparent;
        }
        .btn-primary { 
            background-color: var(--primary-color); 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: var(--primary-dark); 
            animation: button-glow 3s infinite ease-in-out;
        }
        .btn-secondary { 
            background-color: var(--hover-bg-color); 
            color: var(--text-color);
            border-color: var(--input-border-color);
        }
        body.dark .btn-secondary {
            background-color: var(--input-bg-color);
        }
        .btn-secondary:hover { 
            background-color: var(--input-border-color);
        }
        .btn-tertiary { background-color: var(--accent-color); color: white; border-color: transparent; }
        .btn-tertiary:hover { background-color: #D97706; }
        .btn-danger { background-color: #EF4444; color: white; border-color: transparent;}
        .btn-danger:hover { background-color: #DC2626; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 9999px; /* Kerekebb */ }
        
        .btn-icon {
             -webkit-appearance: none;
             padding: 0;
             width: 2.5rem;
             height: 2.5rem;
             display: inline-flex;
             align-items: center;
             justify-content: center;
             border-radius: 9999px;
             font-size: 1rem;
             transition: all 0.2s ease;
        }
        .btn:active, .tab-button:active, .btn-icon:active, #theme-toggle:active {
            transform: scale(0.97);
            box-shadow: 0 0 25px 8px rgba(0, 188, 212, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes tab-open-glow {
            0% { box-shadow: 0 0 5px rgba(0, 188, 212, 0.1), inset 0 0 10px rgba(0, 188, 212, 0.1); }
            50% { box-shadow: 0 0 40px 15px rgba(0, 188, 212, 0.4), inset 0 0 20px rgba(0, 188, 212, 0.3); }
            100% { box-shadow: 0 0 5px rgba(0, 188, 212, 0.1), inset 0 0 10px rgba(0, 188, 212, 0.1); }
        }

        @keyframes button-glow {
            0% { box-shadow: 0 0 5px rgba(0, 150, 136, 0.4), 0 0 10px rgba(0, 188, 212, 0.2); }
            50% { box-shadow: 0 0 20px 8px rgba(0, 150, 136, 0.6), 0 0 30px 12px rgba(0, 188, 212, 0.4); }
            100% { box-shadow: 0 0 5px rgba(0, 150, 136, 0.4), 0 0 10px rgba(0, 188, 212, 0.2); }
        }

        .tab-content { display: none; background-color: transparent; border-radius: 1rem; /* Lekerekített sarkok a fényudvar effektushoz */ }
        .tab-content.active { 
            display: block; 
            animation: fadeIn 0.5s, tab-open-glow 0.8s ease-out;
        }
        
        /* Sub-tab styles */
        .sub-tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background-color: transparent;
            color: var(--light-text-color);
            font-weight: 600;
            cursor: pointer;
            transition: color 0.3s, border-color 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
        }
        .sub-tab-button.active-sub-style {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .sub-tab-button:not(.active-sub-style):hover {
            color: var(--text-color);
        }
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; animation: fadeIn 0.5s; }


        .input-with-unit { display: flex; align-items: center; }
        .input-with-unit .input-field { border-radius: 12px 0 0 12px; }
        .input-with-unit .unit {
            background-color: var(--hover-bg-color); color: var(--light-text-color); padding: 0.75rem 1rem;
            border-radius: 0 12px 12px 0; border: 1px solid var(--input-border-color); border-left: none;
        }
        
        .table-header {
            background-color: var(--table-header-bg);
            color: var(--text-color);
        }

        #quote-items-body {
            border-color: var(--table-row-border);
        }

        /* Legördülő szekciók animációja */
        #load-quote-section {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            border-width: 0;
            transition: all 0.5s ease-in-out;
        }
        #load-quote-section.visible {
            max-height: 600px;
            opacity: 1;
            padding: 1rem;
            margin-top: 1.5rem;
            border-width: 1px;
        }
        #blinds-division-details {
            display: grid;
            gap: 1.5rem;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.4s ease-in-out;
            margin-top: 0 !important;
            padding-top: 0;
        }
        #blinds-division-details.visible {
            max-height: 200px;
            opacity: 1;
            margin-top: 1.5rem !important;
            padding-top: 1rem;
        }
        @media (min-width: 768px) {
            #blinds-division-details.visible { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        .saved-quote-item {
            background-color: rgba(148, 163, 184, 0.1);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(148, 163, 184, 0.15);
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s ease;
        }
        .saved-quote-item:active {
            transform: scale(0.98);
            filter: brightness(0.95);
            box-shadow: 0 0 20px 5px rgba(0, 188, 212, 0.3);
        }
        body.dark .saved-quote-item {
            background-color: rgba(71, 85, 105, 0.2);
            border-color: rgba(71, 85, 105, 0.3);
        }
        .saved-quote-item.animated {
            animation: slideInListItem 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(30px);
        }
        @keyframes slideInListItem {
            to { opacity: 1; transform: translateY(0); }
        }


        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 12px;
            color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0; transform: translateX(100%);
            animation: slideInToast 0.5s forwards, fadeOutToast 0.5s 4.5s forwards;
            min-width: 250px;
        }
        .toast-success { background-color: var(--primary-color); }
        .toast-error { background-color: #EF4444; }
        .toast-info { background-color: var(--secondary-color); }
        .toast .icon { margin-right: 0.75rem; font-size: 1.5rem; }
        @keyframes slideInToast { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }

        /* Modal styling with Backdrop Blur */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.35);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--surface-color); padding: 2rem; border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%; max-width: 400px;
            transform: scale(0.95) translateY(-20px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* --- Eszköz-specifikus rács elrendezések --- */
        .form-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
        }

        /* Tablet / iPad (álló) és nagyobb tabletek (768px-től) */
        @media (min-width: 768px) {
            .form-grid {
                gap: 1.75rem;
            }
            #blinds-content .form-grid { grid-template-columns: repeat(3, 1fr); }
            #screens-content .form-grid { grid-template-columns: repeat(2, 1fr); }
            #settings-content .form-grid { grid-template-columns: repeat(2, 1fr); }
            #quote-details-content .form-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* PC / iPad (fekvő) és nagyobb képernyők (1024px-től) */
        @media (min-width: 1024px) {
            #blinds-content .form-grid { grid-template-columns: repeat(4, 1fr); }
            #screens-content .form-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* --- Reszponzív beállítások tabletekre (iPad) és nagyobb képenyőkre --- */
        @media (min-width: 768px) {
            #app-title {
                font-size: 2rem;
            }
            .tab-button {
                padding: 0.75rem 1.25rem;
                font-size: 1rem;
            }
            .input-group label {
                font-size: 0.9rem;
                margin-bottom: 0.4rem;
            }
            .input-field {
                padding: 0.9rem;
                font-size: 1rem;
            }
            .btn:not(.btn-icon) {
                padding: 1.1rem 2.2rem;
                font-size: 0.9rem;
            }
            .btn-small {
                 padding: 0.6rem 1.2rem;
                 font-size: 0.8rem;
            }
            #quote-items-body td, thead th {
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
                font-size: 0.95rem;
            }
            .quote-summary {
                font-size: 1.2rem;
            }
            .quote-summary #discount-percentage {
                 padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-6 lg:p-8">
    <div id="toast-container"></div>
    
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Megerősítés</h3>
            <p id="modal-text" class="mb-6 text-gray-600 dark:text-gray-300">Biztosan folytatja?</p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm-btn" class="btn btn-danger">Törlés</button>
                <button id="modal-cancel-btn" class="btn btn-secondary">Mégse</button>
            </div>
        </div>
    </div>

    <div id="pin-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="pin-modal-title" class="text-xl font-bold mb-4">PIN kód szükséges</h3>
            <p id="pin-modal-text" class="mb-4 text-gray-600 dark:text-gray-300">Kérjük, adja meg a PIN kódot az árak megtekintéséhez.</p>
            <input type="password" id="pin-input" class="input-field text-center mb-4" placeholder="****" inputmode="numeric">
            <p id="pin-error" class="text-red-500 text-sm mb-4 hidden">Helytelen PIN kód!</p>
            <div class="flex justify-center space-x-4">
                <button id="pin-submit-btn" class="btn btn-primary">Belépés</button>
                <button id="pin-cancel-btn" class="btn btn-secondary">Mégse</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-10 rounded-[32px] shadow-2xl">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-y-4">
            <div class="flex items-center space-x-4 min-w-0">
                <button id="refresh-btn" class="btn btn-icon btn-secondary" aria-label="Oldal frissítése" title="Oldal frissítése"><i class="fa-solid fa-arrows-rotate"></i></button>
                <img id="header-logo" src="" alt="Cég logója" class="h-16 w-auto hidden object-contain">
                <h1 id="app-title" class="text-3xl font-bold truncate">EUROPLAST</h1>
            </div>
            <div class="flex items-center justify-end flex-wrap gap-x-4 gap-y-2 flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <label id="language-label" class="text-sm font-medium text-light-text-color flex-shrink-0">Nyelv:</label>
                    <select id="language-select" class="input-field py-1 px-2 text-sm w-auto">
                        <option value="hu">Magyar</option>
                        <option value="ro">Română</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label id="currency-label" class="text-sm font-medium text-light-text-color flex-shrink-0">Pénznem:</label>
                    <select id="currency-select" class="input-field py-1 px-2 text-sm w-auto">
                        <option value="RON">RON</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--hover-bg-color)] transition-colors" aria-label="Téma váltása">
                    <i id="theme-icon" class="fa-solid fa-moon text-xl text-light-text-color"></i>
                </button>
            </div>
        </div>
        
        <div class="flex justify-center md:justify-start gap-3 mb-6 overflow-x-auto p-4">
            <button id="blinds-tab" class="tab-button active-style flex items-center space-x-2"><i class="fa-solid fa-window-maximize icon"></i><span>Redőnyök</span></button>
            <button id="screens-tab" class="tab-button flex items-center space-x-2"><i class="fa-solid fa-grip-lines-vertical icon"></i><span>Szúnyoghálók</span></button>
            <button id="quote-tab" class="tab-button flex items-center space-x-2"><i class="fa-solid fa-file-invoice icon"></i><span>Ajánlat</span></button>
            <button id="settings-tab" class="tab-button flex items-center space-x-2"><i class="fa-solid fa-cog icon"></i><span>Beállítások</span></button>
        </div>

        <div id="tab-content-container" class="rounded-2xl">
            <div id="blinds-content" class="tab-content active px-4 md:px-6 py-12 md:py-16">
                 <h2 id="blinds-heading" class="text-2xl font-bold mb-4">Redőny hozzáadása</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label id="blinds-width-label">Szélesség (mm):</label>
                        <input type="number" id="blinds-width" class="input-field" placeholder="1000" min="0">
                    </div>
                    <div class="input-group">
                        <label id="blinds-height-label">Magasság (mm):</label>
                        <input type="number" id="blinds-height" class="input-field" placeholder="1500" min="0">
                    </div>
                    <div class="input-group">
                        <label id="blinds-quantity-label">Darab:</label>
                        <input type="number" id="blinds-quantity" class="input-field" value="1" min="1">
                    </div>
                    <div class="input-group">
                        <label id="blinds-type-label">Típus:</label>
                        <select id="blinds-type" class="input-field">
                            <option value="pvc">PVC</option>
                            <option value="aluminium">Alumínium</option>
                            <option value="external-aluminium">Külső tokos alumínium</option>
                        </select>
                    </div>
                    <div class="input-group" id="blinds-color-group">
                        <label id="blinds-color-label">Szín:</label>
                        <select id="blinds-color" class="input-field"></select>
                    </div>
                    <div class="input-group">
                        <label id="blinds-control-label">Vezérlés:</label>
                        <select id="blinds-control" class="input-field">
                            <option value="string">Zsinóros</option>
                            <option value="strap">Gurtnis</option>
                            <option value="motorized">Motoros</option>
                        </select>
                    </div>
                    <div class="input-group" id="blinds-side-group">
                        <label id="blinds-side-label">Oldal:</label>
                        <select id="blinds-side" class="input-field">
                            <option value="right">Jobbos</option>
                            <option value="left">Balos</option>
                        </select>
                    </div>
                    <div class="input-group hidden" id="blinds-exit-type-group">
                        <label id="blinds-exit-type-label">Kivezetés:</label>
                        <select id="blinds-exit-type" class="input-field">
                            <option value="bottom">Alsó kivezetés</option>
                            <option value="top">Felső kivezetés</option>
                        </select>
                    </div>
                    <div class="input-group flex items-center mt-6">
                        <input type="checkbox" id="blinds-divided" class="mr-2 h-6 w-6 rounded-lg text-primary-color focus:ring-0">
                        <label id="blinds-divided-label" for="blinds-divided" class="input-label mb-0 cursor-pointer">Kettéosztott</label>
                    </div>
                    <div id="blinds-extender-frame-group" class="input-group flex items-center mt-6">
                        <input type="checkbox" id="blinds-extender-frame" class="mr-2 h-6 w-6 rounded-lg text-primary-color focus:ring-0">
                        <label id="blinds-extender-frame-label" for="blinds-extender-frame" class="input-label mb-0 cursor-pointer">Kiemelő keret</label>
                    </div>
                     <div id="integrated-screen-group" class="input-group mt-1">
                        <label id="blinds-integrated-screen-label" for="blinds-integrated-screen">Beépített szúnyogháló</label>
                        <select id="blinds-integrated-screen" class="input-field">
                            <option value="none">Nincs</option>
                            <option value="full">Teljes</option>
                            <option value="half">Fele</option>
                        </select>
                    </div>
                    <div id="blinds-division-details" class="col-span-full">
                        <div class="input-group">
                            <label id="blinds-division-side-label">Osztás oldala:</label>
                            <select id="blinds-division-side" class="input-field">
                                <option value="right">Jobb</option>
                                <option value="left">Bal</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label id="blinds-division-width-label">Mező szélessége (mm):</label>
                            <input type="number" id="blinds-division-width" class="input-field" placeholder="500" min="0">
                        </div>
                    </div>
                </div>
                <div id="add-blind-buttons-container" class="w-full mt-6 flex gap-4">
                    <button id="add-blind-btn" class="flex-grow btn btn-primary">Redőny Hozzáadása</button>
                    <button id="cancel-edit-blind-btn" class="hidden btn btn-secondary">Mégse</button>
                </div>
                <div id="blinds-summary-container" class="mt-8 pt-6 border-t border-[var(--input-border-color)]"></div>
            </div>
            <div id="screens-content" class="tab-content px-4 md:px-6 py-12 md:py-16">
                <h2 id="screens-heading" class="text-2xl font-bold mb-4">Szúnyogháló hozzáadása</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label id="screens-width-label">Szélesség (mm):</label>
                        <input type="number" id="screens-width" class="input-field" placeholder="1000" min="0">
                    </div>
                    <div class="input-group">
                        <label id="screens-height-label">Magasság (mm):</label>
                        <input type="number" id="screens-height" class="input-field" placeholder="1500" min="0">
                    </div>
                    <div class="input-group">
                        <label id="screens-quantity-label">Darab:</label>
                        <input type="number" id="screens-quantity" class="input-field" value="1" min="1">
                    </div>
                    <div class="input-group">
                        <label id="screens-type-label">Típus:</label>
                        <select id="screens-type" class="input-field">
                            <option value="fix">Fix háló</option>
                            <option value="balcony">Balamas háló</option>
                            <option value="mobile">Mobil háló</option>
                            <option value="plisse">Plissé háló</option>
                            <option value="door">Ajtó háló</option>
                            <option value="thin-door">Vékony ajtó háló</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label id="screens-color-label">Szín:</label>
                        <select id="screens-color" class="input-field"></select>
                    </div>
                    <div id="extender-frame-group" class="input-group flex items-center mt-2 hidden">
                        <input type="checkbox" id="screens-extender-frame" class="mr-2 h-6 w-6 rounded-lg text-primary-color focus:ring-0">
                        <label id="screens-extender-frame-label" for="screens-extender-frame" class="input-label mb-0 cursor-pointer">Kiemelő keret</label>
                    </div>
                </div>
                <div id="add-screen-buttons-container" class="w-full mt-6 flex gap-4">
                    <button id="add-screen-btn" class="flex-grow btn btn-primary">Szúnyogháló Hozzáadása</button>
                    <button id="cancel-edit-screen-btn" class="hidden btn btn-secondary">Mégse</button>
                </div>
                <div id="screens-summary-container" class="mt-8 pt-6 border-t border-[var(--input-border-color)]"></div>
            </div>
            <div id="quote-content" class="tab-content px-4 md:px-6 py-12 md:py-16">
                <!-- Sub-tabs for Quote/Order -->
                <div id="quote-sub-tabs" class="flex border-b border-[var(--input-border-color)] mb-6">
                    <button id="quote-details-sub-tab" class="sub-tab-button active-sub-style"></button>
                    <button id="order-sub-tab" class="sub-tab-button"></button>
                </div>

                <div id="quote-details-content" class="sub-tab-content active">
                    <h2 id="quote-heading" class="text-2xl font-bold mb-4">Ajánlat</h2>
                    
                    <div class="form-grid mb-6">
                         <div class="input-group">
                            <label id="quote-name-label" for="quote-name">Ajánlat neve:</label>
                            <input type="text" id="quote-name" class="input-field" placeholder="Pl. Lakásfelújítási projekt">
                        </div>
                         <div class="input-group">
                            <label id="client-name-label" for="client-name">Ügyfél neve:</label>
                            <input type="text" id="client-name" class="input-field" placeholder="Pl. Minta János">
                        </div>
                         <div class="input-group">
                            <label id="client-address-label" for="client-address">Ügyfél címe:</label>
                            <input type="text" id="client-address" class="input-field" placeholder="Pl. 1234 Minta, Fő utca 5.">
                        </div>
                         <div class="input-group">
                            <label id="client-phone-label" for="client-phone">Ügyfél telefonszáma:</label>
                            <input type="tel" id="client-phone" class="input-field" placeholder="Pl. +36 30 123 4567">
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full whitespace-nowrap table-auto">
                            <thead>
                                <tr class="text-left font-semibold table-header">
                                    <th id="table-product-th" class="px-4 py-2">Termék</th>
                                    <th id="table-size-th" class="px-4 py-2">Méret (mm)</th>
                                    <th id="table-area-th" class="px-4 py-2">m²</th>
                                    <th id="table-quantity-th" class="px-4 py-2">Darab</th>
                                    <th id="table-price-th" class="px-4 py-2">Egységár</th>
                                    <th id="table-subtotal-th" class="px-4 py-2">Részösszeg</th>
                                    <th id="table-actions-th" class="px-4 py-2 text-right">Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="quote-items-body" class="divide-y"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 border-t-2 pt-4 space-y-2 text-xl font-bold quote-summary">
                        <div class="flex justify-between items-center">
                            <span id="subtotal-text">Részösszeg:</span>
                            <span id="subtotal-price">0.00 RON</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label id="discount-label" for="discount-percentage" class="text-base font-medium">Kedvezmény (%):</label>
                            <input type="number" id="discount-percentage" class="input-field w-24 text-right py-1" value="0" min="0" max="100">
                        </div>
                        <div id="discount-row" class="hidden flex justify-between items-center text-red-500">
                            <span id="discount-amount-text">Kedvezmény:</span>
                            <span id="discount-amount">-0.00 RON</span>
                        </div>
                        <div class="flex justify-between items-center border-t pt-2 mt-2">
                            <span id="total-text">Végösszeg:</span>
                            <span id="total-price">0.00 RON</span>
                        </div>
                    </div>
                    <div class="mt-8 flex flex-col items-end gap-4">
                        <button id="preview-quote-btn" class="btn btn-primary w-full sm:w-auto"></button>
                        <div class="flex flex-wrap gap-3 justify-end">
                            <button id="save-quote-btn" class="btn btn-secondary flex-grow sm:flex-grow-0"></button>
                            <button id="load-quotes-btn" class="btn btn-tertiary flex-grow sm:flex-grow-0"></button>
                            <button id="new-quote-btn" class="btn btn-danger flex-grow sm:flex-grow-0"></button>
                        </div>
                    </div>
                     <div id="load-quote-section" class="relative transition-all duration-300 shadow-md rounded-2xl">
                        <h3 id="load-quote-heading" class="text-xl font-bold mb-4">Mentett ajánlatok</h3>
                        <button id="close-load-quote-btn" class="absolute top-3 right-3 btn btn-icon btn-secondary" aria-label="Bezárás"><i class="fa-solid fa-times"></i></button>
                        <div class="relative mb-4">
                            <input type="search" id="quote-search-input" class="input-field pl-10" placeholder="Keresés név vagy ügyfél alapján...">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <ul id="saved-quotes-list" class="space-y-2 max-h-80 overflow-y-auto"></ul>
                    </div>
                </div>

                <div id="order-content" class="sub-tab-content">
                    <h3 id="order-heading" class="text-xl font-bold mb-4"></h3>
                    <p id="order-description" class="mb-6 text-light-text-color"></p>
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full whitespace-nowrap table-auto">
                            <thead>
                                <tr class="text-left font-semibold table-header">
                                    <th id="order-table-product-th" class="px-4 py-2"></th>
                                    <th id="order-table-size-th" class="px-4 py-2"></th>
                                    <th id="order-table-details-th" class="px-4 py-2"></th>
                                    <th id="order-table-color-th" class="px-4 py-2"></th>
                                    <th id="order-table-quantity-th" class="px-4 py-2"></th>
                                </tr>
                            </thead>
                            <tbody id="order-items-body" class="divide-y"></tbody>
                        </table>
                    </div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <button id="generate-order-pdf-btn" class="btn btn-primary w-full sm:w-auto"></button>
                        <div class="flex items-center space-x-2">
                            <label id="order-language-label" class="text-sm font-medium"></label>
                            <select id="order-language-select" class="input-field py-1 px-2 text-sm">
                                <option value="hu">Magyar</option>
                                <option value="ro">Română</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

            </div>
            
            <div id="settings-content" class="tab-content px-4 md:px-6 py-12 md:py-16">
                <h2 id="settings-heading" class="text-2xl font-bold mb-4">Beállítások</h2>

                <!-- Sub-tabs for Settings -->
                <div id="settings-sub-tabs" class="flex border-b border-[var(--input-border-color)] mb-6">
                    <button id="general-settings-sub-tab" class="sub-tab-button active-sub-style"></button>
                    <button id="prices-settings-sub-tab" class="sub-tab-button"></button>
                </div>
        
                <!-- General Settings Content -->
                <div id="general-settings-content" class="sub-tab-content active">
                    <div class="form-grid">
                        <div class="space-y-6">
                            <h3 class="text-xl font-bold">Cég adatai</h3>
                            <div class="input-group">
                                <label id="company-name-label" for="company-name">Cég neve:</label>
                                <input type="text" id="company-name" class="input-field" placeholder="Cég Kft.">
                            </div>
                            <div class="input-group">
                                <label id="company-website-label" for="company-website">Weboldal:</label>
                                <input type="text" id="company-website" class="input-field" placeholder="www.ceg-oldala.hu">
                            </div>
                             <div class="input-group">
                                <label id="company-email-label" for="company-email">Email cím:</label>
                                <input type="email" id="company-email" class="input-field" placeholder="info@ceg-oldala.hu">
                            </div>
                             <div class="input-group">
                                <label id="company-phone-label" for="company-phone">Telefonszám:</label>
                                <input type="tel" id="company-phone" class="input-field" placeholder="+36 30 123 4567">
                            </div>
                        </div>
                         <div class="space-y-6">
                            <h3 class="text-xl font-bold">Vizuális elemek</h3>
                             <div class="input-group">
                                <label id="company-logo-label">Cég logó:</label>
                                <input type="file" id="company-logo-input" class="hidden" accept="image/*">
                                <label for="company-logo-input" class="input-field cursor-pointer flex items-center justify-center border-dashed border-2 h-48">
                                    <span id="logo-upload-text">Kattintson a logó feltöltéséhez</span>
                                </label>
                                <img id="logo-preview" src="" class="mt-4 h-24 w-auto hidden rounded-lg shadow-md object-contain" alt="Logó előnézet">
                                <button id="delete-logo-btn" class="btn btn-danger btn-small mt-2 hidden">Logó törlése</button>
                            </div>
                        </div>
                    </div>
    
                    <button id="save-settings-btn" class="w-full md:w-auto mt-8 btn btn-primary">Beállítások mentése</button>
                    
                    <div class="mt-8 pt-6 border-t border-[var(--input-border-color)]">
                        <h3 id="data-management-heading" class="text-xl font-bold mb-4">Adatkezelés</h3>
                        <div id="data-loss-warning" class="p-4 mb-4 rounded-lg bg-yellow-100 dark:bg-yellow-900 border border-yellow-300 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200 flex items-start gap-3">
                            <i class="fa-solid fa-triangle-exclamation mt-1"></i>
                            <p id="data-management-desc" class="text-sm">Minden adat a böngészőjében tárolódik. A böngésző gyorsítótárának törlése az összes mentett ajánlat és beállítás elvesztésével járhat. **Javasoljuk az adatok rendszeres exportálását!**</p>
                        </div>
                        <div class="flex flex-wrap gap-4">
                            <button id="export-data-btn" class="btn btn-secondary">Adatok Exportálása</button>
                            <button id="import-data-btn" class="btn btn-tertiary">Adatok Importálása</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json,application/json">
                        </div>
                    </div>
                </div>

                <!-- Prices Settings Content -->
                <div id="prices-settings-content" class="sub-tab-content">
                    <div id="prices-container" class="space-y-6"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ALKALMAZÁS LOGIKA ---
        // --- DATA & STATE ---
        // Polyfill
        if (typeof crypto.randomUUID === 'undefined') {
            crypto.randomUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); });
        }
        
        // A PIN kódot itt lehet beállítani.
        const PIN_CODE = "1234";

        function promptForPin() {
            return new Promise((resolve) => {
                const modal = $('#pin-modal');
                const pinInput = $('#pin-input');
                const pinError = $('#pin-error');
                const submitBtn = $('#pin-submit-btn');
                const cancelBtn = $('#pin-cancel-btn');

                pinInput.value = '';
                pinError.classList.add('hidden');
                modal.classList.add('active');

                const handlePinSubmit = () => {
                    if (pinInput.value === PIN_CODE) {
                        modal.classList.remove('active');
                        resolve(true);
                        pinInput.removeEventListener('keydown', handleKeyDown);
                        submitBtn.removeEventListener('click', handlePinSubmit);
                        cancelBtn.removeEventListener('click', handlePinCancel);
                    } else {
                        pinError.classList.remove('hidden');
                        pinInput.value = '';
                    }
                };

                const handlePinCancel = () => {
                     modal.classList.remove('active');
                     resolve(false);
                     pinInput.removeEventListener('keydown', handleKeyDown);
                     submitBtn.removeEventListener('click', handlePinSubmit);
                     cancelBtn.removeEventListener('click', handlePinCancel);
                };

                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        handlePinSubmit();
                    }
                }
                
                pinInput.addEventListener('keydown', handleKeyDown);
                submitBtn.addEventListener('click', handlePinSubmit);
                cancelBtn.addEventListener('click', handlePinCancel);
            });
        }

        const translations = {
             hu: {
                languageLabel: "Nyelv:", currencyLabel: "Pénznem:", orderLanguageLabel: "PDF Nyelve:",
                blindsTab: "Redőnyök", screensTab: "Szúnyoghálók", quoteTab: "Ajánlat", settingsTab: "Beállítások",
                generalSettingsSubTab: "Általános", pricesSettingsSubTab: "Árak",
                quoteDetailsSubTab: "Ajánlat Részletei", orderSubTab: "Megrendelés",
                orderHeading: "Redőnyök Megrendelése",
                orderDescription: "Itt legenerálhatja a gyártáshoz szükséges megrendelőlapot a jelenlegi ajánlatban szereplő összes redőnyről.",
                generateOrderPdfBtn: "Megrendelő PDF Generálása",
                orderPdfTitle: "Redőny Megrendelés", noBlindsInQuote: "Nincsenek redőnyök az ajánlatban.",
                blindsHeading: "Redőny hozzáadása", blindsTypeLabel: "Típus:", blindsWidthLabel: "Szélesség (mm):",
                blindsHeightLabel: "Magasság (mm):", blindsQuantityLabel: "Darab:", blindsColorLabel: "Szín:",
                blindsControlLabel: "Vezérlés:", blindsDividedLabel: "Kettéosztott",
                blindsIntegratedScreenLabel: "Beépített szúnyogháló", screenOptionNone: "Nincs", screenOptionFull: "Teljes",
                screenOptionHalf: "Fele", addBlindBtn: "Redőny Hozzáadása",
                screensHeading: "Szúnyogháló hozzáadása", screensTypeLabel: "Típus:", screensWidthLabel: "Lățime (mm):",
                screensHeightLabel: "Magasság (mm):", screensQuantityLabel: "Darab:", screensColorLabel: "Szín:",
                addScreenBtn: "Szúnyogháló Hozzáadása", pricesHeading: "Árbeállítások", blindsPrices: "Redőny Árak",
                screensPrices: "Szúnyogháló Árak", basePricesM2: "Alapárak (ár / m²)", surcharges: "Felárak",
                colorSurcharges: "Színfelárak - Alumínium (%)", externalColorSurcharges: "Színfelárak - Külső tokos (%)",
                screenBasePricesM2: "Alapárak (ár / m²)", screenColorSurcharges: "Színfelárak (%)",
                unit_currency_pc: " / db", quoteHeading: "Ajánlat", settingsHeading: "Beállítások",
                companyNameLabel: "Cég neve:", companyLogoLabel: "Cég logó:", saveSettingsBtn: "Beállítások mentése",
                settingsSavedMessage: "A beállítások sikeresen elmentve!", tableProductTh: "Termék",
                tableSizeTh: "Méret (mm)", tableQuantityTh: "Darab", tablePriceTh: "Egységár",
                tableSubtotalTh: "Részösszeg", tableActionsTh: "Műveletek", subtotalText: "Részösszeg:",
                discountLabel: "Kedvezmény (%):", discountAmountText: "Kedvezmény:", totalText: "Végösszeg:",
                saveQuoteBtn: "Ajánlat mentése", loadQuotesBtn: "Mentett ajánlatok", newQuoteBtn: "Új ajánlat",
                quoteNameLabel: "Ajánlat neve:", loadQuoteHeading: "Mentett ajánlatok",
                deleteBtn: "Törlés", editBtn: "Szerkesztés", savePriceBtn: "Árak mentése", priceSavedMessage: "Árak sikeresen elmentve!",
                productAddedMessage: "A termék sikeresen hozzáadva az ajánlathoz!",
                productUpdatedMessage: "A tétel sikeresen módosítva!",
                emptyFieldsError: "Kérjük, töltse ki a kötelező mezőket!",
                invalidSizeError: "Kérjük, érvényes méreteket adjon meg (pozitív szám).",
                invalidQuantityError: "Kérjük, érvényes darabszámot adjon meg (pozitív egész szám).",
                invalidDivisionWidthError: "Az osztás szélessége nem lehet nagyobb, mint a teljes szélesség.",
                quoteSaved: "Ajánlat sikeresen elmentve!", 
                quoteLoaded: "Az ajánlat sikeresen betöltve!",
                quoteDeleted: "Az ajánlat sikeresen törölve!",
                quoteNameRequired: "Kérjük, adjon meg egy nevet az ajánlatnak a mentéshez!",
                noQuotesFound: "Nincsenek mentett ajánlatok.", noItemsInQuote: "Az ajánlat üres.",
                deleteQuotePromptTitle: "Ajánlat törlése",
                deleteQuotePromptText: "Biztosan törli a(z) '{{name}}' nevű ajánlatot?",
                newQuotePromptTitle: "Új ajánlat kezdése",
                newQuotePromptText: "Biztosan új, üres ajánlatot szeretne kezdeni? A jelenlegi, nem mentett módosítások elvesznek.",
                newQuoteStarted: "Új, üres ajánlat kezdődött.",
                minAreaWarning: "Figyelem: A minimális számlázott terület {{area}} m².",
                pvcColorError: "A PVC redőny csak fehér színben kapható.",
                logoUploadText: "Kattintson a logó feltöltéséhez",
                deleteLogoBtn: "Logó törlése",
                logoDeletedMessage: "A logó sikeresen törölve!",
                dataManagementHeading: "Adatkezelés",
                dataManagementDesc: "Minden adat a böngészőjében tárolódik. A böngésző gyorsítótárának törlése az összes mentett ajánlat és beállítás elvesztésével járhat. **Javasoljuk az adatok rendszeres exportálását!**",
                exportDataBtn: "Adatok Exportálása",
                importDataBtn: "Adatok Importálása",
                importSuccess: "Az adatok sikeresen importálva! Az oldal 2 másodperc múlva frissül.",
                importError: "Hiba az importálás során. Kérjük, ellenőrizze a fájl formátumát.",
                previewQuoteBtn: "Ajánlat Megtekintése",
                quotePreviewTitle: "Árajánlat Előnézet",
                generatePdfBtn: "PDF generálása",
                generateJpgBtn: "JPG generálása",
                sharePdfBtn: "PDF Megosztása",
                shareJpgBtn: "JPG Megosztása",
                sendQuoteBtn: "Email küldése",
                sendQuoteEmailBody: "Tisztelt Érdeklődő!\n\nCsatolva küldjük a(z) '{{quoteName}}' nevű árajánlatot.\n\nAz ajánlat végösszege: {{totalPrice}}\n\nAmennyiben kérdéése merülne fel, keressen bizalommal.\n\nÜdvözlettel,\n{{companyName}}",
                exchangeRateTitle: "EUR/RON Árfolyam",
                vatIncludedText: "Az ár tartalmazza az ÁFÁ-t.",
                quoteSummaryTitle: "Ajánlat Összegzés",
                summaryTotal: "Összesen",
                divisionSideLabel: "Osztás oldala", divisionWidthLabel: "Mező szélessége (mm)",
                sideLeft: "Balos", sideRight: "Jobbos",
                companyWebsiteLabel: "Weboldal:", companyEmailLabel: "Email cím:", companyPhoneLabel: "Telefonszám:",
                clientNameLabel: "Ügyfél neve:", clientAddressLabel: "Ügyfél címe:", clientPhoneLabel: "Ügyfél telefonszáma:",
                tableAreaTh: "m²",
                updateItemBtn: "Tétel módosítása", cancelEditBtn: "Mégse",
                searchPlaceholder: "Keresés név vagy ügyfél alapján...",
                extenderFrameLabel: "Kiemelő keret", extenderFramePrice: "Kiemelő keret (ár / m)",
                blindsExtenderFrameLabel: "Kiemelő keret", blindsExtenderFramePrice: "Redőny kiemelő (ár / m)",
                pinModalTitle: "PIN kód szükséges",
                pinModalText: "Kérjük, adja meg a PIN kódot az árak megtekintéséhez.",
                pinSubmitBtn: "Belépés",
                pinError: "Helytelen PIN kód!",
                closeBtn: "Bezárás",
                minAreaSettings: "Minimális Terület Számítás",
                blindsExitTypeLabel: "Kivezetés:",
                blindsSideLabel: "Oldal:",
                exitTypeBottom: "Alsó kivezetés",
                exitTypeTop: "Felső kivezetés",
                minAreaLabels: {
                    blinds: "Redőnyök (m²)",
                    screens: "Szúnyoghálók (általános, m²)",
                    door_screen: "Ajtó szúnyogháló (m²)",
                    half_screen: "Fél beépített szúnyogháló (m²)",
                    plisse: "Pliszé szúnyogháló (m²)",
                    mobile: "Mobil szúnyogháló (m²)"
                },
                productNames: { pvc: "PVC redőny", aluminium: "Alumínium redőny", "external-aluminium": "Külső tokos alumínium redőny", motorized: "Motor", automata: "Automata", divided: "Kettéosztott felár", divided_blind: "Redőny osztás", divided_external: "Külső tokos osztás", integrated_screen: "Beépített szúnyogháló (ár/m²)", integrated_screen_full: "Teljes szúnyogháló", integrated_screen_half: "Fél szúnyogháló", anthracite: "Antracit", special: "Speciális szín", fix: "Fix háló", balcony: "Balamas háló", mobile: "Mobil háló", plisse: "Plissé háló", door: "Ajtó háló", "thin-door": "Vékony ajtó háló", white: "Fehér", brown: "Barna", gray: "Szürke", dark_brown: "Sötétbarna", light_brown: "Világosbarna", golden_oak: "Aranytölgy", walnut: "Dió", mahogany: "Mahagóni", extender_frame: "Kiemelő keret", blinds_extender_frame: "Kiemelő keret (redőny)", string: "Zsinóros", strap: "Gurtnis", bottom_exit: "Alsó kivezetés", top_exit: "Felső kivezetés" }
            },
            ro: {
                languageLabel: "Limbă:", currencyLabel: "Monedă:", orderLanguageLabel: "Limbă PDF:",
                blindsTab: "Jaluzele", screensTab: "Plase de insecte", quoteTab: "Ofertă", settingsTab: "Setări", 
                generalSettingsSubTab: "Generale", pricesSettingsSubTab: "Prețuri",
                quoteDetailsSubTab: "Detalii Ofertă", orderSubTab: "Comandă",
                orderHeading: "Comandă Jaluzele",
                orderDescription: "Aici puteți genera formularul de comandă pentru producție pentru toate jaluzelele din oferta curentă.",
                generateOrderPdfBtn: "Generează PDF Comandă",
                orderTableProductTh: "Produs", orderTableSizeTh: "Dimensiune", orderTableDetailsTh: "Detalii", orderTableColorTh: "Culoare", orderTableQuantityTh: "Bucăți",
                orderPdfTitle: "Comandă Jaluzele", noBlindsInQuote: "Nu există jaluzele în ofertă.",
                blindsHeading: "Adăugare jaluzea", blindsTypeLabel: "Tip:", blindsWidthLabel: "Lățime (mm):", blindsHeightLabel: "Înălțime (mm):", blindsQuantityLabel: "Bucăți:", blindsColorLabel: "Culoare:", blindsControlLabel: "Control:", blindsDividedLabel: "Divizat", blindsIntegratedScreenLabel: "Plasă de insecte integrată", screenOptionNone: "Niciuna", screenOptionFull: "Completă", screenOptionHalf: "Jumătate", addBlindBtn: "Adaugă Jaluzea", screensHeading: "Adăugare plasă de insecte", screensTypeLabel: "Tip:", screensWidthLabel: "Lățime (mm):", screensHeightLabel: "Înălțime (mm):", screensQuantityLabel: "Bucăți:", screensColorLabel: "Culoare:", addScreenBtn: "Adaugă Plasă", pricesHeading: "Setări Prețuri", blindsPrices: "Prețuri Jaluzele", screensPrices: "Prețuri Plase de Insecte", basePricesM2: "Prețuri de bază (preț / m²)", surcharges: "Suprataxe", colorSurcharges: "Suprataxe Culoare - Aluminiu (%)", externalColorSurcharges: "Suprataxe Culoare - Exterior (%)", screenBasePricesM2: "Prețuri de bază (preț / m²)", screenColorSurcharges: "Suprataxe Culoare (%)", unit_currency_pc: " / buc", quoteHeading: "Ofertă", settingsHeading: "Setări", companyNameLabel: "Nume Companie:", companyLogoLabel: "Logo Companie:", saveSettingsBtn: "Salvează Setările", settingsSavedMessage: "Setările au fost salvate cu succes!", tableProductTh: "Produs", tableSizeTh: "Dimensiune (mm)", tableQuantityTh: "Bucăți", tablePriceTh: "Preț Unitar", tableSubtotalTh: "Subtotal", tableActionsTh: "Acțiuni", subtotalText: "Subtotal:", discountLabel: "Reducere (%):", discountAmountText: "Reducere:", totalText: "Total Final:", saveQuoteBtn: "Salvează Oferta", loadQuotesBtn: "Încarcă Oferte", newQuoteBtn: "Ofertă Nouă", quoteNameLabel: "Nume Ofertă:", loadQuoteHeading: "Oferte Salvate", deleteBtn: "Șterge", editBtn: "Editare", savePriceBtn: "Salvează Prețurile", priceSavedMessage: "Prețurile au fost salvate cu succes!", productAddedMessage: "Produsul a fost adăugat cu succes la ofertă!", productUpdatedMessage: "Articolul a fost modificat cu succes!", emptyFieldsError: "Vă rugăm să completați câmpurile obligatorii!", invalidSizeError: "Vă rugăm să introduceți dimensiuni valide (număr pozitiv).", invalidQuantityError: "Vă rugăm să introduceți o cantitate validă (număr întreg pozitiv).", invalidDivisionWidthError: "Lățimea diviziunii nu poate fi mai mare decât lățimea totală.", quoteSaved: "Oferta a fost salvată!", quoteLoaded: "Oferta a fost încărcată cu succes!", quoteDeleted: "Oferta a fost ștearsă cu succes!", quoteNameRequired: "Vă rugăm să introduceți un nume pentru ofertă pentru a o salva!", noQuotesFound: "Nicio ofertă salvată.", noItemsInQuote: "Oferta este goală.", deleteQuotePromptTitle: "Șterge Oferta", deleteQuotePromptText: "Sigur doriți să ștergeți oferta '{{name}}'?", newQuotePromptTitle: "Începe Ofertă Nouă", newQuotePromptText: "Sigur doriți să începeți o ofertă nouă, goală? Modificările nesalvate se vor pierde.", newQuoteStarted: "O nouă ofertă goală a fost începută.", minAreaWarning: "Atenție: Suprafața minimă facturată este de {{area}} m².", pvcColorError: "Jaluzelele din PVC sunt disponibile doar pe alb.", logoUploadText: "Faceți clic pentru a încărca logo-ul", deleteLogoBtn: "Șterge Logo", logoDeletedMessage: "Logo-ul a fost șters cu succes!",
                dataManagementHeading: "Gestionarea Datelor", dataManagementDesc: "Toate datele sunt stocate în browser. Ștergerea memoriei cache a browserului poate duce la pierderea tuturor ofertelor și setărilor salvate. **Recomandăm exportarea regulată a datelor!**",
                exportDataBtn: "Export Date", importDataBtn: "Import Date", importSuccess: "Datele au fost importate cu succes! Pagina se va reîncărca în 2 secunde.",
                importError: "Eroare la import. Vă rugăm să verificați formatul fișierului.",
                previewQuoteBtn: "Vizualizare Ofertă", quotePreviewTitle: "Previzualizare Ofertă",
                generatePdfBtn: "Generează PDF",
                generateJpgBtn: "Generează JPG",
                sharePdfBtn: "Partajare PDF",
                shareJpgBtn: "Partajare JPG",
                sendQuoteBtn: "Trimite Email",
                sendQuoteEmailBody: "Dear Sir/Madam,\n\nPlease find the quote '{{quoteName}}' attached.\n\nThe total amount for the offer is: {{totalPrice}}\n\nIf you have any questions, please feel free to contact us.\n\nBest regards,\n{{companyName}}",
                exchangeRateTitle: "Curs Valutar EUR/RON", vatIncludedText: "The price includes TVA.", quoteSummaryTitle: "Rezumat Ofertă",
                summaryTotal: "Total", divisionSideLabel: "Partea divizată", divisionWidthLabel: "Lățime secțiune (mm)",
                sideLeft: "Stânga", sideRight: "Dreapta", companyWebsiteLabel: "Site web:", companyEmailLabel: "Email:", companyPhoneLabel: "Telefon:",
                clientNameLabel: "Nume Client:", clientAddressLabel: "Adresă Client:", clientPhoneLabel: "Telefon Client:",
                tableAreaTh: "m²", updateItemBtn: "Modifică Articol", cancelEditBtn: "Anulează",
                searchPlaceholder: "Căutare după nume sau client...",
                extenderFrameLabel: "Cadru de extensie", extenderFramePrice: "Cadru de extensie (preț / m)",
                blindsExtenderFrameLabel: "Cadru de extensie", blindsExtenderFramePrice: "Cadru de extensie jaluzea (preț / m)",
                pinModalTitle: "Cod PIN necesar",
                pinModalText: "Vă rugăm să introduceți codul PIN pentru a vizualiza prețurile.",
                pinSubmitBtn: "Intră",
                pinError: "Cod PIN incorect!",
                closeBtn: "Închide",
                minAreaSettings: "Calcul Suprafață Minimă",
                blindsExitTypeLabel: "Tip ieșire:",
                blindsSideLabel: "Partea:",
                exitTypeBottom: "Ieșire inferioară",
                exitTypeTop: "Ieșire superioară",
                minAreaLabels: {
                    blinds: "Jaluzele (m²)",
                    screens: "Plase de insecte (general, m²)",
                    door_screen: "Plasă de insecte ușă (m²)",
                    half_screen: "Jumătate de plasă integrată (m²)",
                    plisse: "Plasă plisse (m²)",
                    mobile: "Plasă mobilă (m²)"
                },
                productNames: { pvc: "Jaluzea PVC", aluminium: "Jaluzea Aluminiu", "external-aluminium": "Jaluzea exterioară din aluminiu", motorized: "Motor", automata: "Automat", divided: "Taxă divizare", divided_blind: "Divizare jaluzea", divided_external: "Divizare jaluzea exterioară", integrated_screen: "Plasă de insecte integrată (preț/m²)", integrated_screen_full: "Plasă de insecte completă", integrated_screen_half: "Jumătate de plasă de insecte", anthracite: "Antracit", special: "Culoare specială", fix: "Plasă fixă", balcony: "Plasă cu balamale", mobile: "Plasă mobilă", plisse: "Plasă plisse", door: "Plasă ușă", "thin-door": "Plasă subțire ușă", white: "Alb", brown: "Maro", gray: "Gri", dark_brown: "Maro închis", light_brown: "Maro deschis", golden_oak: "Stejar auriu", walnut: "Nuc", mahogany: "Mahon", extender_frame: "Cadru de extensie", blinds_extender_frame: "Cadru de extensie (jaluzea)", string: "Cu șnur", strap: "Cu chingă", bottom_exit: "Ieșire inferioară", top_exit: "Ieșire superioară" }
            },
            en: {
                languageLabel: "Language:", currencyLabel: "Currency:", orderLanguageLabel: "PDF Language:",
                blindsTab: "Blinds", screensTab: "Insect Screens", quoteTab: "Quote", settingsTab: "Settings",
                generalSettingsSubTab: "General", pricesSettingsSubTab: "Prices",
                quoteDetailsSubTab: "Quote Details", orderSubTab: "Order",
                orderHeading: "Order Blinds",
                orderDescription: "Here you can generate the production order form for all blinds in the current quote.",
                generateOrderPdfBtn: "Generate Order PDF",
                orderTableProductTh: "Product", orderTableSizeTh: "Size", orderTableDetailsTh: "Details", orderTableColorTh: "Color", orderTableQuantityTh: "Quantity",
                orderPdfTitle: "Blinds Order", noBlindsInQuote: "There are no blinds in the quote.",
                blindsHeading: "Add Blind", blindsTypeLabel: "Type:", blindsWidthLabel: "Width (mm):", blindsHeightLabel: "Height (mm):", blindsQuantityLabel: "Quantity:", blindsColorLabel: "Color:", blindsControlLabel: "Control:", blindsDividedLabel: "Divided", blindsIntegratedScreenLabel: "Integrated insect screen", screenOptionNone: "None", screenOptionFull: "Full", screenOptionHalf: "Half", addBlindBtn: "Add Blind", screensHeading: "Add Insect Screen", screensTypeLabel: "Type:", screensWidthLabel: "Width (mm):", screensHeightLabel: "Height (mm):", screensQuantityLabel: "Quantity:", screensColorLabel: "Color:", addScreenBtn: "Add Screen", pricesHeading: "Price Settings", blindsPrices: "Blinds Prices", screensPrices: "Insect Screen Prices", basePricesM2: "Base Prices (price / m²)", surcharges: "Surcharges", colorSurcharges: "Color Surcharges - Aluminium (%)", externalColorSurcharges: "Color Surcharges - External (%)", screenBasePricesM2: "Base Prices (price / m²)", screenColorSurcharges: "Color Surcharges (%)", unit_currency_pc: " / pc", quoteHeading: "Quote", settingsHeading: "Settings", companyNameLabel: "Company Name:", companyLogoLabel: "Company Logo:", saveSettingsBtn: "Save Settings", settingsSavedMessage: "Settings saved successfully!", tableProductTh: "Product", tableSizeTh: "Size (mm)", tableQuantityTh: "Quantity", tablePriceTh: "Unit Price", tableSubtotalTh: "Subtotal", tableActionsTh: "Actions", subtotalText: "Subtotal:", discountLabel: "Discount (%):", discountAmountText: "Discount:", totalText: "Grand Total:", saveQuoteBtn: "Save Quote", loadQuotesBtn: "Load Quotes", newQuoteBtn: "New Quote", quoteNameLabel: "Quote Name:", loadQuoteHeading: "Saved Quotes", deleteBtn: "Delete", editBtn: "Edit", savePriceBtn: "Save Prices", priceSavedMessage: "Prices saved successfully!", productAddedMessage: "Product successfully added to the quote!", productUpdatedMessage: "Item successfully updated!", emptyFieldsError: "Please fill in the required fields!", invalidSizeError: "Please enter valid dimensions (positive number).", invalidQuantityError: "Please enter a valid quantity (positive integer).", invalidDivisionWidthError: "Division width cannot be greater than the total width.", quoteSaved: "Quote saved!", quoteLoaded: "Quote loaded successfully!", quoteDeleted: "Quote deleted successfully!", quoteNameRequired: "Please enter a name for the quote to save it!", noQuotesFound: "No saved quotes.", noItemsInQuote: "The quote is empty.", deleteQuotePromptTitle: "Delete Quote", deleteQuotePromptText: "Are you sure you want to delete the quote '{{name}}'?", newQuotePromptTitle: "Start New Quote", newQuotePromptText: "Are you sure you want to start a new, empty quote? Any unsaved changes will be lost.", newQuoteStarted: "Started a new, empty quote.", minAreaWarning: "Warning: The minimum billed area is {{area}} m².", pvcColorError: "PVC blinds are only available in white.", logoUploadText: "Click to upload logo", deleteLogoBtn: "Delete Logo", logoDeletedMessage: "Logo deleted successfully!",
                dataManagementHeading: "Data Management", dataManagementDesc: "All data is stored in your browser. Clearing your browser's cache may result in the loss of all saved quotes and settings. **We recommend exporting your data regularly!**",
                exportDataBtn: "Export Data", importDataBtn: "Import Data", importSuccess: "Data imported successfully! The page will reload in 2 seconds.",
                importError: "Error during import. Please check the file format.",
                previewQuoteBtn: "Preview Quote", quotePreviewTitle: "Quote Preview",
                generatePdfBtn: "Generate PDF",
                generateJpgBtn: "Generate JPG",
                sharePdfBtn: "Share PDF",
                shareJpgBtn: "Share JPG",
                sendQuoteBtn: "Send Email",
                sendQuoteEmailBody: "Dear Sir/Madam,\n\nPlease find the quote '{{quoteName}}' attached.\n\nThe total amount for the offer is: {{totalPrice}}\n\nIf you have any questions, please feel free to contact us.\n\nBest regards,\n{{companyName}}",
                exchangeRateTitle: "EUR/RON Exchange Rate", vatIncludedText: "The price includes VAT.", quoteSummaryTitle: "Quote Summary",
                summaryTotal: "Total", divisionSideLabel: "Division Side", divisionWidthLabel: "Section Width (mm)",
                sideLeft: "Left", sideRight: "Right", companyWebsiteLabel: "Website:", companyEmailLabel: "Email:", companyPhoneLabel: "Phone:",
                clientNameLabel: "Client Name:", clientAddressLabel: "Client Address:", clientPhoneLabel: "Client Phone:",
                tableAreaTh: "m²", updateItemBtn: "Update Item", cancelEditBtn: "Cancel",
                searchPlaceholder: "Search by name or client...",
                extenderFrameLabel: "Extender frame", extenderFramePrice: "Extender frame (price / m)",
                blindsExtenderFrameLabel: "Extender frame", blindsExtenderFramePrice: "Blind extender frame (price / m)",
                pinModalTitle: "PIN Code Required",
                pinModalText: "Please enter the PIN code to view prices.",
                pinSubmitBtn: "Enter",
                pinError: "Incorrect PIN code!",
                closeBtn: "Close",
                minAreaSettings: "Minimum Area Calculation",
                blindsExitTypeLabel: "Exit Type:",
                blindsSideLabel: "Side:",
                exitTypeBottom: "Bottom Exit",
                exitTypeTop: "Top Exit",
                minAreaLabels: {
                    blinds: "Blinds (m²)",
                    screens: "Insect Screens (general, m²)",
                    door_screen: "Door Insect Screen (m²)",
                    half_screen: "Half Integrated Screen (m²)",
                    plisse: "Plisse Screen (m²)",
                    mobile: "Mobile Screen (m²)"
                },
                productNames: { pvc: "PVC blind", aluminium: "Aluminium blind", "external-aluminium": "External aluminium blind", motorized: "Motor", automata: "Automatic", divided: "Divided surcharge", divided_blind: "Blind division", divided_external: "External blind division", integrated_screen: "Integrated insect screen (price/m²)", integrated_screen_full: "Full insect screen", integrated_screen_half: "Half insect screen", anthracite: "Antracite", special: "Special color", fix: "Fix screen", balcony: "Hinged screen", mobile: "Mobile screen", plisse: "Plisse screen", door: "Door screen", "thin-door": "Thin door screen", white: "White", brown: "Brown", gray: "Gray", dark_brown: "Dark brown", light_brown: "Light brown", golden_oak: "Golden oak", walnut: "Walnut", mahogany: "Mahagóni", extender_frame: "Extender frame", blinds_extender_frame: "Extender frame (blind)", string: "String", strap: "Strap", bottom_exit: "Bottom exit", top_exit: "Top exit" }
            }
        };

        const defaultPrices = {
            blinds: { pvc: 100, aluminium: 150, motorized: 150, divided: 50, integrated_screen: 70, extender_frame_price_pm: 30 },
            blinds_percentages: { golden_oak: 15, walnut: 15, anthracite: 10, special: 20 },
            blinds_extras: { automata: 25 },
            "external-aluminium": { base: 180, divided: 60 },
            external_aluminium_colors: { gray: 5, dark_brown: 5, light_brown: 5, golden_oak: 15, walnut: 15, mahogany: 15, special: 25 },
            screens: { fix: 50, balcony: 70, mobile: 80, plisse: 120, door: 100, "thin-door": 110, extender_frame_price_pm: 25 },
            screens_percentages: { golden_oak: 25, walnut: 25, anthracite: 20, special: 30 }
        };

        const defaultMinAreas = { 
            blinds: 1.3, screens: 0.8, door_screen: 1.8, 
            half_screen: 0.9, plisse: 1.0, mobile: 1.0 
        };

        // --- APPLICATION STATE & DATA ---
        let userPrices, allSavedQuotes;
        let quoteItems = [];
        let editingItemIndex = null; // To track which item is being edited
        let currentLanguage = 'hu', currentCurrency = 'RON', exchangeRate = 5.0;
        let currentPrices = {}; // Always in RON
        let minAreas = {};
        
        // --- UTILITY & CORE FUNCTIONS ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // BIZTONSÁGI FUNKCIÓ: Megakadályozza az összeomlást sérült localStorage adatok esetén
        function safeJsonParse(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.warn(`Hiba a localStorage elem (${key}) beolvasásakor. Alapértelmezett érték használata.`, e);
                return defaultValue;
            }
        }

        function deepMerge(target, ...sources) {
            if (!sources.length) return target;
            const source = sources.shift();
            if (source && typeof source === 'object' && !Array.isArray(source)) {
                for (const key in source) {
                    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                        if (!target[key]) Object.assign(target, { [key]: {} });
                        deepMerge(target[key], source[key]);
                    } else {
                        Object.assign(target, { [key]: source[key] });
                    }
                }
            }
            return deepMerge(target, ...sources);
        }

        function showToast(message, type = 'success', duration = 5000) {
            const container = $('#toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const iconClass = type === 'success' ? 'fa-solid fa-check-circle' : (type === 'error' ? 'fa-solid fa-exclamation-triangle' : 'fa-solid fa-info-circle');
            toast.innerHTML = `<i class="${iconClass} icon"></i><span>${message}</span>`;
            container.appendChild(toast);
            if (duration > 0) {
                 setTimeout(() => toast.remove(), duration);
            }
            return toast;
        }

        function showConfirmationModal({ title, text, confirmText, confirmClass = 'btn-danger' }) {
            return new Promise((resolve) => {
                const modal = $('#confirmation-modal');
                const confirmBtn = $('#modal-confirm-btn');
                const cancelBtn = $('#modal-cancel-btn');
                const t = translations[currentLanguage];

                $('#modal-title').textContent = title;
                $('#modal-text').textContent = text;
                
                confirmBtn.textContent = confirmText;
                confirmBtn.className = 'btn ' + confirmClass;

                cancelBtn.textContent = t.cancelEditBtn;

                modal.classList.add('active');
                
                const confirmHandler = () => { cleanup(); resolve(true); };
                const cancelHandler = () => { cleanup(); resolve(false); };
                
                const cleanup = () => {
                    modal.classList.remove('active');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                };

                confirmBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', cancelHandler);
            });
        }

        function switchToTab(tabId) {
            $$('.tab-button').forEach(t => t.classList.remove('active-style'));
            $(`#${tabId}`).classList.add('active-style');
            $$('.tab-content').forEach(content => content.classList.remove('active'));
            $(`#${tabId.replace('-tab', '-content')}`).classList.add('active');
        }

        function applyTheme(theme) {
            const icon = $('#theme-icon');
            if (theme === 'dark') {
                document.body.classList.add('dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                document.body.classList.remove('dark');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        function toggleTheme() {
            const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme); // User override
            applyTheme(newTheme);
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme); // Apply user's saved preference
            } else {
                // Otherwise, follow system preference
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(systemPrefersDark ? 'dark' : 'light');
            }

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(event.matches ? 'dark' : 'light');
                }
            });
        }
        
        function updateLocalization() {
            const t = translations[currentLanguage];
            if (!t) return; 

            const textContentMap = { 
                'language-label': 'languageLabel', 'currency-label': 'currencyLabel', 
                'blinds-heading': 'blindsHeading', 
                'blinds-width-label': 'blindsWidthLabel', 'blinds-height-label': 'blindsHeightLabel', 'blinds-quantity-label': 'blindsQuantityLabel', 
                'blinds-type-label': 'blindsTypeLabel', 'blinds-color-label': 'blindsColorLabel', 'blinds-control-label': 'blindsControlLabel', 
                'blinds-divided-label': 'blindsDividedLabel', 'blinds-integrated-screen-label': 'blindsIntegratedScreenLabel', 
                'screens-heading': 'screensHeading', 'screens-width-label': 'screensWidthLabel', 
                'screens-height-label': 'screensHeightLabel', 'screens-quantity-label': 'screensQuantityLabel', 'screens-type-label': 'screensTypeLabel', 
                'screens-color-label': 'screensColorLabel', 'prices-heading': 'pricesHeading', 'quote-heading': 'quoteHeading', 
                'table-product-th': 'tableProductTh', 'table-size-th': 'tableSizeTh', 'table-quantity-th': 'tableQuantityTh', 'table-price-th': 'tablePriceTh', 
                'table-subtotal-th': 'tableSubtotalTh', 'table-actions-th': 'tableActionsTh', 'subtotal-text': 'subtotalText', 
                'discount-label': 'discountLabel', 'discount-amount-text': 'discountAmountText', 'total-text': 'totalText', 
                'quote-name-label': 'quoteNameLabel', 'preview-quote-btn': 'previewQuoteBtn', 'load-quote-heading': 'loadQuoteHeading', 
                'settings-heading': 'settingsHeading', 'company-name-label': 'companyNameLabel', 'company-logo-label': 'companyLogoLabel', 
                'save-settings-btn': 'saveSettingsBtn', 'logo-upload-text': 'logoUploadText', 'delete-logo-btn': 'deleteLogoBtn', 
                'data-management-heading': 'dataManagementHeading', 'data-management-desc': 'dataManagementDesc', 'export-data-btn': 'exportDataBtn', 
                'import-data-btn': 'importDataBtn', 'blinds-division-side-label': 'divisionSideLabel', 'blinds-division-width-label': 'divisionWidthLabel',
                'company-website-label': 'companyWebsiteLabel', 'company-email-label': 'companyEmailLabel', 'company-phone-label': 'companyPhoneLabel',
                'client-name-label': 'clientNameLabel', 'client-address-label': 'clientAddressLabel', 'client-phone-label': 'clientPhoneLabel',
                'table-area-th': 'tableAreaTh',
                'cancel-edit-blind-btn': 'cancelEditBtn', 'cancel-edit-screen-btn': 'cancelEditBtn',
                'screens-extender-frame-label': 'extenderFrameLabel',
                'blinds-extender-frame-label': 'blindsExtenderFrameLabel',
                'general-settings-sub-tab': 'generalSettingsSubTab', 'prices-settings-sub-tab': 'pricesSettingsSubTab',
                'blinds-exit-type-label': 'blindsExitTypeLabel',
                'blinds-side-label': 'blindsSideLabel',
                'quote-details-sub-tab': 'quoteDetailsSubTab', 'order-sub-tab': 'orderSubTab', 'order-heading': 'orderHeading',
                'order-description': 'orderDescription', 'generate-order-pdf-btn': 'generateOrderPdfBtn',
                'order-table-product-th': 'orderTableProductTh', 'order-table-size-th': 'orderTableSizeTh', 'order-table-details-th': 'orderTableDetailsTh',
                'order-table-color-th': 'orderTableColorTh', 'order-table-quantity-th': 'orderTableQuantityTh',
                'order-language-label': 'orderLanguageLabel'
            };
            for (const id in textContentMap) {
                const element = $(`#${id}`);
                if (element) element.textContent = t[textContentMap[id]];
            }
            
            $('#quote-search-input').placeholder = t.searchPlaceholder;

            const tabMap = { 'blinds-tab': 'blindsTab', 'screens-tab': 'screensTab', 'quote-tab': 'quoteTab', 'settings-tab': 'settingsTab' };
            for (const id in tabMap) $(`#${id} span`).textContent = t[tabMap[id]];

            const screenSelect = $('#blinds-integrated-screen');
            if(screenSelect) {
                screenSelect.querySelector('option[value="none"]').textContent = t.screenOptionNone;
                screenSelect.querySelector('option[value="full"]').textContent = t.screenOptionFull;
                screenSelect.querySelector('option[value="half"]').textContent = t.screenOptionHalf;
            }

            const exitTypeSelect = $('#blinds-exit-type');
            if(exitTypeSelect) {
                exitTypeSelect.querySelector('option[value="bottom"]').textContent = t.exitTypeBottom;
                exitTypeSelect.querySelector('option[value="top"]').textContent = t.exitTypeTop;
            }
            
            const sideSelect = $('#blinds-side');
            if (sideSelect) {
                sideSelect.querySelector('option[value="right"]').textContent = t.sideRight;
                sideSelect.querySelector('option[value="left"]').textContent = t.sideLeft;
            }

            const divisionSideSelect = $('#blinds-division-side');
            if (divisionSideSelect) {
                divisionSideSelect.querySelector('option[value="right"]').textContent = t.sideRight;
                divisionSideSelect.querySelector('option[value="left"]').textContent = t.sideLeft;
            }
            
            $('#order-language-select').value = currentLanguage;

            updateButtonStates();
            updateBlindsColors();
            updateScreensColors();
            updateCurrentPrices(); 
            renderPrices();
            renderQuote();
            renderOrderList();
        }
        
        function updateButtonStates() {
            const t = translations[currentLanguage];
            $('#save-quote-btn').textContent = t.saveQuoteBtn;
            $('#load-quotes-btn').textContent = t.loadQuotesBtn;
            $('#new-quote-btn').textContent = t.newQuoteBtn;

            $('#add-blind-btn').textContent = editingItemIndex !== null ? t.updateItemBtn : t.addBlindBtn;
            $('#add-screen-btn').textContent = editingItemIndex !== null ? t.updateItemBtn : t.addScreenBtn;
            
            const savePricesBtn = $('#save-prices-btn');
            if (savePricesBtn) {
                savePricesBtn.textContent = t.savePriceBtn;
            }
        }

        function updateBlindsColors() {
            const type = $('#blinds-type').value;
            const colorSelect = $('#blinds-color');
            const currentProductNames = translations[currentLanguage].productNames;
            let colorOptions = [];
            if (type === 'pvc') colorOptions = ["white"];
            else if (type === 'aluminium') colorOptions = ["white", "brown", "golden_oak", "walnut", "anthracite", "special"];
            else if (type === 'external-aluminium') colorOptions = ["white", "brown", "gray", "dark_brown", "light_brown", "golden_oak", "walnut", "mahogany", "special"];
            colorSelect.innerHTML = colorOptions.map(color => `<option value="${color}">${currentProductNames[color] || color}</option>`).join('');
        }
        
        function updateScreensColors() {
            const colorSelect = $('#screens-color');
            const currentProductNames = translations[currentLanguage].productNames;
            const colorOptions = ["white", "brown", "golden_oak", "walnut", "anthracite", "special"];
            colorSelect.innerHTML = colorOptions.map(color => `<option value="${color}">${currentProductNames[color] || color}</option>`).join('');
        }

        function updateBlindOptions() {
            $('#integrated-screen-group').style.display = ($('#blinds-type').value === 'pvc') ? 'none' : 'block';
        }

        function calculatePrice(productType, width, height, options) {
            const area = (width / 1000) * (height / 1000);
            let pricePerM2 = 0, extrasPrice = 0, billableArea = 0;
            const prices = currentPrices; // These are always in RON
            if (!prices) return { price: 0, billableArea: 0, minAreaApplied: false };

            let minAreaApplied = false;

            if (productType === 'blinds' || productType === 'external-aluminium') {
                const isExternal = productType === 'external-aluminium';
                const basePrice = isExternal ? (prices["external-aluminium"]?.base || 0) : (prices.blinds?.[options.type] || 0);
                pricePerM2 = basePrice;
                const colorSurcharges = isExternal ? prices.external_aluminium_colors : prices.blinds_percentages;
                
                if (options.color && colorSurcharges?.[options.color]) { 
                    pricePerM2 += basePrice * (colorSurcharges[options.color] / 100); 
                }

                if (options.integrated_screen === 'full') { 
                    pricePerM2 += prices.blinds?.integrated_screen || 0; 
                }
                
                billableArea = Math.max(area, minAreas.blinds);
                if(billableArea > area) minAreaApplied = true;

                let areaPrice = billableArea * pricePerM2;

                if (options.divided) { 
                    const dividedPrice = isExternal ? (prices["external-aluminium"]?.divided || 0) : (prices.blinds?.divided || 0); 
                    extrasPrice += dividedPrice; 
                }
                
                if (options.extenderFrame) {
                    const extenderLength = options.divided ? (height / 1000 * 4) : (height / 1000 * 2);
                    extrasPrice += extenderLength * (prices.blinds.extender_frame_price_pm || 0);
                }

                if (options.integrated_screen === 'half') { 
                    let halfScreenArea = ((width / 2) / 1000) * (height / 1000); 
                    const billableHalfArea = Math.max(halfScreenArea, minAreas.half_screen); 
                    extrasPrice += billableHalfArea * (prices.blinds?.integrated_screen || 0); 
                }

                if (options.control === 'motorized') { 
                    extrasPrice += prices.blinds?.motorized || 0; 
                } 
                else if (options.control === 'string' || options.control === 'strap') { 
                    const automataPrice = prices.blinds_extras?.automata || 0; 
                    extrasPrice += options.divided ? (2 * automataPrice) : (1 * automataPrice); 
                }
                
                const priceInRon = areaPrice + extrasPrice;
                const finalPrice = currentCurrency === 'EUR' ? priceInRon / exchangeRate : priceInRon;
                return { price: finalPrice, billableArea: billableArea, minAreaApplied };

            } else if (productType === 'screens') {
                const basePrice = prices.screens?.[options.type] || 0;
                pricePerM2 = basePrice;
                if (options.color && prices.screens_percentages?.[options.color]) { pricePerM2 += basePrice * (prices.screens_percentages[options.color] / 100); }
                
                let minAreaForScreen = minAreas.screens; // Default
                if (options.type === 'door' || options.type === 'thin-door') {
                    minAreaForScreen = minAreas.door_screen;
                } else if (options.type === 'plisse' || options.type === 'mobile') {
                    minAreaForScreen = minAreas[options.type];
                }

                billableArea = Math.max(area, minAreaForScreen);
                if(billableArea > area) minAreaApplied = true;

                let areaPrice = billableArea * pricePerM2;
                
                if ((options.type === 'door' || options.type === 'thin-door') && options.extenderFrame) {
                    const perimeter = (width / 1000 * 2) + (height / 1000 * 2);
                    extrasPrice += perimeter * (prices.screens.extender_frame_price_pm || 0);
                }

                const priceInRon = areaPrice + extrasPrice;
                const finalPrice = currentCurrency === 'EUR' ? priceInRon / exchangeRate : priceInRon;
                return { price: finalPrice, billableArea: billableArea, minAreaApplied };
            }
            return { price: 0, billableArea: 0, minAreaApplied: false };
        }

        function renderQuote() {
            const tbody = $('#quote-items-body'), t = translations[currentLanguage];
            tbody.innerHTML = '';
            let subtotal = 0;
            if (quoteItems.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-light-text-color">${t.noItemsInQuote}</td></tr>`;
            } else {
                quoteItems.forEach((item, index) => {
                    const priceData = calculatePrice(item.isScreen ? 'screens' : (item.type === 'external-aluminium' ? 'external-aluminium' : 'blinds'), item.width, item.height, item.options);
                    const unitPrice = priceData.price;
                    item.billableArea = priceData.billableArea;
                    const price = unitPrice * item.quantity;
                    item.unitPrice = unitPrice; // Update item with current price
                    item.price = price;         // Update item with current price
                    subtotal += price;
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-4 py-2">${item.product[currentLanguage]||item.product.hu}</td><td class="px-4 py-2">${item.width}x${item.height}</td><td class="px-4 py-2">${item.billableArea.toFixed(2)}</td><td class="px-4 py-2">${item.quantity}</td><td class="px-4 py-2">${unitPrice.toFixed(2)} ${currentCurrency}</td><td class="px-4 py-2"><b>${price.toFixed(2)} ${currentCurrency}</b></td><td class="px-4 py-2 text-right"><div class="flex gap-3 justify-end"><button class="btn btn-secondary btn-icon" title="${t.editBtn}" data-action="edit" data-index="${index}"><i class="fa-solid fa-pencil"></i></button><button class="btn btn-danger btn-icon" title="${t.deleteBtn}" data-action="remove" data-index="${index}"><i class="fa-solid fa-trash"></i></button></div></td>`;
                    tbody.appendChild(row);
                });
            }
            const discountPercentage = parseFloat($('#discount-percentage').value) || 0;
            const discountAmount = (subtotal * discountPercentage) / 100;
            const finalTotal = subtotal - discountAmount;
            const discountRow = $('#discount-row');
            if (discountAmount > 0) { $('#discount-amount').textContent = `-${discountAmount.toFixed(2)} ${currentCurrency}`; discountRow.classList.remove('hidden');
            } else { discountRow.classList.add('hidden'); }
            $('#subtotal-price').textContent = `${subtotal.toFixed(2)} ${currentCurrency}`;
            $('#total-price').textContent = `${finalTotal.toFixed(2)} ${currentCurrency}`;

            const renderFullSummary = (containerSelector) => {
                const container = $(containerSelector);
                const items = quoteItems;
                const title = t.quoteSummaryTitle;

                if (items.length === 0) { container.innerHTML = ''; return; }
                let summarySubtotal = 0;
                const itemsHtml = items.map(item => {
                    summarySubtotal += item.price;
                    return `<li class="flex justify-between items-center py-2 border-b border-[var(--table-row-border)]"><span class="text-sm">${item.product[currentLanguage] || item.product.hu} (${item.width}x${item.height}) x${item.quantity}</span><span class="font-semibold text-sm">${item.price.toFixed(2)} ${currentCurrency}</span></li>`;
                }).join('');

                container.innerHTML = `<h3 class="text-lg font-bold mb-3">${title}</h3><ul class="space-y-1">${itemsHtml}</ul><div class="flex justify-between items-center mt-4 pt-3 border-t border-[var(--input-border-color)]"><span class="font-bold">${t.summaryTotal}:</span><span class="font-bold text-lg">${summarySubtotal.toFixed(2)} ${currentCurrency}</span></div>`;
            };
            renderFullSummary('#blinds-summary-container');
            renderFullSummary('#screens-summary-container');
            renderOrderList();
        }
        
        function renderPrices() {
            const container = $('#prices-container'), t = translations[currentLanguage], pricesInRon = currentPrices || {};
            container.innerHTML = '';

            const exchangeRateContainer = document.createElement('div');
            exchangeRateContainer.className = "p-4 rounded-2xl shadow-md mb-6 saved-quote-item";
            exchangeRateContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">${t.exchangeRateTitle}</h3><div class="flex items-center space-x-4 mb-2"><label class="w-2/3">1 EUR =</label><div class="input-with-unit w-1/3"><input type="number" id="exchange-rate-input" class="input-field text-right" value="${exchangeRate.toFixed(2)}" min="0" step="0.01"><span class="unit">RON</span></div></div>`;
            container.appendChild(exchangeRateContainer);

            const structure = [
                { title: t.blindsPrices, sections: [{ subtitle: t.basePricesM2, items: [ { key: 'pvc', path: 'blinds.pvc' }, { key: 'aluminium', path: 'blinds.aluminium' }, { key: 'external-aluminium', path: 'external-aluminium.base' } ] }, { subtitle: t.surcharges, items: [ { key: 'motorized', path: 'blinds.motorized', unit: t.unit_currency_pc }, { key: 'divided_blind', path: 'blinds.divided' }, { key: 'divided_external', path: 'external-aluminium.divided' }, { key: 'automata', path: 'blinds_extras.automata', unit: t.unit_currency_pc }, { key: 'integrated_screen', path: 'blinds.integrated_screen' }, { key: 'blindsExtenderFramePrice', path: 'blinds.extender_frame_price_pm' } ]}, { subtitle: t.colorSurcharges, items: [ { key: 'golden_oak', path: 'blinds_percentages.golden_oak', unit: '%' }, { key: 'walnut', path: 'blinds_percentages.walnut', unit: '%' }, { key: 'anthracite', path: 'blinds_percentages.anthracite', unit: '%' }, { key: 'special', path: 'blinds_percentages.special', unit: '%' } ] }, { subtitle: t.externalColorSurcharges, items: [ { key: 'gray', path: 'external_aluminium_colors.gray', unit: '%' }, { key: 'dark_brown', path: 'external_aluminium_colors.dark_brown', unit: '%' }, { key: 'light_brown', path: 'external_aluminium_colors.light_brown', unit: '%' }, { key: 'golden_oak', path: 'external_aluminium_colors.golden_oak', unit: '%' }, { key: 'walnut', path: 'external_aluminium_colors.walnut', unit: '%' }, { key: 'mahogany', path: 'external_aluminium_colors.mahogany', unit: '%' }, { key: 'special', path: 'external_aluminium_colors.special', unit: '%' } ] } ] },
                { title: t.screensPrices, sections: [ { subtitle: t.screenBasePricesM2, items: [ { key: 'fix', path: 'screens.fix' }, { key: 'balcony', path: 'screens.balcony' }, { key: 'mobile', path: 'screens.mobile' }, { key: 'plisse', path: 'screens.plisse' }, { key: 'door', path: 'screens.door' }, { key: 'thin-door', path: 'screens.thin-door' } ] }, { subtitle: t.surcharges, items: [ { key: 'extenderFramePrice', path: 'screens.extender_frame_price_pm' } ] }, { subtitle: t.screenColorSurcharges, items: [ { key: 'golden_oak', path: 'screens_percentages.golden_oak', unit: '%' }, { key: 'walnut', path: 'screens_percentages.walnut', unit: '%' }, { key: 'anthracite', path: 'screens_percentages.anthracite', unit: '%' }, { key: 'special', path: 'screens_percentages.special', unit: '%' } ] } ] }
            ];
            
            structure.forEach(category => {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.innerHTML = `<h2 class="text-2xl font-bold mb-4">${category.title}</h2>`;
                category.sections.forEach(section => {
                    const sectionContainer = document.createElement('div');
                    sectionContainer.className = "p-4 rounded-2xl shadow-md mb-4 saved-quote-item";
                    sectionContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">${section.subtitle}</h3>`;
                    section.items.forEach(item => {
                        let priceValue = item.path.split('.').reduce((o, i) => o?.[i], pricesInRon) || 0;
                        const isPercentage = item.unit === '%';
                        if (currentCurrency === 'EUR' && !isPercentage) {
                            priceValue /= exchangeRate;
                        }

                        const priceItem = document.createElement('div');
                        priceItem.className = "flex items-center space-x-4 mb-2";
                        priceItem.innerHTML = `<label class="w-2/3">${t.productNames[item.key] || t[item.key]}:</label><div class="input-with-unit w-1/3"><input type="number" data-path="${item.path}" class="input-field text-right" value="${isPercentage ? priceValue : priceValue.toFixed(2)}" min="0" step="any"><span class="unit">${item.unit || currentCurrency}</span></div>`;
                        sectionContainer.appendChild(priceItem);
                    });
                    categoryWrapper.appendChild(sectionContainer);
                });
                container.appendChild(categoryWrapper);
            });

            // Minimum Area Settings
            const minAreaContainer = document.createElement('div');
            minAreaContainer.className = "mt-6";
            minAreaContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">${t.minAreaSettings}</h2>`;
            const minAreaSection = document.createElement('div');
            minAreaSection.className = "p-4 rounded-2xl shadow-md mb-4 saved-quote-item grid grid-cols-1 md:grid-cols-2 gap-4";
            
            Object.keys(defaultMinAreas).forEach(key => {
                const labelText = t.minAreaLabels[key] || key;
                const value = minAreas[key] !== undefined ? minAreas[key] : defaultMinAreas[key];
                const minAreaItem = document.createElement('div');
                minAreaItem.className = "flex items-center space-x-4";
                minAreaItem.innerHTML = `<label class="w-2/3">${labelText}:</label><div class="input-with-unit w-1/3"><input type="number" data-min-area-key="${key}" class="input-field text-right" value="${value.toFixed(2)}" min="0" step="any"><span class="unit">m²</span></div>`;
                minAreaSection.appendChild(minAreaItem);
            });
            minAreaContainer.appendChild(minAreaSection);
            container.appendChild(minAreaContainer);


            const saveButton = document.createElement('button');
            saveButton.id = "save-prices-btn";
            saveButton.className = "w-full mt-6 btn btn-secondary";
            container.appendChild(saveButton);
            updateButtonStates();
        }

        function loadSettings() {
            const settingsToLoad = {
                'company-name': 'companyName',
                'company-website': 'companyWebsite',
                'company-email': 'companyEmail',
                'company-phone': 'companyPhone'
            };
            for(const [id, key] of Object.entries(settingsToLoad)) {
                const value = localStorage.getItem(key);
                if (value) $(`#${id}`).value = value;
            }

            const companyLogo = localStorage.getItem('companyLogo'), deleteBtn = $('#delete-logo-btn');
            if (companyLogo) {
                $('#header-logo').src = companyLogo; $('#header-logo').classList.remove('hidden');
                $('#logo-preview').src = companyLogo; $('#logo-preview').classList.remove('hidden');
                $('#logo-upload-text').classList.add('hidden');
                deleteBtn.classList.remove('hidden');
            } else {
                $('#header-logo').src = ''; $('#header-logo').classList.add('hidden');
                $('#logo-preview').src = ''; $('#logo-preview').classList.add('hidden');
                $('#logo-upload-text').classList.remove('hidden');
                deleteBtn.classList.add('hidden');
            }
        }
        
        function renderSavedQuotesList(searchTerm = '') {
            const list = $('#saved-quotes-list'), t = translations[currentLanguage];
            list.innerHTML = '';
            
            const filteredQuotes = allSavedQuotes.filter(q => 
                q.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (q.clientName && q.clientName.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            if (filteredQuotes.length === 0) { list.innerHTML = `<li class="text-light-text-color p-3">${t.noQuotesFound}</li>`; return; }

            filteredQuotes.sort((a,b) => b.createdAt.localeCompare(a.createdAt)).forEach((quote, index) => {
                const listItem = document.createElement('li');
                listItem.className = "saved-quote-item flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-2xl shadow-sm";
                listItem.style.animationDelay = `${index * 50}ms`;
                
                const savedDate = new Date(quote.createdAt);
                const locale = currentLanguage === 'hu' ? 'hu-HU' : (currentLanguage === 'ro' ? 'ro-RO' : 'en-US');
                const formattedDate = savedDate.toLocaleString(locale, {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                }).replace(',', '');

                const clientInfo = quote.clientName ? `<span class="text-sm text-light-text-color">${quote.clientName}</span>` : '';
                const dateInfo = `<span class="text-xs text-light-text-color mt-1 block">${formattedDate}</span>`;

                listItem.innerHTML = `
                    <div class="flex-grow pr-4">
                        <p class="font-semibold">${quote.name}</p>
                        ${clientInfo}
                        ${dateInfo}
                    </div>
                    <div class="flex space-x-2 w-full sm:w-auto mt-2 sm:mt-0 flex-shrink-0">
                        <button class="btn btn-primary btn-small w-full sm:w-auto" data-action="load">${t.loadQuotesBtn}</button>
                        <button class="btn btn-danger btn-small w-full sm:w-auto" data-action="delete">${t.deleteBtn}</button>
                    </div>`;
                
                listItem.addEventListener('animationend', () => { listItem.classList.remove('animated'); });

                listItem.querySelector('[data-action="load"]').addEventListener('click', () => {
                    const loadedItems = JSON.parse(quote.items);
                    const fixedItems = loadedItems.map(item => { 
                        if (item.options === undefined) { 
                            console.warn('Old quote item format detected, upgrading.'); 
                            item.options = { type: item.type || (item.isScreen ? 'fix' : 'pvc'), color: 'white', control: 'string', divided: false, integrated_screen: 'none', divisionSide: null, divisionWidth: null }; 
                        }
                        if (item.options.extenderFrame === undefined) {
                            item.options.extenderFrame = false; // Add default value for old items
                        }
                        if (item.options.exitType === undefined) {
                            item.options.exitType = 'bottom'; // Add default for old items
                        }
                        return item; 
                    });
                    quoteItems = fixedItems;
                    $('#quote-name').value = quote.name || '';
                    delete $('#quote-name').dataset.autoGenerated; // Betöltött név, már nem auto
                    $('#client-name').value = quote.clientName || '';
                    $('#client-address').value = quote.clientAddress || '';
                    $('#client-phone').value = quote.clientPhone || '';
                    $('#discount-percentage').value = quote.discount || 0;
                    renderQuote();
                    $('#quote-tab').click();
                    $('#load-quote-section').classList.remove('visible');
                    showToast(t.quoteLoaded);
                });
                listItem.querySelector('[data-action="delete"]').addEventListener('click', async () => {
                    const confirmed = await showConfirmationModal({
                        title: t.deleteQuotePromptTitle,
                        text: t.deleteQuotePromptText.replace('{{name}}', quote.name),
                        confirmText: t.deleteBtn,
                        confirmClass: 'btn-danger'
                    });
                    if (confirmed) {
                        allSavedQuotes = allSavedQuotes.filter(q => q.id !== quote.id);
                        localStorage.setItem('savedQuotes', JSON.stringify(allSavedQuotes));
                        renderSavedQuotesList($('#quote-search-input').value);
                        showToast(t.quoteDeleted, 'success');
                    }
                });
                list.appendChild(listItem);
                // Trigger animation
                requestAnimationFrame(() => { listItem.classList.add('animated'); });
            });
        }

        function updateCurrentPrices() {
            currentPrices = deepMerge({}, defaultPrices, userPrices);
        }

        function exportData() {
            const dataToExport = {
                userPrices: JSON.parse(localStorage.getItem('userPrices') || '{}'),
                minAreas: JSON.parse(localStorage.getItem('minAreas') || '{}'),
                savedQuotes: JSON.parse(localStorage.getItem('savedQuotes') || '[]'),
                settings: {
                    companyName: localStorage.getItem('companyName') || '',
                    companyWebsite: localStorage.getItem('companyWebsite') || '',
                    companyEmail: localStorage.getItem('companyEmail') || '',
                    companyPhone: localStorage.getItem('companyPhone') || '',
                    companyLogo: localStorage.getItem('companyLogo') || '',
                    theme: localStorage.getItem('theme') || 'light',
                    exchangeRate: localStorage.getItem('exchangeRate') || 5
                }
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `arajanlat-keszito-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.userPrices) localStorage.setItem('userPrices', JSON.stringify(importedData.userPrices));
                    if (importedData.minAreas) localStorage.setItem('minAreas', JSON.stringify(importedData.minAreas));
                    if (importedData.savedQuotes) localStorage.setItem('savedQuotes', JSON.stringify(importedData.savedQuotes));
                    
                    const settings = importedData.settings || {}; // Handle old format without settings object
                    if(settings.companyName) localStorage.setItem('companyName', settings.companyName);
                    if(settings.companyWebsite) localStorage.setItem('companyWebsite', settings.companyWebsite);
                    if(settings.companyEmail) localStorage.setItem('companyEmail', settings.companyEmail);
                    if(settings.companyPhone) localStorage.setItem('companyPhone', settings.companyPhone);
                    if(settings.companyLogo) localStorage.setItem('companyLogo', settings.companyLogo);
                    if(settings.theme) localStorage.setItem('theme', settings.theme);
                    if(settings.exchangeRate) localStorage.setItem('exchangeRate', settings.exchangeRate);

                    showToast(translations[currentLanguage].importSuccess);
                    setTimeout(() => window.location.reload(), 2000);
                } catch (error) {
                    console.error('Import failed:', error);
                    showToast(translations[currentLanguage].importError, 'error');
                } finally { event.target.value = ''; }
            };
            reader.readAsText(file);
        }

        // --- PDF generation for Quote Preview (using pdfmake) ---
        function generateQuotePdf(lang) {
            const t = translations[lang];
            if (quoteItems.length === 0) { 
                alert(t.noItemsInQuote); 
                return; 
            }

            const quoteName = $('#quote-name').value.trim() || 'Névtelen';
            const clientName = $('#client-name').value.trim();
            const clientAddress = $('#client-address').value.trim();
            const clientPhone = $('#client-phone').value.trim();
            const companyName = localStorage.getItem('companyName') || 'EUROPLAST';
            const companyLogo = localStorage.getItem('companyLogo');
            const companyWebsite = localStorage.getItem('companyWebsite') || '';
            const companyEmail = localStorage.getItem('companyEmail') || '';
            const companyPhone = localStorage.getItem('companyPhone') || '';
            const subtotal = quoteItems.reduce((sum, item) => sum + item.price, 0);
            const discountPercentage = parseFloat($('#discount-percentage').value) || 0;
            const discountAmount = (subtotal * discountPercentage) / 100;
            const finalTotal = subtotal - discountAmount;

            const clientDetails = [];
            if (clientName) clientDetails.push({ text: `${t.clientNameLabel} ${clientName}` });
            if (clientAddress) clientDetails.push({ text: `${t.clientAddressLabel} ${clientAddress}` });
            if (clientPhone) clientDetails.push({ text: `${t.clientPhoneLabel} ${clientPhone}` });

            const companyDetails = [];
            if (companyName) companyDetails.push({ text: companyName, style: 'companyName', alignment: 'right' });
            if (companyWebsite) companyDetails.push({ text: companyWebsite, style: 'info', alignment: 'right' });
            if (companyEmail) companyDetails.push({ text: companyEmail, style: 'info', alignment: 'right' });
            if (companyPhone) companyDetails.push({ text: companyPhone, style: 'info', alignment: 'right' });

            const tableBody = quoteItems.map(item => {
                const names = t.productNames;
                const productDescription = `${item.product[lang] || item.product.hu}`;
                return [
                    { text: productDescription, style: 'tableCell' },
                    { text: `${item.width}x${item.height}`, style: 'tableCell' },
                    { text: item.billableArea.toFixed(2), style: 'tableCell' },
                    { text: item.quantity.toString(), style: 'tableCell' },
                    { text: `${item.unitPrice.toFixed(2)} ${currentCurrency}`, style: 'tableCell', alignment: 'right' },
                    { text: `${item.price.toFixed(2)} ${currentCurrency}`, style: 'tableCell', alignment: 'right' }
                ];
            });

            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [ 40, 40, 40, 40 ],
                info: {
                    title: `${t.quotePreviewTitle}: ${quoteName}`,
                    author: companyName
                },
                header: function() {
                    const headerContent = [
                        { text: `${t.quotePreviewTitle}: ${quoteName}`, style: 'title', margin: [40, 30, 0, 0] },
                        { text: new Date().toLocaleDateString(lang), style: 'info', alignment: 'right', margin: [0, 30, 40, 0] }
                    ];

                    return {
                        columns: headerContent
                    };
                },
                content: [
                    {
                        columns: [
                            { stack: clientDetails, width: '50%', margin: [0, 40, 0, 10] },
                            { stack: companyDetails, width: '50%', alignment: 'right', margin: [0, 40, 0, 10] }
                        ]
                    },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['*', 'auto', 'auto', 'auto', 'auto', 'auto'],
                            body: [
                                [
                                    { text: t.tableProductTh, style: 'tableHeader' },
                                    { text: t.tableSizeTh, style: 'tableHeader' },
                                    { text: t.tableAreaTh, style: 'tableHeader' },
                                    { text: t.tableQuantityTh, style: 'tableHeader' },
                                    { text: t.tablePriceTh, style: 'tableHeader' },
                                    { text: t.tableSubtotalTh, style: 'tableHeader' }
                                ],
                                ...tableBody
                            ]
                        },
                        layout: {
                            hLineWidth: function (i, node) { return (i === 0 || i === node.table.body.length) ? 2 : 1; },
                            vLineWidth: function (i, node) { return (i === 0 || i === node.table.widths.length) ? 2 : 1; },
                            hLineColor: function (i, node) { return (i === 0 || i === node.table.body.length) ? '#009688' : '#e5e7eb'; },
                            vLineColor: function (i, node) { return (i === 0 || i === node.table.widths.length) ? '#009688' : '#e5e7eb'; },
                            fillColor: function (rowIndex, node, columnIndex) { return (rowIndex % 2 === 0) ? '#f3f4f6' : null; }
                        },
                        margin: [0, 20, 0, 10]
                    },
                    {
                        alignment: 'right',
                        margin: [0, 10, 0, 0],
                        stack: [
                            {
                                columns: [
                                    { text: t.subtotalText, alignment: 'right' },
                                    { text: `${subtotal.toFixed(2)} ${currentCurrency}`, alignment: 'right', width: 'auto' }
                                ]
                            },
                            (discountPercentage > 0) ? {
                                columns: [
                                    { text: `${t.discountAmountText} (${discountPercentage}%)`, color: 'red', alignment: 'right' },
                                    { text: `-${discountAmount.toFixed(2)} ${currentCurrency}`, color: 'red', alignment: 'right', width: 'auto' }
                                ]
                            } : null,
                            {
                                columns: [
                                    { text: t.totalText, alignment: 'right', bold: true, fontSize: 12, margin: [0, 5, 0, 0] },
                                    { text: `${finalTotal.toFixed(2)} ${currentCurrency}`, alignment: 'right', bold: true, fontSize: 12, margin: [0, 5, 0, 0], width: 'auto' }
                                ]
                            }
                        ]
                    }
                ],
                styles: {
                    title: { fontSize: 18, bold: true, color: '#009688' },
                    companyName: { fontSize: 14, bold: true, color: '#009688' },
                    info: { fontSize: 10, alignment: 'right' },
                    date: { fontSize: 10, margin: [0, 5, 0, 0] },
                    tableHeader: { bold: true, fontSize: 10, fillColor: '#e5e7eb', alignment: 'center' },
                    tableCell: { fontSize: 9 }
                },
                defaultStyle: { fontSize: 10 }
            };
            
            pdfMake.createPdf(docDefinition).download(`${t.quotePreviewTitle}_${quoteName}.pdf`);
        }

        function openQuotePreviewWindow() {
            if (quoteItems.length === 0) { showToast(translations[currentLanguage].noItemsInQuote, 'error'); return; }
            
            const defaultPreviewLanguage = 'hu'; // Changed to Hungarian for consistency

            const previewData = { 
                quoteItems,
                translations,
                companyName: localStorage.getItem('companyName') || '',
                companyWebsite: localStorage.getItem('companyWebsite') || '',
                companyEmail: localStorage.getItem('companyEmail') || '',
                companyPhone: localStorage.getItem('companyPhone') || '',
                companyLogo: localStorage.getItem('companyLogo') || '',
                quoteName: $('#quote-name').value.trim() || 'Árajánlat',
                clientName: $('#client-name').value.trim(),
                clientAddress: $('#client-address').value.trim(),
                clientPhone: $('#client-phone').value.trim(),
                subtotal: quoteItems.reduce((sum, item) => sum + item.price, 0),
                discountPercentage: parseFloat($('#discount-percentage').value) || 0,
                discountAmount: (quoteItems.reduce((sum, item) => sum + item.price, 0) * (parseFloat($('#discount-percentage').value) || 0)) / 100,
                finalTotal: quoteItems.reduce((sum, item) => sum + item.price, 0) * (1 - (parseFloat($('#discount-percentage').value) || 0) / 100),
                currentCurrency,
                exchangeRate, 
                isDarkMode: document.body.classList.contains('dark')
            };

            const themeStyles = `
                <style>
                    :root {
                        --primary-color: #009688; --background-color: #F3F4F6; --text-color: #1F2937; --light-text-color: #6B7280; --surface-color: #FFFFFF; --table-header-bg: #E5E7EB; --table-row-border: #E5E7EB;
                    }
                    body.dark {
                        --background-color: #111827; --text-color: #F9FAFB; --light-text-color: #9CA3AF; --surface-color: #1F2937; --table-header-bg: #374151; --table-row-border: #4B5563;
                    }
                    body { background-color: var(--background-color) !important; color: var(--text-color); font-family: 'Inter', sans-serif; }
                    #quote-preview { background-color: var(--surface-color); color: var(--text-color); }
                    #quote-table thead { background-color: var(--table-header-bg); }
                    #quote-table tr { border-color: var(--table-row-border); }
                    @media print {
                        .print-hidden { display: none !important; }
                        body, #quote-preview { background-color: #FFFFFF !important; color: #000000 !important; }
                        thead { background-color: #E5E7EB !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        * { color: #000000 !important; }
                    }
                    @media (max-width: 767px) {
                        #quote-table thead { display: none; }
                        #quote-table tbody, #quote-table tr, #quote-table td { display: block; }
                        #quote-table tr { margin-bottom: 1rem; border: 1px solid var(--table-row-border); border-radius: 0.5rem; overflow: hidden; }
                        #quote-table td { text-align: right; padding: 0.5rem 1rem; border-bottom: 1px solid var(--table-row-border); position: relative; }
                        #quote-table td:before { content: attr(data-label); position: absolute; left: 1rem; font-weight: bold; text-align: left; }
                        #quote-table tr td:last-child { border-bottom: 0; }
                    }
                </style>
            `;

            const htmlTemplate = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title id="preview-title"></title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"><\/script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"><\/script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
                    ${themeStyles}
                </head>
                <body class="font-sans ${previewData.isDarkMode ? 'dark' : ''}">
                    <div class="preview-container mx-auto max-w-4xl my-10 p-4 md:p-0">
                        <div id="quote-preview-content" class="p-8 md:p-12 shadow-xl rounded-lg bg-[var(--surface-color)]">
                           <!-- Content will be rendered by script -->
                        </div>
                        <div class="print-hidden text-center my-8 flex flex-wrap justify-center items-center gap-4">
                            <button id="pdf-action-btn" class="bg-red-600 text-white font-bold py-3 px-6 rounded-full hover:bg-red-700 transition duration-300 shadow-lg flex items-center gap-2"></button>
                            <button id="jpg-action-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 transition duration-300 shadow-lg flex items-center gap-2"></button>
                            <button id="send-email-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-full hover:bg-green-700 transition duration-300 shadow-lg flex items-center gap-2"></button>
                            <button id="close-preview-btn" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-full hover:bg-gray-600 transition duration-300 shadow-lg flex items-center gap-2"></button>
                            <div class="flex items-center space-x-2">
                                <label id="preview-language-label" class="text-sm font-medium"></label>
                                <select id="preview-language-select" class="bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-1 px-2 text-sm">
                                    <option value="hu">Magyar</option>
                                    <option value="ro">Română</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <script>
                        const previewData = ${JSON.stringify(previewData)};

                        function generateQuotePdfFromPreview(lang) {
                            const t = previewData.translations[lang];
                            const quoteName = previewData.quoteName;
                            const companyName = previewData.companyName || 'EUROPLAST';
                            const companyLogo = previewData.companyLogo;

                            const clientDetails = [];
                            if (previewData.clientName) clientDetails.push({ text: \`\${t.clientNameLabel} \${previewData.clientName}\` });
                            if (previewData.clientAddress) clientDetails.push({ text: \`\${t.clientAddressLabel} \${previewData.clientAddress}\` });
                            if (previewData.clientPhone) clientDetails.push({ text: \`\${t.clientPhoneLabel} \${previewData.clientPhone}\` });

                            const companyDetails = [];
                            if (companyName) companyDetails.push({ text: companyName, style: 'companyName', alignment: 'right' });
                            if (previewData.companyWebsite) companyDetails.push({ text: previewData.companyWebsite, style: 'info', alignment: 'right' });
                            if (previewData.companyEmail) companyDetails.push({ text: previewData.companyEmail, style: 'info', alignment: 'right' });
                            if (previewData.companyPhone) companyDetails.push({ text: previewData.companyPhone, style: 'info', alignment: 'right' });

                            const tableBody = previewData.quoteItems.map(item => {
                                const productDescription = \`\${item.product[lang] || item.product.hu}\`;
                                return [
                                    { text: productDescription, style: 'tableCell' },
                                    { text: \`\${item.width}x\${item.height}\`, style: 'tableCell' },
                                    { text: item.billableArea.toFixed(2), style: 'tableCell' },
                                    { text: item.quantity.toString(), style: 'tableCell' },
                                    { text: \`\${item.unitPrice.toFixed(2)} \${previewData.currentCurrency}\`, style: 'tableCell', alignment: 'right' },
                                    { text: \`\${item.price.toFixed(2)} \${previewData.currentCurrency}\`, style: 'tableCell', alignment: 'right' }
                                ];
                            });

                            const docDefinition = {
                                pageSize: 'A4',
                                pageMargins: [ 40, 40, 40, 40 ],
                                info: {
                                    title: \`\${t.quotePreviewTitle}: \${quoteName}\`,
                                    author: companyName
                                },
                                header: function() {
                                    return {
                                        columns: [
                                            { stack: clientDetails, margin: [40, 30, 0, 0] },
                                            { stack: companyDetails, margin: [0, 30, 40, 0] }
                                        ]
                                    };
                                },
                                content: [
                                    { text: \`\${t.quotePreviewTitle}: \${quoteName}\`, style: 'title', margin: [0, 0, 0, 20] },
                                    { text: new Date().toLocaleDateString(lang), style: 'date', alignment: 'right', margin: [0, 0, 0, 10] },
                                    {
                                        table: {
                                            headerRows: 1,
                                            widths: ['*', 'auto', 'auto', 'auto', 'auto', 'auto'],
                                            body: [
                                                [
                                                    { text: t.tableProductTh, style: 'tableHeader' },
                                                    { text: t.tableSizeTh, style: 'tableHeader' },
                                                    { text: t.tableAreaTh, style: 'tableHeader' },
                                                    { text: t.tableQuantityTh, style: 'tableHeader' },
                                                    { text: t.tablePriceTh, style: 'tableHeader' },
                                                    { text: t.tableSubtotalTh, style: 'tableHeader' }
                                                ],
                                                ...tableBody
                                            ]
                                        },
                                        layout: {
                                            hLineWidth: function (i, node) { return (i === 0 || i === node.table.body.length) ? 2 : 1; },
                                            vLineWidth: function (i, node) { return (i === 0 || i === node.table.widths.length) ? 2 : 1; },
                                            hLineColor: function (i, node) { return (i === 0 || i === node.table.body.length) ? '#009688' : '#e5e7eb'; },
                                            vLineColor: function (i, node) { return (i === 0 || i === node.table.widths.length) ? '#009688' : '#e5e7eb'; },
                                            fillColor: function (rowIndex, node, columnIndex) { return (rowIndex % 2 === 0) ? '#f3f4f6' : null; }
                                        },
                                        margin: [0, 10, 0, 10]
                                    },
                                    {
                                        alignment: 'right',
                                        margin: [0, 10, 0, 0],
                                        stack: [
                                            {
                                                columns: [
                                                    { text: t.subtotalText, alignment: 'right' },
                                                    { text: \`\${previewData.subtotal.toFixed(2)} \${previewData.currentCurrency}\`, alignment: 'right', width: 'auto' }
                                                ]
                                            },
                                            (previewData.discountPercentage > 0) ? {
                                                columns: [
                                                    { text: \`\${t.discountAmountText} (\${previewData.discountPercentage}%)\`, color: 'red', alignment: 'right' },
                                                    { text: \`-\${previewData.discountAmount.toFixed(2)} \${previewData.currentCurrency}\`, color: 'red', alignment: 'right', width: 'auto' }
                                                ]
                                            } : null,
                                            {
                                                columns: [
                                                    { text: t.totalText, alignment: 'right', bold: true, fontSize: 12, margin: [0, 5, 0, 0] },
                                                    { text: \`\${previewData.finalTotal.toFixed(2)} \${previewData.currentCurrency}\`, alignment: 'right', bold: true, fontSize: 12, margin: [0, 5, 0, 0], width: 'auto' }
                                                ]
                                            }
                                        ]
                                    }
                                ],
                                styles: {
                                    title: { fontSize: 18, bold: true, color: '#009688' },
                                    companyName: { fontSize: 14, bold: true, color: '#009688' },
                                    info: { fontSize: 10, alignment: 'right' },
                                    date: { fontSize: 10, margin: [0, 5, 0, 0] },
                                    tableHeader: { bold: true, fontSize: 10, fillColor: '#e5e7eb', alignment: 'center' },
                                    tableCell: { fontSize: 9 }
                                },
                                defaultStyle: { fontSize: 10 }
                            };
                            
                            pdfMake.createPdf(docDefinition).download(\`\${t.quotePreviewTitle}_\${quoteName}.pdf\`);
                        }
                        
                        function renderPreview(lang) {
                            const t = previewData.translations[lang];
                            if (!t) return;
                            
                            document.documentElement.lang = lang;
                            document.getElementById('preview-title').textContent = \`\${t.quotePreviewTitle}: \${previewData.quoteName}\`;

                            const tableRowsHTML = previewData.quoteItems.map(item => \`
                                <tr class="border-b">
                                    <td data-label="\${t.tableProductTh}" class="py-3 px-4">
                                        <p class="font-semibold">\${item.product[lang] || item.product.hu}</p>
                                        <p class="text-xs text-light-text-color">\${item.width}x\${item.height} mm</p>
                                    </td>
                                    <td data-label="\${t.tableAreaTh}" class="py-3 px-4 text-center">\${item.billableArea.toFixed(2)}</td>
                                    <td data-label="\${t.tableQuantityTh}" class="py-3 px-4 text-center">\${item.quantity}</td>
                                    <td data-label="\${t.tablePriceTh}" class="py-3 px-4 text-right">\${item.unitPrice.toFixed(2)} \${previewData.currentCurrency}</td>
                                    <td data-label="\${t.tableSubtotalTh}" class="py-3 px-4 text-right font-bold">\${item.price.toFixed(2)} \${previewData.currentCurrency}</td>
                                </tr>\`).join('');

                            document.getElementById('quote-preview-content').innerHTML = \`
                                <header class="flex flex-col md:flex-row justify-between mb-12 gap-y-8">
                                    <div>
                                        \${previewData.companyLogo ? \`<img src="\${previewData.companyLogo}" alt="Cég logó" class="max-h-20 mb-4 object-contain">\` : ''}
                                        <h1 class="text-3xl font-bold">\${previewData.companyName || 'EUROPLAST'}</h1>
                                        <div class="text-sm text-light-text-color mt-2">
                                            \${previewData.companyWebsite ? \`<p>\${previewData.companyWebsite}</p>\` : ''}
                                            \${previewData.companyEmail ? \`<p>\${previewData.companyEmail}</p>\` : ''}
                                            \${previewData.companyPhone ? \`<p>\${previewData.companyPhone}</p>\` : ''}
                                        </div>
                                    </div>
                                    <div class="text-left md:text-right">
                                        <h2 class="text-2xl font-bold">\${t.quoteHeading}</h2>
                                        <p class="text-sm text-light-text-color">\${new Date().toLocaleDateString(lang)}</p>
                                        <div class="mt-4">
                                            <p class="font-bold">\${t.clientNameLabel}</p>
                                            <p class="text-sm">\${previewData.clientName||'-'}</p>
                                            <p class="text-sm">\${previewData.clientAddress||'-'}</p>
                                            <p class="text-sm">\${previewData.clientPhone||'-'}</p>
                                        </div>
                                    </div>
                                </header>
                                <main>
                                    <table id="quote-table" class="w-full mb-8 text-sm">
                                        <thead><tr class="border-b">
                                            <th class="py-3 px-4 font-semibold text-left">\${t.tableProductTh}</th>
                                            <th class="py-3 px-4 font-semibold text-center">\${t.tableAreaTh}</th>
                                            <th class="py-3 px-4 font-semibold text-center">\${t.tableQuantityTh}</th>
                                            <th class="py-3 px-4 font-semibold text-right">\${t.tablePriceTh}</th>
                                            <th class="py-3 px-4 font-semibold text-right">\${t.tableSubtotalTh}</th>
                                        </tr></thead>
                                        <tbody>\${tableRowsHTML}</tbody>
                                    </table>
                                </main>
                                <footer class="flex flex-col items-end">
                                   <div id="quote-summary" class="w-full md:w-2/5 text-sm">
                                        <div class="flex justify-between py-1"><p>\${t.subtotalText}</p><p>\${previewData.subtotal.toFixed(2)} \${previewData.currentCurrency}</p></div>
                                        \${previewData.discountPercentage > 0 ? \`<div class="flex justify-between py-1 text-red-500"><p>\${t.discountAmountText} (\${previewData.discountPercentage}%)</p><p>-\${previewData.discountAmount.toFixed(2)} \${previewData.currentCurrency}</p></div>\` : ''}
                                        <div class="flex justify-between font-bold text-lg mt-2 border-t pt-2"><p>\${t.totalText}</p><p>\${previewData.finalTotal.toFixed(2)} \${previewData.currentCurrency}</p></div>
                                   </div>
                                </footer>\`;
                            
                            updateButtonLabels(lang);
                        }

                        function updateButtonLabels(lang) {
                            const t = previewData.translations[lang];
                            const pdfBtn = document.getElementById('pdf-action-btn');
                            const jpgBtn = document.getElementById('jpg-action-btn');
                            const emailBtn = document.getElementById('send-email-btn');
                            const closeBtn = document.getElementById('close-preview-btn');

                            if (navigator.share) {
                                pdfBtn.innerHTML = \`<i class="fas fa-share-alt"></i> \${t.sharePdfBtn}\`;
                                jpgBtn.innerHTML = \`<i class="fas fa-share-alt"></i> \${t.shareJpgBtn}\`;
                            } else {
                                pdfBtn.innerHTML = \`<i class="fas fa-file-pdf"></i> \${t.generatePdfBtn}\`;
                                jpgBtn.innerHTML = \`<i class="fas fa-file-image"></i> \${t.generateJpgBtn}\`;
                            }
                            emailBtn.innerHTML = \`<i class="fas fa-paper-plane"></i> \${t.sendQuoteBtn}\`;
                            closeBtn.innerHTML = \`<i class="fas fa-times"></i> \${t.closeBtn}\`;
                            document.getElementById('preview-language-label').textContent = \`\${t.languageLabel}\`;
                        }
                        
                        async function generateJpgBlob() {
                            const quoteElement = document.getElementById('quote-preview-content');
                            const canvas = await html2canvas(quoteElement, { scale: 2, useCORS: true, backgroundColor: document.body.classList.contains('dark') ? '#1F2937' : '#FFFFFF' });
                            return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                        }

                        function sendEmail(lang) {
                            const t = previewData.translations[lang];
                            const subject = \`\${t.quotePreviewTitle}: \${previewData.quoteName}\`;
                            const body = t.sendQuoteEmailBody
                                .replace('{{quoteName}}', previewData.quoteName)
                                .replace('{{totalPrice}}', \`\${previewData.finalTotal.toFixed(2)} \${previewData.currentCurrency}\`)
                                .replace('{{companyName}}', previewData.companyName);
                            window.location.href = \`mailto:?subject=\${encodeURIComponent(subject)}&body=\${encodeURIComponent(body)}\`;
                        }
                        
                        window.onload = function() {
                            const langSelect = document.getElementById('preview-language-select');
                            const pdfBtn = document.getElementById('pdf-action-btn');
                            const jpgBtn = document.getElementById('jpg-action-btn');
                            const emailBtn = document.getElementById('send-email-btn');
                            const closeBtn = document.getElementById('close-preview-btn');

                            langSelect.value = '${defaultPreviewLanguage}';
                            renderPreview('${defaultPreviewLanguage}');
                            
                            langSelect.addEventListener('change', (e) => renderPreview(e.target.value));
                            emailBtn.addEventListener('click', () => sendEmail(langSelect.value));
                            closeBtn.addEventListener('click', () => window.close());

                            pdfBtn.addEventListener('click', async () => {
                                generateQuotePdfFromPreview(langSelect.value);
                            });

                            jpgBtn.addEventListener('click', async () => {
                                const lang = langSelect.value;
                                const t = previewData.translations[lang];
                                const jpgBlob = await generateJpgBlob();
                                if (!jpgBlob) return;
                                const file = new File([jpgBlob], \`\${previewData.quoteName}.jpg\`, { type: 'image/jpeg' });
                                
                                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                                    try {
                                        await navigator.share({ title: \`\${t.quotePreviewTitle}: \${previewData.quoteName}\`, files: [file] });
                                    } catch (err) { console.error("Share failed:", err.message); }
                                } else {
                                     const url = URL.createObjectURL(jpgBlob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = \`\${previewData.quoteName}.jpg\`;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                }
                            });
                        };
                    <\/script>
                </body></html>`;
            
            const previewWindow = window.open('', '_blank');
            if (previewWindow) { previewWindow.document.write(htmlTemplate); previewWindow.document.close(); } 
            else { showToast('A böngésző blokkolta az előnézeti ablakot.', 'error'); }
        }

        function startEditingItem(index) {
            const item = quoteItems[index];
            if (!item) return;

            editingItemIndex = index;

            if (item.isScreen) {
                $('#screens-width').value = item.width;
                $('#screens-height').value = item.height;
                $('#screens-quantity').value = item.quantity;
                $('#screens-type').value = item.options.type;
                updateScreensColors();
                $('#screens-color').value = item.options.color;
                
                const type = item.options.type;
                const frameGroup = $('#extender-frame-group');
                if (type === 'door' || type === 'thin-door') {
                    frameGroup.classList.remove('hidden');
                    $('#screens-extender-frame').checked = !!item.options.extenderFrame;
                } else {
                    frameGroup.classList.add('hidden');
                    $('#screens-extender-frame').checked = false;
                }

                switchToTab('screens-tab');
                $('#cancel-edit-screen-btn').classList.remove('hidden');
                document.getElementById('screens-heading').scrollIntoView({ behavior: 'smooth' });

            } else { // It's a blind
                $('#blinds-width').value = item.width;
                $('#blinds-height').value = item.height;
                $('#blinds-quantity').value = item.quantity;
                $('#blinds-type').value = item.options.type;
                updateBlindsColors();
                $('#blinds-color').value = item.options.color;
                $('#blinds-control').value = item.options.control;
                $('#blinds-divided').checked = item.options.divided;
                $('#blinds-extender-frame').checked = !!item.options.extenderFrame;
                $('#blinds-division-details').classList.toggle('visible', item.options.divided);
                if(item.options.divided) {
                    $('#blinds-division-side').value = item.options.divisionSide;
                    $('#blinds-division-width').value = item.options.divisionWidth;
                }
                $('#blinds-division-details').classList.toggle('visible', item.options.divided);
                $('#blinds-side-group').style.display = item.options.divided ? 'none' : 'block';
                 if (!item.options.divided) {
                    $('#blinds-side').value = item.options.side || 'right';
                }

                updateBlindOptions();
                updateControlOptionsVisibility(); // Show/hide exit type field
                $('#blinds-exit-type').value = item.options.exitType || 'bottom';
                $('#blinds-integrated-screen').value = item.options.integrated_screen;

                switchToTab('blinds-tab');
                $('#cancel-edit-blind-btn').classList.remove('hidden');
                document.getElementById('blinds-heading').scrollIntoView({ behavior: 'smooth' });
            }
            updateButtonStates();
        }

        function resetEditingState() {
            editingItemIndex = null;
            
            // Reset blinds form
            $('#blinds-width').value = ''; 
            $('#blinds-height').value = ''; 
            $('#blinds-quantity').value = 1; 
            $('#blinds-divided').checked = false;
            $('#blinds-extender-frame').checked = false;
            $('#blinds-division-details').classList.remove('visible');
            $('#blinds-division-width').value = '';
            $('#blinds-side-group').style.display = 'block';
            $('#cancel-edit-blind-btn').classList.add('hidden');

            // Reset screens form
            $('#screens-width').value = ''; 
            $('#screens-height').value = ''; 
            $('#screens-quantity').value = 1;
            $('#screens-extender-frame').checked = false;
            $('#extender-frame-group').classList.add('hidden');
            $('#cancel-edit-screen-btn').classList.add('hidden');

            updateButtonStates();
        }

        function clearQuote() {
            quoteItems = [];
            $('#quote-name').value = '';
            $('#quote-name').dataset.autoGenerated = 'true'; // Új, üres ajánlatnál beállítjuk
            $('#client-name').value = '';
            $('#client-address').value = '';
            $('#client-phone').value = '';
            $('#discount-percentage').value = 0;
            resetEditingState();
            renderQuote();
            showToast(translations[currentLanguage].newQuoteStarted, 'info');
        }

        function saveCurrentQuote(showNotification = true) {
            const quoteName = $('#quote-name').value.trim();

            if (quoteName === '' || quoteItems.length === 0) {
                if (showNotification && quoteName === '') {
                    showToast(translations[currentLanguage].quoteNameRequired, 'error');
                }
                return false;
            }

            const discount = parseFloat($('#discount-percentage').value) || 0;
            
            const newQuoteData = {
                name: quoteName,
                items: JSON.stringify(quoteItems.map(item => ({...item, unitPrice: undefined, price: undefined }))),
                discount,
                clientName: $('#client-name').value.trim(),
                clientAddress: $('#client-address').value.trim(),
                clientPhone: $('#client-phone').value.trim(),
                createdAt: new Date().toISOString() // This is the save date
            };

            const existingQuoteIndex = allSavedQuotes.findIndex(q => q.name.toLowerCase() === quoteName.toLowerCase());

            if (existingQuoteIndex > -1) {
                const existingId = allSavedQuotes[existingQuoteIndex].id;
                allSavedQuotes[existingQuoteIndex] = { ...newQuoteData, id: existingId };
            } else {
                allSavedQuotes.push({ ...newQuoteData, id: crypto.randomUUID() });
            }

            localStorage.setItem('savedQuotes', JSON.stringify(allSavedQuotes));
            if (showNotification) {
                showToast(translations[currentLanguage].quoteSaved);
            }
            return true;
        }

        function setupListeners() {
            function switchToSettingsSubTab(activeTab) {
                $$('#settings-sub-tabs .sub-tab-button').forEach(btn => btn.classList.remove('active-sub-style'));
                $$('#settings-content .sub-tab-content').forEach(content => content.classList.remove('active'));

                if (activeTab === 'general') {
                    $('#general-settings-sub-tab').classList.add('active-sub-style');
                    $('#general-settings-content').classList.add('active');
                } else if (activeTab === 'prices') {
                    $('#prices-settings-sub-tab').classList.add('active-sub-style');
                    $('#prices-settings-content').classList.add('active');
                }
            }

            function switchToQuoteSubTab(activeTab) {
                $$('#quote-sub-tabs .sub-tab-button').forEach(btn => btn.classList.remove('active-sub-style'));
                $$('#quote-content .sub-tab-content').forEach(content => content.classList.remove('active'));

                if (activeTab === 'details') {
                    $('#quote-details-sub-tab').classList.add('active-sub-style');
                    $('#quote-details-content').classList.add('active');
                } else if (activeTab === 'order') {
                    $('#order-sub-tab').classList.add('active-sub-style');
                    $('#order-content').classList.add('active');
                    renderOrderList(); 
                }
            }
            
            $('#refresh-btn').addEventListener('click', () => window.location.reload());
            
            $$('.tab-button').forEach(tab => tab.addEventListener('click', () => { 
                if (editingItemIndex !== null) {
                    resetEditingState();
                }
                switchToTab(tab.id);
                 if (tab.id === 'quote-tab') {
                    switchToQuoteSubTab('details');
                }
                if (tab.id === 'settings-tab') {
                    switchToSettingsSubTab('general');
                }
            }));

            $('#quote-details-sub-tab').addEventListener('click', () => switchToQuoteSubTab('details'));
            $('#order-sub-tab').addEventListener('click', () => switchToQuoteSubTab('order'));

            $('#general-settings-sub-tab').addEventListener('click', () => {
                switchToSettingsSubTab('general');
            });
    
            $('#prices-settings-sub-tab').addEventListener('click', async () => {
                if (sessionStorage.getItem('pricesUnlocked') === 'true') {
                    switchToSettingsSubTab('prices');
                } else {
                    const pinCorrect = await promptForPin();
                    if (pinCorrect) {
                        sessionStorage.setItem('pricesUnlocked', 'true');
                        switchToSettingsSubTab('prices');
                    }
                }
            });
            
            $('#language-select').addEventListener('change', (e) => { 
                currentLanguage = e.target.value; 
                localStorage.setItem('language', currentLanguage); 
                updateLocalization(); 
            });
            $('#currency-select').addEventListener('change', (e) => { currentCurrency = e.target.value; localStorage.setItem('currency', currentCurrency); renderPrices(); renderQuote(); });
            $('#theme-toggle').addEventListener('click', toggleTheme);
            $('#discount-percentage').addEventListener('input', renderQuote);
            $('#blinds-type').addEventListener('change', () => { 
                updateBlindsColors(); 
                updateBlindOptions();
                updateControlOptionsVisibility();
            });
            $('#blinds-control').addEventListener('change', updateControlOptionsVisibility);
            
            $('#blinds-divided').addEventListener('change', (e) => {
                const isDivided = e.target.checked;
                $('#blinds-division-details').classList.toggle('visible', isDivided);
                $('#blinds-side-group').style.display = isDivided ? 'none' : 'block';
            });

            $('#screens-type').addEventListener('change', (e) => {
                const type = e.target.value;
                const frameGroup = $('#extender-frame-group');
                if (type === 'door' || type === 'thin-door') {
                    frameGroup.classList.remove('hidden');
                } else {
                    frameGroup.classList.add('hidden');
                }
            });


            const handleBlindSubmit = () => {
                const type = $('#blinds-type').value, width = parseFloat($('#blinds-width').value), height = parseFloat($('#blinds-height').value), quantity = parseInt($('#blinds-quantity').value, 10), color = $('#blinds-color').value, control = $('#blinds-control').value, divided = $('#blinds-divided').checked, extenderFrame = $('#blinds-extender-frame').checked, integrated_screen = type === 'pvc' ? 'none' : $('#blinds-integrated-screen').value;
                const divisionSide = divided ? $('#blinds-division-side').value : null, divisionWidth = divided ? parseFloat($('#blinds-division-width').value) : null;
                const exitType = (control === 'string' || control === 'strap') && type === 'aluminium' ? $('#blinds-exit-type').value : null;
                const side = !divided ? $('#blinds-side').value : null;
                
                if (isNaN(width) || isNaN(height) || isNaN(quantity) || (divided && isNaN(divisionWidth))) { showToast(translations[currentLanguage].emptyFieldsError, 'error'); return; }
                if ((divided && divisionWidth <= 0) || width <= 0 || height <= 0) { showToast(translations[currentLanguage].invalidSizeError, 'error'); return; }
                if (divided && divisionWidth >= width) { showToast(translations[currentLanguage].invalidDivisionWidthError, 'error'); return; }
                if (quantity <= 0) { showToast(translations[currentLanguage].invalidQuantityError, 'error'); return; }
                if (type === 'pvc' && color !== 'white') { showToast(translations[currentLanguage].pvcColorError, 'error'); return; }
                
                const itemOptions = { type, color, control, divided, integrated_screen, divisionSide, divisionWidth, extenderFrame, exitType, side };
                const priceData = calculatePrice('blinds', width, height, itemOptions);
                if (priceData.minAreaApplied) { showToast(translations[currentLanguage].minAreaWarning.replace('{{area}}', minAreas.blinds), 'info'); }

                const productText = {};
                for (const lang in translations) { 
                    const names = translations[lang].productNames; let text = `${names[type]} (${names[color]})`; 
                    if (control === 'motorized') {
                        text += ` (${names.motorized})`;
                    } else if ((control === 'string' || control === 'strap') && type === 'aluminium') {
                        text += ` (${names[control]}, ${names[exitType === 'top' ? 'top_exit' : 'bottom_exit']})`;
                    } else if (control === 'string' || control === 'strap') {
                        text += ` (${names[control]})`;
                    }
                    if (divided) { 
                        const sideText = translations[lang][divisionSide === 'right' ? 'sideRight' : 'sideLeft']; text += ` (${names.divided_blind} ${sideText}: ${divisionWidth}mm)`; 
                    } else if (side) {
                        text += ` (${translations[lang][side === 'right' ? 'sideRight' : 'sideLeft']})`;
                    }
                    if (extenderFrame) text += ` (+${names.blinds_extender_frame})`;
                    if (integrated_screen === 'full') text += ` (+${names.integrated_screen_full})`; else if (integrated_screen === 'half') text += ` (+${names.integrated_screen_half})`; 
                    productText[lang] = text; 
                }
                const newItem = { isScreen: false, type, product: productText, width, height, quantity, options: itemOptions, billableArea: priceData.billableArea, unitPrice: priceData.price, price: priceData.price * quantity };
                
                if (editingItemIndex !== null) {
                    quoteItems[editingItemIndex] = newItem;
                    showToast(translations[currentLanguage].productUpdatedMessage);
                } else {
                    quoteItems.push(newItem);
                    showToast(translations[currentLanguage].productAddedMessage);
                }
                resetEditingState();
                renderQuote();
            };

            const handleScreenSubmit = () => {
                const type = $('#screens-type').value, width = parseFloat($('#screens-width').value), height = parseFloat($('#screens-height').value), quantity = parseInt($('#screens-quantity').value, 10), color = $('#screens-color').value;
                const extenderFrame = (type === 'door' || type === 'thin-door') && $('#screens-extender-frame').checked;

                if (isNaN(width) || isNaN(height) || isNaN(quantity)) { showToast(translations[currentLanguage].emptyFieldsError, 'error'); return; }
                if (width <= 0 || height <= 0) { showToast(translations[currentLanguage].invalidSizeError, 'error'); return; }
                if (quantity <= 0) { showToast(translations[currentLanguage].invalidQuantityError, 'error'); return; }
                
                const itemOptions = { type, color, extenderFrame };
                const priceData = calculatePrice('screens', width, height, itemOptions);
                
                let minAreaForScreen = minAreas.screens; // Default
                if (type === 'door' || type === 'thin-door') {
                    minAreaForScreen = minAreas.door_screen;
                } else if (type === 'plisse' || type === 'mobile') {
                    minAreaForScreen = minAreas[type];
                }

                if (priceData.minAreaApplied) { showToast(translations[currentLanguage].minAreaWarning.replace('{{area}}', minAreaForScreen), 'info'); }

                const productText = {};
                for (const lang in translations) { 
                    let text = `${translations[lang].productNames[type]} (${translations[lang].productNames[color]})`;
                    if (extenderFrame) {
                        text += ` (+${translations[lang].productNames.extender_frame})`;
                    }
                    productText[lang] = text;
                }
                const newItem = { isScreen: true, type, product: productText, width, height, quantity, options: itemOptions, billableArea: priceData.billableArea, unitPrice: priceData.price, price: priceData.price * quantity };
                
                if (editingItemIndex !== null) {
                    quoteItems[editingItemIndex] = newItem;
                    showToast(translations[currentLanguage].productUpdatedMessage);
                } else {
                    quoteItems.push(newItem);
                    showToast(translations[currentLanguage].productAddedMessage);
                }
                resetEditingState();
                renderQuote();
            };

            $('#add-blind-btn').addEventListener('click', handleBlindSubmit);
            $('#add-screen-btn').addEventListener('click', handleScreenSubmit);
            $('#cancel-edit-blind-btn').addEventListener('click', resetEditingState);
            $('#cancel-edit-screen-btn').addEventListener('click', resetEditingState);

            $('#new-quote-btn').addEventListener('click', async () => {
                const quoteName = $('#quote-name').value.trim();
                const t = translations[currentLanguage];

                // If there is work in progress (items exist)
                if (quoteItems.length > 0) {
                    // but it's unnamed, demand a name before proceeding.
                    if (quoteName === '') {
                        showToast(t.quoteNameRequired, 'error');
                        $('#quote-name').focus();
                        return; // Halt the "new quote" process.
                    }
                    // If it is named, save it silently.
                    saveCurrentQuote(false);
                }
                
                // Now, proceed with the confirmation for creating a new quote.
                // This part runs if there were no items, or if the existing work was successfully saved.
                const confirmed = await showConfirmationModal({
                    title: t.newQuotePromptTitle,
                    text: t.newQuotePromptText,
                    confirmText: t.newQuoteBtn,
                    confirmClass: 'btn-primary'
                });
                if (confirmed) {
                    clearQuote();
                }
            });

            $('#prices-container').addEventListener('input', (e) => { 
                if(e.target.id === 'exchange-rate-input') { 
                    const newRate = parseFloat(e.target.value); 
                    if (!isNaN(newRate) && newRate > 0) { 
                        exchangeRate = newRate; 
                        localStorage.setItem('exchangeRate', exchangeRate); 
                        renderPrices(); 
                        renderQuote(); 
                    } 
                } else if (e.target.dataset.minAreaKey) {
                    const key = e.target.dataset.minAreaKey;
                    const value = parseFloat(e.target.value);
                    if (!isNaN(value) && value >= 0) {
                        minAreas[key] = value;
                        renderQuote();
                    }
                }
            });
            $('#prices-container').addEventListener('change', (e) => {
                if (e.target.tagName !== 'INPUT' || !e.target.dataset.path) return;
                const path = e.target.dataset.path; let value = parseFloat(e.target.value); if (isNaN(value)) return;
                const isPercentage = e.target.nextElementSibling?.textContent === '%';
                if (currentCurrency === 'EUR' && !isPercentage) { value *= exchangeRate; }
                const setNestedValue = (obj, p, v) => { const keys = p.split('.'), lk = keys.pop(), lo = keys.reduce((o, k) => o[k] = o[k] || {}, obj); lo[lk] = v; };
                setNestedValue(userPrices, path, value); 
                updateCurrentPrices(); 
                renderQuote();
            });

            $('#prices-settings-content').addEventListener('click', e => { 
                if (e.target.id === 'save-prices-btn') { 
                    localStorage.setItem('userPrices', JSON.stringify(userPrices)); 
                    localStorage.setItem('minAreas', JSON.stringify(minAreas));
                    showToast(translations[currentLanguage].priceSavedMessage); 
                } 
            });
            
            $('#save-quote-btn').addEventListener('click', () => saveCurrentQuote(true));
            $('#generate-order-pdf-btn').addEventListener('click', () => {
                const selectedLang = $('#order-language-select').value;
                generateOrderPdf(selectedLang);
            });

            $('#load-quotes-btn').addEventListener('click', () => { const section = $('#load-quote-section'); section.classList.toggle('visible'); if (section.classList.contains('visible')) { renderSavedQuotesList(); } });
            $('#close-load-quote-btn').addEventListener('click', () => $('#load-quote-section').classList.remove('visible'));
            $('#quote-search-input').addEventListener('input', (e) => renderSavedQuotesList(e.target.value));
            $('#preview-quote-btn').addEventListener('click', openQuotePreviewWindow);

            $('#quote-items-body').addEventListener('click', (e) => { 
                const button = e.target.closest('button');
                if (!button) return;
                const { action, index } = button.dataset;
                if (action === 'remove') { quoteItems.splice(parseInt(index, 10), 1); renderQuote(); }
                if (action === 'edit') { startEditingItem(parseInt(index, 10)); }
            });

            $('#company-logo-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { localStorage.setItem('companyLogo', e.target.result); loadSettings(); }; reader.readAsDataURL(file); } });
            $('#save-settings-btn').addEventListener('click', () => { 
                const settingsToSave = ['companyName', 'companyWebsite', 'companyEmail', 'companyPhone'];
                const idMap = {'companyName': 'company-name', 'companyWebsite': 'company-website', 'companyEmail': 'company-email', 'companyPhone': 'company-phone'};
                settingsToSave.forEach(key => localStorage.setItem(key, $(`#${idMap[key]}`).value));
                loadSettings(); 
                showToast(translations[currentLanguage].settingsSavedMessage); 
            });

            $('#delete-logo-btn').addEventListener('click', () => { localStorage.removeItem('companyLogo'); loadSettings(); showToast(translations[currentLanguage].logoDeletedMessage); });
            $('#export-data-btn').addEventListener('click', exportData);
            $('#import-data-btn').addEventListener('click', () => $('#import-file-input').click());
            $('#import-file-input').addEventListener('change', importData);

            // Automatikus ajánlatnév generálása
            $('#client-name').addEventListener('input', () => {
                const clientName = $('#client-name').value.trim();
                const quoteNameInput = $('#quote-name');
                const isAutoGenerated = quoteNameInput.dataset.autoGenerated === 'true';

                if (clientName && (quoteNameInput.value.trim() === '' || isAutoGenerated)) {
                    const dateString = new Date().toISOString().slice(0, 10);
                    quoteNameInput.value = `${clientName} - ${dateString}`;
                    quoteNameInput.dataset.autoGenerated = 'true';
                }
            });

            $('#quote-name').addEventListener('input', () => {
                delete $('#quote-name').dataset.autoGenerated;
            });
        }
        
        function updateControlOptionsVisibility() {
            const controlType = $('#blinds-control').value;
            const blindType = $('#blinds-type').value;
            const exitGroup = $('#blinds-exit-type-group');
            const exitSelect = $('#blinds-exit-type');

            if ((controlType === 'string' || controlType === 'strap') && blindType === 'aluminium') {
                exitGroup.classList.remove('hidden');
                if (controlType === 'string') {
                    exitSelect.value = 'bottom';
                } else if (controlType === 'strap') {
                    exitSelect.value = 'top';
                }
            } else {
                exitGroup.classList.add('hidden');
            }
        }
        
        function renderOrderList() {
            const tbody = $('#order-items-body');
            const t = translations[currentLanguage];
            const blinds = quoteItems.filter(item => !item.isScreen);
            
            if (!tbody) return;

            if (blinds.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-light-text-color">${t.noBlindsInQuote}</td></tr>`;
                return;
            }

            tbody.innerHTML = blinds.map(item => {
                const names = t.productNames;
                const details = getBlindOrderDetailsString(item, currentLanguage, false, true); 
                const colorText = names[item.options.color] || item.options.color;
                const productDescription = `${names[item.options.type]}`;

                let sizeText = `${item.width} x ${item.height}`;
                if (item.options.divided) {
                    const sideText = t[item.options.divisionSide === 'right' ? 'sideRight' : 'sideLeft'];
                    sizeText += ` / ${item.options.divisionWidth}mm (${sideText})`;
                }

                return `<tr>
                    <td class="px-4 py-2">${productDescription}</td>
                    <td class="px-4 py-2">${sizeText}</td>
                    <td class="px-4 py-2">${details}</td>
                    <td class="px-4 py-2">${colorText}</td>
                    <td class="px-4 py-2">${item.quantity}</td>
                </tr>`;
            }).join('');
        }

        async function generateOrderPdf(lang) {
            const t = translations[lang];
            const blinds = quoteItems.filter(item => !item.isScreen);

            if (blinds.length === 0) {
                showToast(t.noBlindsInQuote, 'error');
                return;
            }

            const quoteName = $('#quote-name').value.trim() || 'Névtelen';
            const clientName = $('#client-name').value.trim();
            const clientAddress = $('#client-address').value.trim();
            const clientPhone = $('#client-phone').value.trim();
            const companyName = localStorage.getItem('companyName') || 'EUROPLAST';
            const companyLogo = localStorage.getItem('companyLogo');
            const companyWebsite = localStorage.getItem('companyWebsite') || '';
            const companyEmail = localStorage.getItem('companyEmail') || '';
            const companyPhone = localStorage.getItem('companyPhone') || '';
            
            const clientDetails = [];
            if (clientName) clientDetails.push({ text: `${t.clientNameLabel} ${clientName}` });
            if (clientAddress) clientDetails.push({ text: `${t.clientAddressLabel} ${clientAddress}` });
            if (clientPhone) clientDetails.push({ text: `${t.clientPhoneLabel} ${clientPhone}` });

            const companyDetails = [];
            if (companyLogo) {
                companyDetails.push({ image: companyLogo, width: 80, alignment: 'right', margin: [0, 0, 0, 5] });
            }
            companyDetails.push({ text: companyName, style: 'companyName', alignment: 'right' });
            if (companyWebsite) companyDetails.push({ text: companyWebsite, style: 'info', alignment: 'right' });
            if (companyEmail) companyDetails.push({ text: companyEmail, style: 'info', alignment: 'right' });
            if (companyPhone) companyDetails.push({ text: companyPhone, style: 'info', alignment: 'right' });
            companyDetails.push({ text: new Date().toLocaleDateString(lang), style: 'date', alignment: 'right' });

            const tableBody = blinds.map(item => {
                const names = t.productNames;
                const detailsText = getBlindOrderDetailsString(item, lang, true, true);
                const colorText = names[item.options.color] || item.options.color;
                const productDescription = `${names[item.options.type]}`;

                let sizeText = `${item.width} x ${item.height}`;
                if (item.options.divided) {
                    const sideText = t[item.options.divisionSide === 'right' ? 'sideRight' : 'sideLeft'];
                    sizeText += ` / ${item.options.divisionWidth}mm (${sideText})`; 
                }

                return [
                    { text: productDescription, style: 'tableCell' },
                    { text: sizeText, style: 'tableCell' },
                    { text: detailsText, style: 'tableCell' },
                    { text: colorText, style: 'tableCell' },
                    { text: item.quantity.toString(), style: 'tableCell' }
                ];
            });

            const docDefinition = {
                pageSize: 'A4',
                pageOrientation: 'landscape',
                pageMargins: [ 40, 40, 40, 40 ],
                info: {
                    title: `${t.orderPdfTitle} - ${quoteName}`,
                    author: companyName
                },
                header: function() {
                    return {
                        columns: [
                            { stack: clientDetails, width: '50%', margin: [40, 30, 0, 0] },
                            { stack: companyDetails, width: '50%', alignment: 'right', margin: [0, 30, 40, 0] }
                        ]
                    };
                },
                content: [
                    { text: `${t.orderPdfTitle} - ${quoteName}`, style: 'title', margin: [0, 0, 0, 20] },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['*', 'auto', 'auto', 'auto', 'auto'],
                            body: [
                                [
                                    { text: t.orderTableProductTh, style: 'tableHeader' },
                                    { text: t.orderTableSizeTh, style: 'tableHeader' },
                                    { text: t.orderTableDetailsTh, style: 'tableHeader' },
                                    { text: t.orderTableColorTh, style: 'tableHeader' },
                                    { text: t.orderTableQuantityTh, style: 'tableHeader' }
                                ],
                                ...tableBody
                            ]
                        },
                        layout: {
                            hLineWidth: function (i, node) { return (i === 0 || i === node.table.body.length) ? 2 : 1; },
                            vLineWidth: function (i, node) { return (i === 0 || i === node.table.widths.length) ? 2 : 1; },
                            hLineColor: function (i, node) { return (i === 0 || i === node.table.body.length) ? '#009688' : '#e5e7eb'; },
                            vLineColor: function (i, node) { return (i === 0 || i === node.table.widths.length) ? '#009688' : '#e5e7eb'; },
                            fillColor: function (rowIndex, node, columnIndex) { return (rowIndex % 2 === 0) ? '#f3f4f6' : null; }
                        }
                    }
                ],
                styles: {
                    title: { fontSize: 18, bold: true, color: '#009688', alignment: 'center' },
                    companyName: { fontSize: 14, bold: true, color: '#009688' },
                    info: { fontSize: 10, alignment: 'right' },
                    date: { fontSize: 10, margin: [0, 5, 0, 0] },
                    tableHeader: { bold: true, fontSize: 10, fillColor: '#e5e7eb', alignment: 'center' },
                    tableCell: { fontSize: 9 }
                },
                defaultStyle: { fontSize: 10 }
            };
            
            pdfMake.createPdf(docDefinition).download(`${t.orderPdfTitle}_${quoteName}.pdf`);
        }

        function getBlindOrderDetailsString(item, lang, forPdf = false, excludeDivision = false) {
            const t = translations[lang];
            const names = t.productNames;
            if (!item || !item.options) return '';
            
            const separator = forPdf ? '\n' : ', ';

            let details = [];
            
            details.push(names[item.options.control]);

            if (item.options.exitType) {
                details.push(names[item.options.exitType === 'top' ? 'top_exit' : 'bottom_exit']);
            }

            if (!item.options.divided && item.options.side) {
                details.push(t[item.options.side === 'right' ? 'sideRight' : 'sideLeft']);
            }

            if (item.options.divided && !excludeDivision) {
                const sideText = t[item.options.divisionSide === 'right' ? 'sideRight' : 'sideLeft'];
                details.push(`${names.divided_blind} (${sideText}: ${item.options.divisionWidth}mm)`);
            }
            
            if (item.options.extenderFrame) { details.push(`+${names.blinds_extender_frame}`); }
            if (item.options.integrated_screen === 'full') { details.push(`+${names.integrated_screen_full}`); }
            else if (item.options.integrated_screen === 'half') { details.push(`+${names.integrated_screen_half}`); }

            return details.join(separator);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                userPrices = safeJsonParse('userPrices', {});
                allSavedQuotes = safeJsonParse('savedQuotes', []);
                minAreas = deepMerge({}, defaultMinAreas, safeJsonParse('minAreas', {}));
                currentLanguage = localStorage.getItem('language') || 'hu';
                currentCurrency = localStorage.getItem('currency') || 'RON';
                exchangeRate = parseFloat(localStorage.getItem('exchangeRate')) || 5.0;
                
                $('#language-select').value = currentLanguage;
                $('#currency-select').value = currentCurrency;
                $('#quote-name').dataset.autoGenerated = 'true'; 
                document.title = "EUROPLAST Árajánlat Készítő";
                $('#app-title').textContent = "EUROPLAST";

                initializeTheme();
                updateCurrentPrices();
                loadSettings();
                updateLocalization();
                updateBlindOptions();
                updateControlOptionsVisibility();
                updateButtonStates();
                setupListeners();
            } catch (error) {
                console.error("Végzetes hiba az alkalmazás indításakor:", error);
                document.body.innerHTML = '<div style="padding: 2rem; text-align: center;">Hoppá! Egy hiba történt az alkalmazás betöltése közben. Próbálja meg törölni a böngészési adatokat, vagy vegye fel a kapcsolatot a fejlesztővel.</div>';
            }
        });
    </script>
</body>
</html>
